<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wuhunyu|blog</title>
  
  <subtitle>blog</subtitle>
  <link href="https://wuhunyu.top/atom.xml" rel="self"/>
  
  <link href="https://wuhunyu.top/"/>
  <updated>2026-01-06T12:06:00.000Z</updated>
  <id>https://wuhunyu.top/</id>
  
  <author>
    <name>wuhunyu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>自组折叠自行车 - 实践篇</title>
    <link href="https://wuhunyu.top/bike/2026/01/bike/index.html"/>
    <id>https://wuhunyu.top/bike/2026/01/bike/index.html</id>
    <published>2026-01-06T12:06:00.000Z</published>
    <updated>2026-01-06T12:06:00.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>从上一篇 <a href="https://wuhunyu.top/bike/2025/09/bike/index.html">自组折叠自行车</a> 中, 我已经掌握了很多折叠车的理论知识</p><p>古语说, “纸上得来终觉浅, 绝知此事要躬行”</p><p>现在它来了</p><span id="more"></span><p><img src="https://static.wuhunyu.top/images/2026/01/0200335d0aef89e0dc64796264af798c.jpg" alt="配件全家福"></p><h3 id="购买"><a href="#购买" class="headerlink" title="购买"></a>购买</h3><p>折叠车的配件都是基本都是单独购买的, 并没有局限于某一家店铺</p><p>不过由于配件巨多, 购买平台还是统一在淘宝, 部分配件在其它平台购买可能有些许优惠, 但为了方便, 选择了妥协</p><p>这里提几个配件的插曲</p><h4 id="内胎与轮组不匹配"><a href="#内胎与轮组不匹配" class="headerlink" title="内胎与轮组不匹配"></a>内胎与轮组不匹配</h4><p>首次购买的内胎气嘴是美嘴的, 但轮组的气嘴孔无法通过美嘴</p><img src="https://static.wuhunyu.top/images/2026/01/4d759093a4d56e12f49d214468776cd3.jpg" alt="气嘴" style="zoom:20%;" /><p>和卖家商量之后, 卖家倒是也很爽快给我更换了适配轮组的法嘴内胎</p><h4 id="脚撑不适配"><a href="#脚撑不适配" class="headerlink" title="脚撑不适配"></a>脚撑不适配</h4><p>很多公路车是不安装脚撑的, 尤其是碳纤维车架的公路车</p><p>在我购买的所有配件中, 脚撑是最先到达的快递, 但脚撑又属于是可安装又不需安装的配件</p><p>就这样脚撑不适配的问题一直等到无法退货才被发现</p><img src="https://static.wuhunyu.top/images/2026/01/c57472b60f0d488ec55a775f26814185.jpg" alt="脚撑不适配" style="zoom:40%;" /><p>万事俱备, 那就开干</p><h3 id="组装"><a href="#组装" class="headerlink" title="组装"></a>组装</h3><img src="https://static.wuhunyu.top/images/2026/01/6ba4a1fda0f9ad77c6269956e1b3250d.jpg" alt="开干" style="zoom: 70%;" /><p>组装折叠车的主要难点在于变速微调</p><p>其它的只要有时间和蛮力</p><img src="https://static.wuhunyu.top/images/2026/01/d4e2f0e2d3268a53cac7c26c88d4a530.jpg" alt="碗组" style="zoom:67%;" /><img src="https://static.wuhunyu.top/images/2026/01/38b8acb72d0e6efb99b3825efec98ac3.jpg" alt="车架" style="zoom:67%;" /><p>下图是我只靠自己组装的成果, 已经完成了九成的组装</p><p><img src="https://static.wuhunyu.top/images/2026/01/70bcece6591625413165d1439e08fdd4.jpg" alt="折叠车 - 九成进度"></p><p>后拨变速少购买了一把<strong>剪线钳</strong>, 无法完全安装调试</p><p>最后花了 100 大洋在车店完成了最后的组装</p><p><img src="https://static.wuhunyu.top/images/2026/01/558cba036834b2aec46825825b6df827.jpg" alt="折叠车 - 完全形态"></p><p><img src="https://static.wuhunyu.top/images/2026/01/e2b528e49de6116aab3a0f87e30e635b.jpg" alt="折叠车 - 折叠形态"></p><p>称重是 <strong>11.68kg</strong></p><img src="https://static.wuhunyu.top/images/2026/01/1d4e7c18e1d66a20f8370bfbe8ffd08d.jpg" alt="称重" style="zoom:67%;" /><h3 id="上路"><a href="#上路" class="headerlink" title="上路"></a>上路</h3><blockquote><p>是骡子是马, 拉出来溜溜</p></blockquote><p>我定义折叠车主要是在城市道路休闲骑的交通工具</p><h4 id="变速"><a href="#变速" class="headerlink" title="变速"></a>变速</h4><p>变速套件使用的是 <strong>禧玛诺 TIAGRA 4700</strong>, 变速很丝滑, 也基本够用</p><p>骑行时不需要刻意去关注档位, 凭感觉调整档位大多数时候都在中间的档位切换</p><h4 id="避震"><a href="#避震" class="headerlink" title="避震"></a>避震</h4><p>由于我没有上碳纤维, 避震几乎是没有的</p><p>长时间骑行后, 手腕会有酸痛</p><p>坐垫也是偏硬的(坐垫比共享单车的还硬), 骑久了会屁股痛</p><h4 id="坐管夹"><a href="#坐管夹" class="headerlink" title="坐管夹"></a>坐管夹</h4><p>车架自带的坐管夹有坐管滑落的毛病</p><p>需要将坐管夹的螺丝拧紧才能避免, 但拧紧的弊端是, 坐管夹快拆扣需要很大的力气才能锁定</p><blockquote><p>可能双层坐管夹可以解决这个问题, 但一个便宜的双层坐管夹也要一百多</p></blockquote><h4 id="线管"><a href="#线管" class="headerlink" title="线管"></a>线管</h4><p>大多数的折叠车线管会预留一部分长度, 这部分长度冗余给折叠使用</p><p>比如我的折叠车, 车头的线管呈现牛角的弧线</p><h4 id="挡泥板"><a href="#挡泥板" class="headerlink" title="挡泥板"></a>挡泥板</h4><p>挡泥板是很重要的配件</p><p>但这个配件在一些自行车(尤其是公路车)上是被歧视的</p><p>可以看到我的折叠车也是没有安装挡泥板的</p><p>这会导致路过水面时, 泥点子毫无阻拦地洒在骑车者的背上</p><img src="https://static.wuhunyu.top/images/2026/01/327c392295e207bb1ff3e071af5e8cc1.jpg" alt="泥点子虾线" style="zoom:50%;" /><h4 id="蹬车"><a href="#蹬车" class="headerlink" title="蹬车"></a>蹬车</h4><p>折叠车的刚性不太好, 蹬车的感觉很软</p><p>从车架的结构上来看, 折叠车也不适合蹬车</p><p>加速或者上坡可以通过变速来达到, 蹬车不是一个好习惯</p><h3 id="其它图片"><a href="#其它图片" class="headerlink" title="其它图片"></a>其它图片</h3>        <div class="waterfall-container" style="--wf-columns: 3;" data-columns="3">                        <div class="waterfall-item">                <img src="" data-src="https://static.wuhunyu.top/images/2026/01/dcc3c5861f216161b16dfa9562a928a6.jpg" alt="固戍码头" class="waterfall-lazy" onclick="event.stopPropagation(); event.preventDefault(); waterfallLightbox.open(this, 0)"/>            </div>                    <div class="waterfall-item">                <img src="" data-src="https://static.wuhunyu.top/images/2026/01/e05279b30649247261a72fd818aa1b31.jpg" alt="对比" class="waterfall-lazy" onclick="event.stopPropagation(); event.preventDefault(); waterfallLightbox.open(this, 1)"/>            </div>                    <div class="waterfall-item">                <img src="" data-src="https://static.wuhunyu.top/images/2026/01/8357c305351df08b3ab98841c3251279.jpg" alt="上地铁" class="waterfall-lazy" onclick="event.stopPropagation(); event.preventDefault(); waterfallLightbox.open(this, 2)"/>            </div>                </div>    <h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>整车组装下来, 零零散散也要个 4千</p><p>对于在家就在工作地的小伙伴, 不建议购入折叠车, 它虽然携带方便一些, 但性价比和安全性比不了山地车和公路车</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;从上一篇 &lt;a href=&quot;https://wuhunyu.top/bike/2025/09/bike/index.html&quot;&gt;自组折叠自行车&lt;/a&gt; 中, 我已经掌握了很多折叠车的理论知识&lt;/p&gt;
&lt;p&gt;古语说, “纸上得来终觉浅, 绝知此事要躬行”&lt;/p&gt;
&lt;p&gt;现在它来了&lt;/p&gt;</summary>
    
    
    
    <category term="折叠自行车" scheme="https://wuhunyu.top/categories/%E6%8A%98%E5%8F%A0%E8%87%AA%E8%A1%8C%E8%BD%A6/"/>
    
    
    <category term="自组" scheme="https://wuhunyu.top/tags/%E8%87%AA%E7%BB%84/"/>
    
    <category term="组装" scheme="https://wuhunyu.top/tags/%E7%BB%84%E8%A3%85/"/>
    
  </entry>
  
  <entry>
    <title>2026 年第一次相亲</title>
    <link href="https://wuhunyu.top/chat/2026/01/blind-date/index.html"/>
    <id>https://wuhunyu.top/chat/2026/01/blind-date/index.html</id>
    <published>2026-01-03T02:34:00.000Z</published>
    <updated>2026-01-07T07:38:46.861Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今天是元旦节假日的第二天, 外面寒风凛冽, 气温还不到 10℃</p><p>一天没出门了, 不过晚上有个约会, 这会儿我正在打理已经炸毛的头发</p><span id="more"></span><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>铃铃铃~, 是老妈打过来的微信电话</p><p>“现在可以出发了”, 电话那头有点急切的声音</p><p>今晚的约会是一个相亲饭局, 我了解到的相亲对象(下面统一叫“女方”)那边的信息不多</p><ol><li>比我小 2 岁</li><li>元旦父母没空, 元旦第二天要上班, 所以约的是元旦第二天的晚上</li><li>在老家上班</li></ol><p>从上面的消息中, 我猜测是在老家上的一个比较忙的工作, 元旦只有一天假期</p><p>老妈传递的信息缺失的很厉害, 不过也不是第一次了</p><p>父辈们安排的见面, 如果不太费时费钱的话, 就顺着他们的意思去做吧, 这样也能少些吵架</p><p>再加上, 我的年纪也不少了, 确实该考虑结婚的事情了</p><p>不过, 我是在外地上班, 元旦的第三天中午就要去赶火车, 女方假期这么少的话, 很难有后续, 本身也是异地恋</p><p>“走啊”, 老爸还在家里等我</p><p>“马上”, 我知道老妈交代老爸出门带一些现金, 肯定是要给女方那边红包的</p><h3 id="出门"><a href="#出门" class="headerlink" title="出门"></a>出门</h3><p>饭局的馆子是我家定好的, 离我家不太远, 一公里的样子</p><p>有一瞬间想过要不要骑车去, 万一饭局完了之后需要带女方出去玩呢, 不过这个想法马上就被迎面的冷风吹散了</p><p>“到了没有?”, 老妈在我们赶路的时候又打了一遍老爸的电话</p><p>刚好我们到了饭馆的门口, 一对中年夫妇在门口等着, 我暗猜这就是女方的家属</p><h3 id="等待"><a href="#等待" class="headerlink" title="等待"></a>等待</h3><p>定的饭局在二楼, 老爸和我上楼之后, 就把楼下站着的女方爸妈叫了上来</p><p>女方的爸妈都是很健谈的人</p><p>女方爸妈, 中介, 我爸妈聊天这会儿, 我把碗筷用热茶水冲洗了一遍, 然后挨个倒茶</p><p>等待女方本人来的时间, 基本都是这些老一辈的人在聊天, 我本身不算是一个话少的人, 但这个场合, 我还是安静一些比较合适, 过度地表现自我会让我怀疑这个正在表现自己的人还是自己吗</p><p>等待的时间很无聊, 把在场人的碗筷都洗了一遍之后, 看哪个长辈的被子快没茶了, 我就去满上</p><h3 id="吃饭"><a href="#吃饭" class="headerlink" title="吃饭"></a>吃饭</h3><p>女方也到齐了, 老妈通知厨房开始做菜</p><p>虽然一开始就有预期了, 但全部的人都到齐之后, 人还真不少, 我家 3 个人, 两个中介, 女方家里那边来了 5 个人, 如果算上女方姐姐的两个婴儿, 一共 12 个人</p><p>一张大圆桌, 坐满了人, 还是挺壮观的, 这个热闹程度在我家这种四口之家不多见</p><p>女方来了之后, 就在帮她姐姐给婴儿喂奶</p><p>我和她是这场饭局的主要人物</p><p>我喵了女方一眼, 挺高的, 比起我的偏瘦的脸型来说, 她的脸型会显得更大一些, 脸上还有几颗痘痘印, 还在我的审美范围内</p><p>我本身长相很一般的人, 自我评价中下吧, 再加上裸身高 164 cm, 对自己相亲能找到的对象有一个基本的认知</p><p>我给女方姐妹俩倒了两杯白开水, 年轻人应该都不喜欢喝茶水</p><p>吃饭期间, 我从父辈们的谈话之间了解更多的信息</p><ol><li>女方姐姐和我同岁</li><li>女方本人比我小 5 岁</li><li>女方在家里做会计</li><li>女方元旦有三天假</li></ol><p>和我之前了解的信息有出路</p><p>差 5 岁的话, 老实说, 我有点想要退缩了</p><p>虽然网友们经常说要找 18 岁的妹妹, 但我自我怀疑: 自己比人家大这么多, 人家为什么会接受和一个老帮菜做男朋友甚至结婚呢</p><ol><li>有钱</li><li>有颜</li><li>能提供情绪价值</li></ol><p>这三点我都没有, 所以我很清楚自己的定位</p><p>如果想要找一个一起度过后半生的对象, 小 5 岁有些不太现实了</p><p>她等得起, 我也没多少时光就步入 30 大关了</p><p>我个人的期望是 ±2, 不过经历过社会磨砺的人, 对另一半的期望都会更偏向于现实条件, 感性会少一些</p><p>我为什么会想要步入结婚大军, 扪心自问</p><ol><li>想要体验一下男女之事</li><li>看到别的情侣, 也会想如果不是一个人会不会过的更幸福</li><li>身边的同学朋友一个一个走进了婚姻</li><li>父母催婚</li></ol><p>父母的压力其实是最小的, 所以我并不反对老妈安排的相亲, 因为我的圈子里基本遇不到适龄的未婚女性</p><p>我反对的是父母把这次相亲办成了两家人见面. 这没必要, 还费钱, 成功率也不高</p><p>我正犹豫着找个机会约女方出去单独聊一聊</p><h3 id="聊"><a href="#聊" class="headerlink" title="聊"></a>聊</h3><p>中介站出来叫我约女方出去走一走</p><p>顺水推舟, 饭局上, 女方的爸爸出去了抽烟, 我向女方的妈妈说了声“那我带你女儿出去聊一会儿”, 就邀请女方出去玩了</p><p>我原本的计划是, 先自我介绍, 然后再问下是否有意向相处下去</p><p>女方回答的有点模糊, 但也表达了自己还早, 可能以后也不想结婚</p><p>我问, “你是第一次参加相亲吗?”</p><p>她答, “不算是第一次吧”</p><p>其实她说没想法的那一刻, 我也没啥好了解的了. 我不是一个死缠烂打的人, 如果对方没有一点想法的话, 即便我能通过契而不舍地追求得到这个婚姻, 但这样取得的婚姻到底会不会是幸福的呢</p><p>后面的聊天就有些尴尬了, 下来的时候长辈还起哄说要加微信, 然后第二天早上还能约一起见个面</p><p>我直接摊牌了, “既然你没有想法, 那我们就不用加微信了”</p><p>我觉得有时候决绝一点是对两边的负责</p><p>在外面转了一圈, 我们就准备回去了</p><p>进饭馆的门之前, 女方问我, “如果长辈们问起来没加微信怎么办?”</p><p>我也犹豫了, 我知道穿帮肯定是迟早的事</p><p>从口袋摸出来手机, 摆弄了一会儿终究还是没有说出来加微信</p><h3 id="返回饭局"><a href="#返回饭局" class="headerlink" title="返回饭局"></a>返回饭局</h3><p>上楼之后, 爸妈都不在. 此时我还没意识到他们去做什么了</p><p>我重新坐回座位, 女方的父亲和我聊起来他以前在深圳时候的一些事情</p><p>物是人非, 他说的很多地方名, 我是没听说过的, 不过和这些长辈聊一聊这些也挺好的, 如果话题又扯到了相亲上, 我也不一定能接得住</p><p>和女方的父亲聊了好一会儿, 我靠近女方, 和她说, “你爸爸还是很热情的, 加油抗争”, 不知道她听清楚了没</p><p>之后听见老妈的声音, 我就起身出去. 老妈直接塞了一个红包给我, 说是要给女方</p><p>边上除了老妈还有其他人在, 一时之间我没好意思说我们已经结束了</p><p>半推半就下, 我还是把红包给了女方</p><p>女方估计也是第一次见这种场面, 推脱了几次, 在身边人的起哄下接受了红包</p><p>这会儿没加到女方微信, 连悄悄话都没机会说了</p><p>女方的父母都没说什么, 也是很期望能成一家人吧</p><p>红包发完, 也差不多该结束了</p><p>女方的姐姐两个婴儿回去不方便, 饭局上有人提议我家开车送她们回去</p><p>于是我一个人回家拿钥匙去取车</p><h3 id="取车"><a href="#取车" class="headerlink" title="取车"></a>取车</h3><p>路上我在想, 不能一错再错了, 一会儿回去, 问一下女方的想法, 要不要当场说明我们没想法继续下去</p><h3 id="沉默"><a href="#沉默" class="headerlink" title="沉默"></a>沉默</h3><p>取车回来之后, 女方正在和她姐姐逗小孩玩</p><p>我靠近她, 说了声, “要不要现在说出来”</p><p>她回了我一句, 但我没听清楚是什么</p><p>沉默</p><p>我想起来让子弹飞有句台词, “哭, 哭也算时间哦”</p><p>此刻, “沉默也算是做出了决定”, 是对我的写照</p><p>很快, 我们就各回各家了</p><h3 id="责怪"><a href="#责怪" class="headerlink" title="责怪"></a>责怪</h3><p>老妈说我为什么不和女方招呼说拜拜</p><p>这会儿只有中介和老妈在, 我也瞒不住, 直接说已经凉了</p><p>老妈的表情瞬间变了</p><p>中介说, “你在微信上和人家再聊一聊, 男生要脸皮厚一点”</p><p>我说没加微信, 那会儿中介和老妈觉得天都塌了</p><p>我和她们解释再多都没用, 中介说她问女方父母要女方的电话, 然后我再加她的微信</p><p>中介说她自己, 21 岁时她老公见面的第二天就直接跑她家里去找她了</p><p>我很想说现在的恋爱和她们那时候不一样了, 但无法说服她们</p><h3 id="加微信"><a href="#加微信" class="headerlink" title="加微信"></a>加微信</h3><p>已经是晚上九点半了</p><p>我加了女方的微信, 说我这边失守了</p><p>再加微信, 我的感受也是很复杂</p><p>再次询问了是否还有机会, 我还有一上午在老家</p><p>女方回复说, “她想要睡懒觉”</p><p>我觉得如果对一个人有一点想法, 即便说了要睡懒觉, 也会表达可以几点之后约见面吧, 更何况我已经表明了自己隔天下午就要去赶火车</p><p>事已至此, 我直接问, “那我就理解为拒绝了哈”</p><p>成年人之间沟通真的没必要扭扭捏捏, 这是在相亲, 而不是在谈恋爱, 我作为男方需要确认对方也有意向才能迈出下一步</p><h3 id="老爸老妈"><a href="#老爸老妈" class="headerlink" title="老爸老妈"></a>老爸老妈</h3><p>老一辈的观念是, 人家女孩子不可能来追我, 需要我主动一些, 不要因为一点挫折就放弃, 我也不小了, 要抓住机会</p><p>我寻思着, 我并没有反对相亲, 也不是不想配合老爸老妈的安排</p><p>问题是在明确得知对方没有意向向后发展的前提下, 我还挂着一个异地恋的 debuff, 真没必要硬追</p><p>如果当时, 女方说有想法向后发展, 或者她说可以试试, 我都不可能不加人家微信</p><p>我希望我的婚姻不是单纯地因为物质条件而走到了一起</p><h3 id="第二天"><a href="#第二天" class="headerlink" title="第二天"></a>第二天</h3><p>我向老爸老妈表明了微信上的聊天结果, 他们还是希望能继续推进</p><p>老实说, 我已经不再去想打扰对方了</p><p>算上微信上的答复, 我算不算已经被拒绝了两次</p><p>强扭的瓜不甜, 虽然两方的家长都很积极想要推进关系, 我家里也没什么财产好继承, 不想给自己加以后离婚的风险</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天是元旦节假日的第二天, 外面寒风凛冽, 气温还不到 10℃&lt;/p&gt;
&lt;p&gt;一天没出门了, 不过晚上有个约会, 这会儿我正在打理已经炸毛的头发&lt;/p&gt;</summary>
    
    
    
    <category term="相亲" scheme="https://wuhunyu.top/categories/%E7%9B%B8%E4%BA%B2/"/>
    
    
    <category term="相亲" scheme="https://wuhunyu.top/tags/%E7%9B%B8%E4%BA%B2/"/>
    
  </entry>
  
  <entry>
    <title>记第一次半程马拉松</title>
    <link href="https://wuhunyu.top/marathon/2025/12/29/huizhou/index.html"/>
    <id>https://wuhunyu.top/marathon/2025/12/29/huizhou/index.html</id>
    <published>2025-12-29T10:13:00.000Z</published>
    <updated>2026-01-07T07:38:46.862Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>这篇博客比较偏向于随想的碎碎念, 没有主题</p></blockquote><h3 id="比赛基本信息"><a href="#比赛基本信息" class="headerlink" title="比赛基本信息"></a>比赛基本信息</h3><p>我参加的第一次半程马拉松是 2025 年的惠州马拉松, 具体的比赛日期是 <code>2025年12月28日</code>, 具体的开赛时间是 <code>07:30</code></p><span id="more"></span><h3 id="赛衣"><a href="#赛衣" class="headerlink" title="赛衣"></a>赛衣</h3><p>我是第一次参加马拉松比赛, 理所当然地被分配到了最后的一个分区. 在惠州马拉松中, 我是在 <strong>D 区</strong></p><img src="https://static.wuhunyu.top/images/2025/12/a48fbbac493bb7f7f9394326af29d496.jpg" alt="惠马号码牌" style="zoom: 20%;" /><p>特意选择一个 <strong>1024</strong> 的号码, 只不过是倒过来的 1024</p><h3 id="完赛证书"><a href="#完赛证书" class="headerlink" title="完赛证书"></a>完赛证书</h3><img src="https://static.wuhunyu.top/images/2025/12/c777a7b610bf5f30e0f07aaafbaad24b.jpg" alt="惠州马拉松成绩" style="zoom:25%;" /><h3 id="赛前"><a href="#赛前" class="headerlink" title="赛前"></a>赛前</h3><h4 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h4><p>打算 <code>05:30</code> 起, 洗漱后去附近的公交车接驳车到比赛现场</p><p>我距离最近的公交接驳点挺近的, 前一天晚上我走了一遍, 从出门到目标地点大约 10 分钟的路程</p><img src="https://static.wuhunyu.top/images/2025/12/710368d96176a62f9e5a83ee12f5bddc.jpg" alt="公交接驳车告示牌" style="zoom:20%;" /><p>洗漱完毕</p><h4 id="赛前物资准备"><a href="#赛前物资准备" class="headerlink" title="赛前物资准备"></a>赛前物资准备</h4><ol><li>能量胶 x 3</li><li>盐丸 x 1</li><li>氨糖涂抹膏(惠马送的) x 1. 这个我是在开赛的半个小时前使用的, 不想打广告, 但真有点用</li><li>少量饮水</li><li>纸巾 x 4. 纸巾是因为我跑步时不时会流鼻涕(可能和气温, 湿度有关系, 但我本身也有鼻炎, 带上几张以防万一)</li><li>一次性雨衣</li></ol><h5 id="提前使用"><a href="#提前使用" class="headerlink" title="提前使用"></a>提前使用</h5><ol><li>能量胶 x 1</li><li>盐丸 x 1</li><li>氨糖涂抹膏 x 1</li><li>提前少量饮水. 这是我个人的经验, 喝水过多导致尿意, 或者提前岔气. 我个人的做法是, 赛中非必要不喝水, 不科学但我这次比赛我很想跑个好成绩, 尽量避免取水喝水这个动作</li><li>一次性雨衣</li></ol><h5 id="具体"><a href="#具体" class="headerlink" title="具体"></a>具体</h5><p>也可以通过食用香蕉来代替能量胶, 本来我也想买点香蕉的, 但前一天晚上玩嗨了, 忘记这回事了</p><p>盐丸是用来补充电解质的, 需要陪和白水一起食用, 切勿混合运动饮料一起食用</p><p>雨衣可以在寄存行李的时候穿上, 可以减少失温, 在赛场上, 我可以看到了使用锡箔纸做”雨衣”的, 锡箔纸的保温效果更佳, 但成本没那么好看, 在一个就是外形不如五颜六色的雨衣</p><h4 id="提前上厕所"><a href="#提前上厕所" class="headerlink" title="提前上厕所"></a>提前上厕所</h4><p><strong>重要事件</strong></p><p>不要等到了比赛场地才想着上厕所, 无论是大便还是小便</p><p>从我观察的现象来看, 男厕的小便池姑且都是爆满状态, 不敢想像女厕那边是什么状态</p><p>提前在酒店如厕完毕, 之后尽量只少量饮水</p><h4 id="存包"><a href="#存包" class="headerlink" title="存包"></a>存包</h4><p>一般马拉松比赛的参赛人数都是比较多的, 所以现场虽然有很多引导牌和工作人员, 但还是挺难找对地方</p><p>起初, 我以为是随便找个地方放就行, 但看到存包的地方还有号码牌的时候, 我就知道我放错地方了</p><p>惠州马拉松 2025 年这届比赛参赛人数据官方介绍有 <code>13,000</code>  名运动员, 这里面包含了全马和半马运动员</p><p>第一次参赛, 真给我整懵逼了, 我所在的 <strong>D 区</strong> 离公交接驳车下车的位置很远, 一度让我产生了是不是错过存包位置的想法</p><p>存包之后, 工作人员会在你的号码牌上用水笔做标记</p><p>之后, 就是可以入场准备了</p><h4 id="入场"><a href="#入场" class="headerlink" title="入场"></a>入场</h4><p>入场会检查是否正确佩戴纸质手环</p><blockquote><p>纸质手环有什么作用我也不清楚, 但领取参赛包的时候被交代一定要在比赛时戴上它</p></blockquote><p>我所在的 <strong>D 区</strong> 前排, 每个区域内, 可以自由选择靠前还是靠后, 靠前可以提前开始比赛, 靠后枪响成绩会更差一些, 本质没什么区别, 开跑之后不久人与人之间的间隙还是有的, 不太会出现特别影响速度的情况. 你要是跑得快, 还想要争取一个好成绩, 也可以尽量往前靠</p><h4 id="准赛前准备"><a href="#准赛前准备" class="headerlink" title="准赛前准备"></a>准赛前准备</h4><p>我大概是在 <code>07:10</code> 左右入场的, 尽量往 <strong>D 区</strong> 的前排靠</p><p>比赛开始前, 可以听到主持人在不停地预热气氛, 但位于 <strong>D 区</strong> 其实什么都看不见, 只能听见声音. 还有偶尔飞过来的无人机</p><h3 id="赛中"><a href="#赛中" class="headerlink" title="赛中"></a>赛中</h3><p>等到 <code>07:30</code>, 比赛真是开始, 但由于我在 <strong>D 区</strong>, 前排的人群没有什么动静, 估计不同的区域也是按批次放行通过比赛拱门</p><h4 id="赛场垃圾"><a href="#赛场垃圾" class="headerlink" title="赛场垃圾"></a>赛场垃圾</h4><p>这个问题我在参加比赛之前就刷到过相关的视频, 评论区偶尔能看到有几个道德感比较高的网友批评这种垃圾乱丢的行为</p><p>我从我个人的角度上来讲讲我看到的样子</p><p>垃圾比较多的位置出现在<strong>比赛开始的位置</strong>和<strong>每个补给点</strong>, 反而在终点, 我没有看到什么垃圾</p><h5 id="比赛开始的位置"><a href="#比赛开始的位置" class="headerlink" title="比赛开始的位置"></a>比赛开始的位置</h5><p>开始位置的垃圾主要是<strong>能量胶, 盐丸的包装袋</strong>, 以及<strong>一次性雨衣</strong></p><p>其中, 我认为比较影响其它参赛选手的垃圾是 <strong>一次性雨衣</strong>, 一次性雨衣很容易散开, 踩到容易绊住脚</p><p>比赛正式开始前, 我看到有部分参赛选手会将雨衣揉成一团之后, 丢到赛场的两侧</p><blockquote><p>赛场的两侧是没有参赛人员的, 属于非赛事规划路段, 如果没有被风吹到赛场, 是不会影响其他参赛选手的</p></blockquote><p>至于赛场的垃圾不应该乱丢这个问题, 我没有读各个马拉松比赛的推荐规范中, 有没有推荐参赛运动员如何处理这些垃圾, 但在一个万人级别的比赛项目中, 想要引导全部的参赛选手应该在哪里丢垃圾是一件很困难的事情, 更何况比赛的路线是固定的, 干垃圾收集起来相对还是更加省力的</p><p>对于想要在比赛中赢得好成绩的选手来说, 能争取一秒也是宝贵的</p><p>我个人的看法是, 允许在不影响其他参赛选手的情况丢垃圾, 但一般应该丢在比较明显的位置, 降低后勤人员清理的难度</p><blockquote><p>明显的位置, 可以是比赛开始前的场地两侧, 这里会有大量的参赛选手丢弃雨衣, 能量胶等垃圾, 垃圾比较集中的话, 清理起来也会省力不少</p></blockquote><h5 id="补给点"><a href="#补给点" class="headerlink" title="补给点"></a>补给点</h5><p>补给点分两种, 一种是官方提供的补给点, 另一种是私补(观众在赛道旁提供的补给)</p><p>这次惠州马拉松提供的补给有什么我没太关注</p><blockquote><p>赛前怕喝水容易侧腹痛, 给自己的目标是非必要不喝水, 即便喝水也只能抿一口</p><p>这种做法不可取, 但每个人有自己的策略, 喝水属于赛场中人群比较集中的地方, 这意味着为了喝水冲进这个区域, 你需要降低配速</p><p>降低配速可能也争取不了多少秒, 但不同的人对成绩有不同的执念</p></blockquote><p>但每个有补给的地方, 必然会出现很多乱丢的纸杯, 湿水海绵, 能量胶包装袋, 以及没有喝完的水</p><p>补给点附近有专门的垃圾回收区, 但纸杯乱丢的现象还是挺严重的</p><blockquote><p>关于纸杯乱丢的问题, 我持中立态度</p><p>就像是很多国家在发展过程中, 都伴随着破坏环境, 发展过程中还要保护环境对很多企业来说意味着高成本</p><p>这并不是意味着我提倡不爱护环境, 而是在其中取舍, 如果像德国弃核一样一味环保, 就变成了废寝忘食, 那马拉松还是为了追求人类极限的目的而存在吗</p></blockquote><h5 id="另外说说我担心的地方"><a href="#另外说说我担心的地方" class="headerlink" title="另外说说我担心的地方"></a>另外说说我担心的地方</h5><p>没喝完的水倒在地上</p><p>普通的矿泉水 &#x2F; 纯净水没什么, 但部分运动饮料中包含部分糖浆, 这部分饮料晒地上可能会有一点影响</p><h4 id="拉拉队"><a href="#拉拉队" class="headerlink" title="拉拉队"></a>拉拉队</h4><p>这届惠州马拉松虽然也是A类赛事, 但知名度很一般, 拉拉队除了围观的群众, 多数还是上了年纪的阿姨</p><blockquote><p>说阿姨不知道会不会很没有礼貌, 但确实没有看到很年轻的</p></blockquote><p>哦, 对了. 除了阿姨们, 也还有小孩子合唱团</p><p>路人也是很热情的, 我还听见了小孩子喊加油, “哥哥加油, 姐姐加油”</p><h4 id="赛道"><a href="#赛道" class="headerlink" title="赛道"></a>赛道</h4><img src="https://static.wuhunyu.top/images/2025/12/8a6633036768c018309f44a77a6b39bb.jpg" alt="比赛开始" style="zoom:20%;" /><p>惠马的赛道前半段基本是下坡, 很少上坡路段, 我以为全程都是这种赛道, 心里还想着是不是能破二</p><p>是的, 后半段教我做人了. 后半段很多段路程是间歇性地上坡和下坡, 真是搞死人</p><p>赛道路过了惠州西湖, 此外一些路边的商家也有自发为比赛喊加油的</p><p>还有一个 cos 八戒的</p><blockquote><p>我没认出来是八戒, 听其他参赛选手喊的</p></blockquote><p>赛道觉大部分路段都是平整的路线, 部分路过商业街的路段有些小的坑洼, 需要注意⚠️</p><h4 id="配速安排"><a href="#配速安排" class="headerlink" title="配速安排"></a>配速安排</h4><p>原本, 我想要在最初的 5 公里以 6 分配的速度缓步前行的, 但我使用的 keep 只设置了目标里程是半马, 并没有设置目标配速, 导致 keep 只会在每公里达成的时候报平均的配速, 所以我是在抓瞎跑</p><p>再加上, keep 在我播放音乐的时候播报的声音, 我经常是刻意去听也听不清</p><p>最后只能稳住心率在 <strong>150 ~ 160</strong> 之间去跑</p><p>不过话说回来, 虽然我的起步速度确实太快了, 以至于我在 4 公里处, 就开始有点乏力了, 但前半程有很多下坡路段, 跑起来心率还是稳在了 160 以下</p><pre class="mermaid">---title: 2025 届惠州马拉松分段用时---graph TD    start((枪响)) --> five[5公里用时 00:28:17]    five -- "5-10公里用时 00:26:12" --> ten[10公里用时 00:54:29]    ten -- "10-15公里用时 00:26:58" --> fifteen[15公里用时 01:21:27]    fifteen -- "15-20公里用时 00:30:28" --> twenty[20公里用时 01:51:55]    twenty -- "净计时成绩: 01:58:10" --> finish((完赛))</pre><p>令人意外的是, 速度最快的分段竟然是 <strong>10 - 15 公里</strong>处</p><p>比赛的平均配速是 <strong>05’36’’</strong></p><p>说实话这个配速我是很意外的, 我平时的最好成绩是 <strong>2 小时 09 分</strong>, 也就是 <strong>06’07’’</strong></p><p>真实比赛我是悲观态度, 期望能在 <strong>2 小时 20 分</strong> 以内完赛</p><p>之所以是 <strong>2 小时 20 分</strong> 是因为惠马的分区是按配速来的, 在 <strong>2 小时 20 分</strong> 以内, 我就可以进入 <strong>C 区</strong></p><blockquote><p>每个马拉松比赛有不同的分区标准, 甚至可以同一个城市不同举办年份的分区标准也会有区别, 并非简单地按照统一的配速标准来分区</p><p>比如, 惠州马拉松只有 ABCD 四个分区, 但像是北京马拉松, 无锡马拉松这种更知名的马拉松比赛, 它们的分区到了 E 区, 甚至无锡马拉松还有 S 区</p></blockquote><p>但破二是很多人的目标, 也是一道坎, 破二意味着我需要保证平均配速不慢于 <strong>05’41’’</strong></p><p>这对与我来说是一个不小的挑战</p><p>此前, 我经常跑步的距离是 8 公里, 配速快的时候可以达到 <strong>5’20’’</strong>, 但 8 公里 和 半马差别挺大的, 跑 8 公里我不需要任何补给, 保持心率在 170 甚至 180 也能完赛</p><p>但半马维持这个速率的代价肯定会在比赛的后半程体现出来的, 很容易心肺维持不住, 提前撞墙</p><p>总之, 能在第一次半程马拉松中就获取破二的成绩, 我是很满足的</p><h4 id="跑崩"><a href="#跑崩" class="headerlink" title="跑崩"></a>跑崩</h4><p>在正式参加这次马拉松之前, 我有过两次半马的经历, 都是在公园里面绕圈, 一圈 8 公里, 需要跑两圈半</p><p>我的策略是每 8 公里补给一次电解质水, 但两次的半马经历让我确信不能多喝水, 不然在第一个 8 公里之后, 两边的侧腹必然会痛</p><blockquote><p>后来我查了一下, 侧腹痛的俗称是<strong>岔气</strong>, 是一个挺正常的现象</p><p>常发生在</p><ol><li><strong>膈肌痉挛（最常见原因）</strong></li><li><strong>内脏震动牵拉</strong></li><li><strong>腹膜摩擦</strong></li><li><strong>核心力量不足</strong></li></ol></blockquote><p>在 14 公里处尤为明显, 此前, 在 4 公里处有一点点隐约的痛疼, 我通过收腹缓解了这个症状</p><p>但在 14 公里处, 我需要用手按压辅助来缓解侧腹的痛疼</p><p>可以断定从这个时候我就已经跑崩了</p><p>10 公里处我补充了第一支能量胶</p><p>14 公里处, 因为侧腹痛, 我开始补充第二支能量胶试图缓解症状, 也是在这个时候我喝了全程的第一次水</p><p>补充能量胶并没有缓解我的痛疼, 虽然知道能量胶需要一点时间来被吸收</p><p>但事实证明, 后半程, 尤其是 18 公里之后, 我不得不停下来走一段. 一方面是侧腹痛, 另一方面是抬腿都觉得费劲</p><p>惠州马拉松全程我走了三段, 说起来没面子, 身边路过的无论是男是女, 都没看见有停下来走的</p><p>包括我和其他刚开始接触跑步的朋友, 也是说, 不能停下来, 慢跑都比停下来好</p><p>但到自己身上, 身临其境了, 真的是那段时间, 想用手来代替脚跑步</p><blockquote><p>不过拇指也因为按压侧腹脱力了, 赛后的一天内还没有完全恢复过来</p></blockquote><p>最后两公里, 开始出现了干呕的症状, 这个症状我熟悉, 在网上看到过, 属于是正常的现象, 并非健康问题, 但总归还是有些难受的</p><p>硬撑着身体, 尽量在摄像头面前提点速, 坚持到了终点</p><p>到达终点后, 呕了一口能量胶出来, 估计 14 公里处补充的能量胶没吸收多少</p><p>如果在科学一点规划能量补给, 或许能再减慢撞墙的时间, 可以取得更好一些的成绩</p><blockquote><p>说这句话倒不是后悔, 人总需要一点能提升的空间来让自己进步不是</p></blockquote><h3 id="赛后"><a href="#赛后" class="headerlink" title="赛后"></a>赛后</h3><img src="https://static.wuhunyu.top/images/2025/12/adecd77f05ecc0de0fb55d17c06e91df.jpg" alt="完赛" style="zoom:20%;" /><p>惠州马拉松的终点在体育馆里面, 我在里面休息了大约二十分钟</p><p>同时在现场也见证了2025年的惠州马拉松全马冠军冲线, 时间是 <strong>2 小时 18 分</strong>, 大约比我慢了 20 分钟, 但比我多跑了一倍的距离, 确实敬佩</p><p>赛后的拱门后, 挺多选手在做简单的拉伸</p><p>终点处也提供了免费的百岁山矿泉水可以饮用</p><h4 id="流水席"><a href="#流水席" class="headerlink" title="流水席"></a>流水席</h4><p>出了体育馆, 除了完赛奖牌以外, 还有一个完赛包, 里面塞了一根香蕉</p><img src="https://static.wuhunyu.top/images/2025/12/1f1e577fe029ca97dd3ebbf566a71522.jpg" alt="外赛奖牌" style="zoom:30%;" /><blockquote><p>完赛奖牌可以从中间打开, 也就是奖牌是双层的</p><p>我个人不太喜欢这种设计</p></blockquote><p>领完完赛包, 外面还有很多赛事赞助方的补给可以蹭一蹭</p><p>为了冲成绩, 赛道两边的补给我不敢接, 完赛之后的流水席那肯定是要品尝品尝的</p><p>我看见有人吃了牛肉丸子, 圆圆的像是绿豆饼的饼, 绿豆汤, 姜茶, 酸梅汤</p><img src="https://static.wuhunyu.top/images/2025/12/7a1e9e19fb07e3aff7acc12aa83d46c8.jpg" alt="绿豆汤" style="zoom:20%;" /><img src="https://static.wuhunyu.top/images/2025/12/1b8ef32032514d0eca0569d2bd4d84b9.jpg" alt="姜茶&酸梅汤" style="zoom:20%;" /><p>这个姜汤让我眼前一亮, 本来想要问多少钱一包的, 但社恐没敢问, 拍了一个疑似她们商店的二维码</p><img src="https://static.wuhunyu.top/images/2025/12/52dba0d65d0755608f9261404c80e87b.jpg" alt="姜汤商铺" style="zoom:20%;" /><h4 id="公交接驳车"><a href="#公交接驳车" class="headerlink" title="公交接驳车"></a>公交接驳车</h4><p>吃饱喝足, 就准备撤离了</p><p>还是坐官方的公交接驳车, 只不过回去的路线变了, 导致大半个小时才到酒店附近</p><p>路上看到了惠州的双鹅亲吻大桥</p><img src="https://static.wuhunyu.top/images/2025/12/f83e53b0a10fd35858f8bffce39c9254.jpg" alt="双鹅亲吻大桥" style="zoom:25%;" /><p>不过在车上, 还是了解到了一点点其他跑者的信息</p><h4 id="跑团"><a href="#跑团" class="headerlink" title="跑团"></a>跑团</h4><p>刚开始在公交车上, 我还很纳闷, 为什么有两个女跑总是和一个男跑说话</p><blockquote><p>我身边很少有人爱好跑步, 更何况是半程马拉松, 我一直认为跑半程马拉松对于大多数人的身体来说是一个负担大于健康的运动</p><p>健康的运动不应该让身体透支</p></blockquote><p>一直以为他们是夫妻, 但第二个女跑的出现打消我的猜想</p><p>后面询问之后, 才知道他们是从长沙过来的, 都是一个跑团的跑者</p><p>这下就明白了, 我说我都是独狼, 一直是一个人跑</p><p>想想有其他同伴一起比赛, 会是一件很有幸福感的事情</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="惠州西湖夜景"><a href="#惠州西湖夜景" class="headerlink" title="惠州西湖夜景"></a>惠州西湖夜景</h4><img src="https://static.wuhunyu.top/images/2025/12/b487573790b74e28eb9347bb3d740151.jpg" alt="惠州西湖1" style="zoom:25%;" /><img src="https://static.wuhunyu.top/images/2025/12/23db5a5229e1c7252f71b4f207c1773d.jpg" alt="惠州西湖2" style="zoom:25%;" />]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;这篇博客比较偏向于随想的碎碎念, 没有主题&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;比赛基本信息&quot;&gt;&lt;a href=&quot;#比赛基本信息&quot; class=&quot;headerlink&quot; title=&quot;比赛基本信息&quot;&gt;&lt;/a&gt;比赛基本信息&lt;/h3&gt;&lt;p&gt;我参加的第一次半程马拉松是 2025 年的惠州马拉松, 具体的比赛日期是 &lt;code&gt;2025年12月28日&lt;/code&gt;, 具体的开赛时间是 &lt;code&gt;07:30&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="马拉松" scheme="https://wuhunyu.top/categories/%E9%A9%AC%E6%8B%89%E6%9D%BE/"/>
    
    <category term="半程马拉松" scheme="https://wuhunyu.top/categories/%E9%A9%AC%E6%8B%89%E6%9D%BE/%E5%8D%8A%E7%A8%8B%E9%A9%AC%E6%8B%89%E6%9D%BE/"/>
    
    
    <category term="惠州马拉松" scheme="https://wuhunyu.top/tags/%E6%83%A0%E5%B7%9E%E9%A9%AC%E6%8B%89%E6%9D%BE/"/>
    
  </entry>
  
  <entry>
    <title>记一次域名证书自动续签</title>
    <link href="https://wuhunyu.top/chat/2025/12/acme-sh/index.html"/>
    <id>https://wuhunyu.top/chat/2025/12/acme-sh/index.html</id>
    <published>2025-12-19T10:19:00.000Z</published>
    <updated>2026-01-07T07:38:46.861Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前要"><a href="#前要" class="headerlink" title="前要"></a>前要</h3><p>我很早之前就使用了 <a href="https://github.com/acmesh-official/acme.sh">acme.sh</a> 脚本自动化更新域名</p><p>但我并不是先知道 <a href="https://github.com/acmesh-official/acme.sh">acme.sh</a>, 而是从某一个技术博主的推荐中使用的一个第三方提供免费域名签发的平台, 叫 <a href="https://freessl.cn/">freessl.cn</a></p><p>这个网站更新使用的是也是 <a href="https://github.com/acmesh-official/acme.sh">acme.sh</a>, 只不过证书的签发平台是它自己, 而不是我们熟知的 <code>ZeroSSL</code>, <code>Let&#39;s Encrypt</code></p><span id="more"></span><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>当前的免费证书签发有效期都是三个月, 我经常发现我配置在服务的 <strong>acme.sh</strong> 自动续签不起作用</p><p><code>home.wuhunyu.top</code> 域名关联了我许多服务, 这个域名的证书过期, 引发了许多问题</p><ul><li>nginx 以改域名申请的证书的反向代理通通出错了</li><li>为又拍云 CDN 配置的回源证书过期导致博客的部分图片无法访问</li></ul><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>今天抽了点时间, 准备研究一下 <strong>acme.sh</strong></p><h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><ol><li>证书到期前自动续签</li><li>续签之后证书相关文件复制到指定的路径</li><li>续签并复制后, 重载 nginx 服务以重新加载新证书</li></ol><h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><h5 id="证书签发平台"><a href="#证书签发平台" class="headerlink" title="证书签发平台"></a>证书签发平台</h5><p>我的服务器(国内)无法访问 <code>ZeroSSL</code>, 换成了 <code>Let&#39;s Encrypt</code> 之后是没问题的</p><h5 id="续签机制"><a href="#续签机制" class="headerlink" title="续签机制"></a>续签机制</h5><p><strong>acme.sh</strong> 支持多种自动续签机制, 我是在阿里云购买的域名, 解析管理也在阿里云</p><p>可以通过 DNS 验证的方式来实现自动验证</p><h5 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h5><p>实际的操作步骤主要分为两步</p><ol><li>申请证书. 此操作只需要操作一次即可, 后续通过 cron 定时任务定期更新即可, 无需人工干预</li><li>复制证书并重载 nginx. 此操作也只需要手动操作一次, <strong>acme.sh</strong> 会记住这个动作, 并在续签之后自动执行</li></ol><h4 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h4><h5 id="安装-acme-sh"><a href="#安装-acme-sh" class="headerlink" title="安装 acme.sh"></a>安装 <strong>acme.sh</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装命令</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl https://get.acme.sh | sh -s email=my@example.com</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装完毕之后, 可以查询 acme.sh 添加的定时任务</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crontab -l</span></span><br><span class="line">43 0 * * * &quot;/home/xxx/.acme.sh&quot;/acme.sh --cron --home &quot;/home/xxx/.acme.sh&quot; &gt; /dev/null</span><br></pre></td></tr></table></figure><h5 id="阿里云-ak-申请-配置"><a href="#阿里云-ak-申请-配置" class="headerlink" title="阿里云 ak 申请 &amp; 配置"></a>阿里云 ak 申请 &amp; 配置</h5><p>针对阿里云的域名, 具体操作如下</p><ol><li>修改 <code>~/.acme.sh/account.conf</code>, 添加以下环境变量</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export Ali_Key=&quot;&lt;key&gt;&quot;</span><br><span class="line">export Ali_Secret=&quot;&lt;secret&gt;&quot;</span><br></pre></td></tr></table></figure><p>阿里云 ak <a href="https://ram.console.aliyun.com/users">申请地址</a>, 需要给 <strong>AliyunDNSFullAccess</strong> 权限</p><ol start="2"><li>申请证书时, 额外指定 <code>--dns dns_ali</code> 即可</li></ol><h5 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h5><blockquote><p>我们以 <code>baidu.com</code> 这个域名为例, 当然我没有管理 <code>baidu.com</code> 这个域名的权限, 下面只是举例而已</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">申请证书, 由于添加 TXT 记录到被感知需要时间, 所以有可能会失败几次, 慢慢等待它重试即可</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">~/.acme.sh/acme.sh --issue -d baidu.com --dns dns_ali --debug</span></span><br></pre></td></tr></table></figure><h5 id="复制证书-重载-nginx"><a href="#复制证书-重载-nginx" class="headerlink" title="复制证书 &amp; 重载 nginx"></a>复制证书 &amp; 重载 nginx</h5><blockquote><p>假设我们需要将证书复制到 <code>~/cert/baidu.com</code> 目录下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">~/.acme.sh/acme.sh --install-cert -d baidu.com --ecc \</span></span><br><span class="line"><span class="language-bash">--key-file ~/cert/baidu.com/key.pem \</span></span><br><span class="line"><span class="language-bash">--fullchain-file ~/cert/baidu.com/fullchain.pem \</span></span><br><span class="line"><span class="language-bash">--reloadcmd <span class="string">&quot;service nginx reload&quot;</span></span></span><br></pre></td></tr></table></figure><p>这样配置之后, 就可以全自动续签证书 &amp; 重载 nginx 了</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;前要&quot;&gt;&lt;a href=&quot;#前要&quot; class=&quot;headerlink&quot; title=&quot;前要&quot;&gt;&lt;/a&gt;前要&lt;/h3&gt;&lt;p&gt;我很早之前就使用了 &lt;a href=&quot;https://github.com/acmesh-official/acme.sh&quot;&gt;acme.sh&lt;/a&gt; 脚本自动化更新域名&lt;/p&gt;
&lt;p&gt;但我并不是先知道 &lt;a href=&quot;https://github.com/acmesh-official/acme.sh&quot;&gt;acme.sh&lt;/a&gt;, 而是从某一个技术博主的推荐中使用的一个第三方提供免费域名签发的平台, 叫 &lt;a href=&quot;https://freessl.cn/&quot;&gt;freessl.cn&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这个网站更新使用的是也是 &lt;a href=&quot;https://github.com/acmesh-official/acme.sh&quot;&gt;acme.sh&lt;/a&gt;, 只不过证书的签发平台是它自己, 而不是我们熟知的 &lt;code&gt;ZeroSSL&lt;/code&gt;, &lt;code&gt;Let&amp;#39;s Encrypt&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="domain" scheme="https://wuhunyu.top/categories/domain/"/>
    
    <category term="ssl cert" scheme="https://wuhunyu.top/categories/domain/ssl-cert/"/>
    
    
    <category term="acme.sh" scheme="https://wuhunyu.top/tags/acme-sh/"/>
    
  </entry>
  
  <entry>
    <title>Mermaid 简单使用与实践</title>
    <link href="https://wuhunyu.top/chart/2025/12/01/mermaid/index.html"/>
    <id>https://wuhunyu.top/chart/2025/12/01/mermaid/index.html</id>
    <published>2025-12-01T08:59:00.000Z</published>
    <updated>2025-12-01T09:45:00.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="Mermaid-是什么"><a href="#Mermaid-是什么" class="headerlink" title="Mermaid 是什么?"></a>Mermaid 是什么?</h4><p>Mermaid 是一个基于 JavaScript 的图表和制图工具，使用 Markdown 风格的文本定义和渲染器来创建和修改复杂的图表。Mermaid 的主要目的是帮助文档跟上开发进度</p><span id="more"></span><h4 id="Mermaid-能画哪些图"><a href="#Mermaid-能画哪些图" class="headerlink" title="Mermaid 能画哪些图?"></a>Mermaid 能画哪些图?</h4><ul><li>流程图</li><li>时序图</li><li>类图</li><li>状态图</li><li>实体关系图</li><li>用户旅程图</li><li>甘特图</li><li>饼图</li><li>象限图</li><li>需求图</li><li>Git 图表</li><li>C4 图表</li><li>思维导图</li><li>时间线图</li><li>ZenUML</li><li>Sankey</li><li>XY 图表</li><li>块图</li><li>数据包图</li><li>Kanban</li><li>架构图</li></ul><h4 id="语法介绍"><a href="#语法介绍" class="headerlink" title="语法介绍"></a>语法介绍</h4><blockquote><p>Mermaid 的图有很多, 这里只介绍<strong>流程图</strong>, <strong>状态图</strong>和<strong>饼图</strong>三种图的常用语法</p><p>更多的语法和其它图请参考<a href="https://mermaid.js.org/intro">官方文档</a></p><p>以下语法介绍基于 11.12.1 版本</p></blockquote><p>让我们开始吧</p><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p>先看一个完整的列子</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 流程图演示</span><br><span class="line">---</span><br><span class="line">graph TD</span><br><span class="line">  %% 注释</span><br><span class="line">    node1[矩形节点] -- 普通剪头 --&gt; node2(圆角矩形节点)</span><br><span class="line">    node2 == 加粗箭头 ==&gt; node4&#123;菱形节点&#125;</span><br><span class="line">    node4 -. 虚线剪头 .-&gt; node5[(圆柱)]</span><br><span class="line">    node4 &lt;-- 双向箭头 --&gt; node6((圆形))</span><br><span class="line">    node4 -- 自指向剪头 --&gt; node4</span><br></pre></td></tr></table></figure><pre class="mermaid">---title: 流程图演示---graph TD    %% 注释    node1[矩形节点] -- 普通剪头 --> node2(圆角矩形节点)    node2 == 加粗箭头 ==> node4{菱形节点}    node4 -. 虚线剪头 .-> node5[(圆柱)]    node4 <-- 双向箭头 --> node6((圆形))    node4 -- 自指向剪头 --> node4</pre><h5 id="图声明和方向"><a href="#图声明和方向" class="headerlink" title="图声明和方向"></a>图声明和方向</h5><p>流程图可以使用 <code>flowchart</code> 或者 <code>graph</code> 来声明, 其后的 <code>TD</code> 表示流程图的方向</p><ul><li>TB - 从上到下</li><li>TD - 从上到下&#x2F;与从上到下相同</li><li>BT - 从下到上</li><li>RL - 从右到左</li><li>LR - 从左到右</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br></pre></td></tr></table></figure><h5 id="节点形状"><a href="#节点形状" class="headerlink" title="节点形状"></a>节点形状</h5><p>语法形如 <code>id&lt;形状标识&gt;</code></p><blockquote><p>默认为矩形</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">  默认形状</span><br><span class="line">  node1[矩形]</span><br><span class="line">  node2((圆角矩形))</span><br><span class="line">  node3[(圆柱)]</span><br><span class="line">  node4&#123;菱形&#125;</span><br></pre></td></tr></table></figure><pre class="mermaid">graph TD    默认形状    node1[矩形]    node2((圆角矩形))    node3[(圆柱)]    node4{菱形}</pre><h5 id="箭头"><a href="#箭头" class="headerlink" title="箭头"></a>箭头</h5><p>语法形如 <code>----&gt;</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">  node1 -- 普通箭头 --&gt; node2</span><br><span class="line">  node3 &lt;-- 双向箭头 --&gt; node4</span><br><span class="line">  node5 -. 虚线无向箭头 .- node6</span><br><span class="line">  node7 -. 虚线箭头 .-&gt; node8</span><br><span class="line">  node9 == 加粗箭头 ==&gt; node10</span><br><span class="line">  node11 ---- 长箭头 ----&gt; node12</span><br><span class="line">  node13 ---- node14</span><br></pre></td></tr></table></figure><pre class="mermaid">graph TD    node1 -- 普通箭头 --> node2    node3 <-- 双向箭头 --> node4    node5 -. 虚线无向箭头 .- node6    node7 -. 虚线箭头 .-> node8    node9 == 加粗箭头 ==> node10    node11 ---- 长箭头 ----> node12    node13 ---- node14</pre><h5 id="子图"><a href="#子图" class="headerlink" title="子图"></a>子图</h5><p>需要有一对 <code>subgraph ... end</code> 的标签</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">  node1[节点1] ---&gt; sub</span><br><span class="line">  sub ---&gt; node2[节点2]</span><br><span class="line">  </span><br><span class="line">  subgraph sub[子图]</span><br><span class="line">    sub_node1[子图节点1] --&gt; sub_node2[子图节点2]</span><br><span class="line">  end</span><br></pre></td></tr></table></figure><pre class="mermaid">graph TB    node1[节点1] ---> sub    sub ---> node2[节点2]        subgraph sub[子图]        sub_node1[子图节点1] --> sub_node2[子图节点2]    end</pre><h4 id="状态图"><a href="#状态图" class="headerlink" title="状态图"></a>状态图</h4><p>同样先看一个例子</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 状态图演示</span><br><span class="line">---</span><br><span class="line">stateDiagram-v2</span><br><span class="line">  direction TB</span><br><span class="line">  </span><br><span class="line">  state shipped &lt;<span class="tag">&lt;<span class="name">choice</span>&gt;</span>&gt;</span><br><span class="line">  state pay &#123;</span><br><span class="line">    direction LR</span><br><span class="line">    [*] --&gt; init</span><br><span class="line">    init --&gt; paying: 用户发起支付</span><br><span class="line">    </span><br><span class="line">    state &quot;初始化中&quot; as init</span><br><span class="line">    state &quot;支付中&quot; as paying</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  [*] --&gt; pay: 提交订单</span><br><span class="line">  pay --&gt; processing: 支付成功</span><br><span class="line">  pay --&gt; cancelled: 用户主动取消 / 支付超时</span><br><span class="line">  processing --&gt; shipped: 商家 / 仓库发货</span><br><span class="line">  shipped --&gt; refunded: 用户申请取消</span><br><span class="line">  shipped --&gt; completed: 用户收货</span><br><span class="line">  cancelled --&gt; [*]</span><br><span class="line">  refunded --&gt; [*]</span><br><span class="line">  completed --&gt; [*]</span><br><span class="line">  </span><br><span class="line">  pay: 待支付</span><br><span class="line">  note right of pay: 待支付子状态</span><br><span class="line">  processing: 待发货</span><br><span class="line">  refunded: 已退款</span><br><span class="line">  cancelled: 已取消</span><br><span class="line">  completed: 已完成</span><br></pre></td></tr></table></figure><pre class="mermaid">---title: 状态图演示---stateDiagram-v2    direction TB        state shipped <<choice>>    state pay {        direction LR        [*] --> init    init --> paying: 用户发起支付                state "初始化中" as init        state "支付中" as paying    }        [*] --> pay: 提交订单    pay --> processing: 支付成功    pay --> cancelled: 用户主动取消 / 支付超时    processing --> shipped: 商家 / 仓库发货    shipped --> refunded: 用户申请取消    shipped --> completed: 用户收货    cancelled --> [*]    refunded --> [*]    completed --> [*]        pay: 待支付    note right of pay: 待支付子状态    processing: 待发货    refunded: 已退款    cancelled: 已取消    completed: 已完成</pre><h5 id="图声明"><a href="#图声明" class="headerlink" title="图声明"></a>图声明</h5><p>状态图的声明关键字是 <code>stateDiagram-v2</code></p><h5 id="节点形状-1"><a href="#节点形状-1" class="headerlink" title="节点形状"></a>节点形状</h5><p>状态图并没有像是流程图那种丰富的节点形状</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">  %% 起始节点 和 结束节点</span><br><span class="line">  direction LR</span><br><span class="line">  [*] --&gt; [*]</span><br><span class="line">  </span><br><span class="line">  %% 选择节点: 无法添加注释,添加注释之后会变成圆角矩形</span><br><span class="line">  state choice &lt;<span class="tag">&lt;<span class="name">choice</span>&gt;</span>&gt;</span><br><span class="line">  </span><br><span class="line">  %% 子状态图</span><br><span class="line">  state sub_state_diagram &#123;</span><br><span class="line">    direction LR</span><br><span class="line">    [*] --&gt; [*]</span><br><span class="line">  &#125;</span><br><span class="line">  sub_state_diagram: 子状态图</span><br></pre></td></tr></table></figure><pre class="mermaid">stateDiagram-v2    %% 起始节点 和 结束节点    direction LR    [*] --> [*]        %% 选择节点: 无法添加注释,添加注释之后会变成圆角矩形    state choice <<choice>>        %% 子状态图    state sub_state_diagram {        direction LR        [*] --> [*]    }    sub_state_diagram: 子状态图</pre><h5 id="关系描述"><a href="#关系描述" class="headerlink" title="关系描述"></a>关系描述</h5><p>状态流转的关系描述可以直接使用 <code>: &lt;关系描述&gt;</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">  [*] --&gt; node: 关系描述1</span><br><span class="line">  node --&gt; [*]: 关系描述2</span><br><span class="line">  </span><br><span class="line">  node: 节点</span><br></pre></td></tr></table></figure><pre class="mermaid">stateDiagram-v2    [*] --> node: 关系描述1    node --> [*]: 关系描述2        node: 节点</pre><h5 id="箭头-1"><a href="#箭头-1" class="headerlink" title="箭头"></a>箭头</h5><p>状态图中的箭头只能是 <code>--&gt;</code></p><h5 id="状态描述"><a href="#状态描述" class="headerlink" title="状态描述"></a>状态描述</h5><p>状态图中有两种添加状态描述的方式</p><ol><li>形如 <code>id: &lt;状态描述&gt;</code></li><li>形如 <code>state &quot;&lt;状态描述&gt;&quot; as id</code></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">  [*] --&gt; node1</span><br><span class="line">  node1 --&gt; node2</span><br><span class="line">  node2 --&gt; [*]</span><br><span class="line">  </span><br><span class="line">  node1: 节点1</span><br><span class="line">  state &quot;节点2&quot; as node2</span><br></pre></td></tr></table></figure><pre class="mermaid">stateDiagram-v2    [*] --> node1    node1 --> node2    node2 --> [*]        node1: 节点1    state "节点2" as node2</pre><h5 id="子图-1"><a href="#子图-1" class="headerlink" title="子图"></a>子图</h5><p>子图的声明和选择节点有点像</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">  state sub_state_diagram &#123;</span><br><span class="line">    direction LR</span><br><span class="line">    [*] --&gt; sub_node</span><br><span class="line">    sub_node --&gt; [*]</span><br><span class="line">    </span><br><span class="line">    sub_node: 子节点 </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  [*] --&gt; sub_state_diagram</span><br><span class="line">  sub_state_diagram --&gt; [*]</span><br><span class="line">  </span><br><span class="line">  sub_state_diagram: 子图</span><br></pre></td></tr></table></figure><pre class="mermaid">stateDiagram-v2    state sub_state_diagram {        direction LR        [*] --> sub_node        sub_node --> [*]                sub_node: 子节点     }        [*] --> sub_state_diagram    sub_state_diagram --> [*]        sub_state_diagram: 子图</pre><h4 id="饼图"><a href="#饼图" class="headerlink" title="饼图"></a>饼图</h4><p>饼图相对来说比较简单</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pie showData</span><br><span class="line">  title 饼图演示</span><br><span class="line">  &quot;Apple&quot;: 5</span><br><span class="line">  &quot;Banana&quot;: 10</span><br><span class="line">  &quot;Orange&quot;: 3</span><br><span class="line">  &quot;Strawberry&quot;: 2</span><br></pre></td></tr></table></figure><pre class="mermaid">pie showData    title 饼图演示    "Apple": 5    "Banana": 10    "Orange": 3    "Strawberry": 2</pre><h5 id="图声明-1"><a href="#图声明-1" class="headerlink" title="图声明"></a>图声明</h5><p>饼图的声明以 <code>pie</code> 来标识, 可以使用 <code>title</code> 为饼图自定义标题</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pie</span><br><span class="line">    title 饼图</span><br><span class="line">    &quot;full&quot;: 1</span><br></pre></td></tr></table></figure><pre class="mermaid">pie    title 饼图    "full": 1</pre><h5 id="比例"><a href="#比例" class="headerlink" title="比例"></a>比例</h5><p>每个项目的占比使用 <strong>k-v</strong> 的形式声明, 要求 <strong>k</strong> 必须要使用双引号包裹, <strong>v</strong> 为正数(支持小数)</p><blockquote><p>也可以使用 <strong>showData</strong> 来展示具体的占比的实际值</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pie showData</span><br><span class="line">  title 饼图</span><br><span class="line">  &quot;one&quot;: 1</span><br><span class="line">  &quot;two&quot;: 2</span><br><span class="line">  &quot;three&quot;: 3.00</span><br><span class="line">  &quot;four&quot;: 4.0</span><br></pre></td></tr></table></figure><pre class="mermaid">pie showData    title 饼图    "one": 1    "two": 2    "three": 3.00    "four": 4.0</pre><h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>还有许多其它常用的图, 比如 <strong>时序图</strong>, <strong>XY 图表</strong>, <strong>思维导图</strong>, 它们的定义就会比较复杂一些了</p><p>我觉得应该在 Mermaid 这种编码图和二进制图之间做一个取舍, 编码图固然方便, 既没有二进制图片存储的负担, 修改也方便, 实时渲染且样式统一简洁; 但面对一些复杂的图形(比如流程节点众多的流程图), 有一些网站(比如 <a href="https://www.drawio.com/">draw.io</a>)提供的在线绘图能力在作图成本上还是占优的,而且不需要记忆编码图的语法</p><h4 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h4><blockquote><p><a href="https://mermaid.js.org/intro/">Mermaid 英文官方文档</a></p><p><a href="https://docs.min2k.com/zh/mermaid/intro/">Mermaid 中文文档</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;Mermaid-是什么&quot;&gt;&lt;a href=&quot;#Mermaid-是什么&quot; class=&quot;headerlink&quot; title=&quot;Mermaid 是什么?&quot;&gt;&lt;/a&gt;Mermaid 是什么?&lt;/h4&gt;&lt;p&gt;Mermaid 是一个基于 JavaScript 的图表和制图工具，使用 Markdown 风格的文本定义和渲染器来创建和修改复杂的图表。Mermaid 的主要目的是帮助文档跟上开发进度&lt;/p&gt;</summary>
    
    
    
    <category term="chart" scheme="https://wuhunyu.top/categories/chart/"/>
    
    
    <category term="mermaid" scheme="https://wuhunyu.top/tags/mermaid/"/>
    
  </entry>
  
  <entry>
    <title>jackson mixin 特性简单应用</title>
    <link href="https://wuhunyu.top/java/2025/11/17/jackson-mixin/index.html"/>
    <id>https://wuhunyu.top/java/2025/11/17/jackson-mixin/index.html</id>
    <published>2025-11-17T10:14:00.000Z</published>
    <updated>2026-01-07T07:38:46.861Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前段时间遇到一个问题</p><h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><ol><li>项目中有一个手机号脱敏的需求</li><li>项目中涉及脱敏的 VO 类也挺多. 粗略看了一下有几十个,用法就更多了</li></ol><span id="more"></span><p>当时选择的脱敏方案是使用 jackson 的序列化注解方案,形如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonSerialize(using = DesensitizedPhoneSerializer.class)</span></span><br></pre></td></tr></table></figure><p>其中的 <code>DesensitizedPhoneSerializer</code> 是一个自定义的序列化器, 需要继承 <code>com.fasterxml.jackson.databind.JsonSerializer</code> 抽象类, 主要需要重写它的一个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Core method for serializing a value of the type this serializer handles.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value       The value to serialize; cannot be &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> gen         The generator used to output the resulting JSON content.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> serializers The provider that can be used to get serializers for</span></span><br><span class="line"><span class="comment"> *                    any objects that the value contains.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException If an I/O error occurs during the generation process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(T value, JsonGenerator gen, SerializerProvider serializers)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>项目中微服务之间调用使用的是 OpenFeign, 这个框架基于 http 请求并进行动态代理封装的</p><p>依旧会使用 jackson 来进行序列化与反序列化, 网络传输的响应体也就会被 <code>DesensitizedPhoneSerializer</code> 脱敏手机号</p><p>但微服务之间的调用有些时候需要获取到手机号明文</p><h3 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h3><h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><h5 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h5><p>需要进行 rpc 内部调用的接口应该和对普通用户的接口职责分离, 这样可以做到接口级别的隔离</p><p>在对内的接口中传输明文, 在对外的接口中响应脱敏的密文</p><h5 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h5><p>如果有一个方案能在进行序列化时得知接口是否为对内, 也可以在 <code>DesensitizedPhoneSerializer</code> 内部决定是否进行脱敏处理</p><h4 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h4><p>方案一涉及的范围就比较大了, 而且现有的系统对旧接口的依赖已经是一团乱麻了, 分离也不是一件容易的事情</p><blockquote><p>程序界有伟人曾经说过, “能跑就行”</p></blockquote><p>关于方案二, 可以利用 jackson 的 Mixin 特性来实现, 这样改动也是会比较小的</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>使用方案二, 改动成本和风险都是较小的</p><h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><h4 id="Mixin-特性-demo"><a href="#Mixin-特性-demo" class="headerlink" title="Mixin 特性 demo"></a>Mixin 特性 demo</h4><p>原本需要响应的 <code>UserVO</code> 类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7799431123917020619L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonSerialize(using = ToStringSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonSerialize(using = DesensitizedPhoneSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加一个用来替换 <code>DesensitizedPhoneSerializer</code> 序列化器的 <code>UserVOMixin</code> 类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">UserVOMixin</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">793190335567089250L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonSerialize</span></span><br><span class="line">    <span class="keyword">public</span> String phone;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">var</span> <span class="variable">objectMapper1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"><span class="type">UserVO</span> <span class="variable">userVO</span> <span class="operator">=</span> UserVO.builder()</span><br><span class="line">        .id(<span class="number">100L</span>)</span><br><span class="line">        .phone(<span class="string">&quot;18603216630&quot;</span>)</span><br><span class="line">        .desc(<span class="string">&quot;My name&#x27;s Zhangsan&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;=============================脱敏==============================&quot;</span>);</span><br><span class="line">System.out.println(objectMapper1.writeValueAsString(userVO));</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">var</span> <span class="variable">objectMapper2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"><span class="comment">// 替换掉原有的 UserVO</span></span><br><span class="line">objectMapper2.addMixIn(UserVO.class, UserVOMixin.class);</span><br><span class="line">System.out.println(<span class="string">&quot;============================未脱敏==============================&quot;</span>);</span><br><span class="line">System.out.println(objectMapper2.writeValueAsString(userVO));</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">=============================脱敏==============================</span><br><span class="line">&#123;&quot;id&quot;:&quot;100&quot;,&quot;phone&quot;:&quot;186****6630&quot;,&quot;desc&quot;:&quot;My name&#x27;s Zhangsan&quot;&#125;</span><br><span class="line">============================未脱敏==============================</span><br><span class="line">&#123;&quot;id&quot;:&quot;100&quot;,&quot;phone&quot;:&quot;18603216630&quot;,&quot;desc&quot;:&quot;My name&#x27;s Zhangsan&quot;&#125;</span><br></pre></td></tr></table></figure><h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>有了这个特性的帮助, 为 OpenFeign 创建一个单独的 ObjectMapper 对象用于序列化, 并添加需要进行 mixin 的类就大功告成了</p><blockquote><p>或许你会觉得, 不实用 jackson, 换成 fastjson2 或者 gson 作为 OpenFeign 的序列化方案, 这样也可以忽略 jackson 的 @JsonSerialize 注解</p><p>这样也可以, 但<strong>奥卡姆剃刀</strong>有句名言说道”如无必要, 勿增实体”</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;前段时间遇到一个问题&lt;/p&gt;
&lt;h4 id=&quot;场景&quot;&gt;&lt;a href=&quot;#场景&quot; class=&quot;headerlink&quot; title=&quot;场景&quot;&gt;&lt;/a&gt;场景&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;项目中有一个手机号脱敏的需求&lt;/li&gt;
&lt;li&gt;项目中涉及脱敏的 VO 类也挺多. 粗略看了一下有几十个,用法就更多了&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="java" scheme="https://wuhunyu.top/categories/java/"/>
    
    
    <category term="jackson" scheme="https://wuhunyu.top/tags/jackson/"/>
    
    <category term="mixin" scheme="https://wuhunyu.top/tags/mixin/"/>
    
  </entry>
  
  <entry>
    <title>迁移 minio 到 rustfs</title>
    <link href="https://wuhunyu.top/oss/2025/10/31/migration-minio-to-rustfs/index.html"/>
    <id>https://wuhunyu.top/oss/2025/10/31/migration-minio-to-rustfs/index.html</id>
    <published>2025-10-31T14:42:00.000Z</published>
    <updated>2025-10-31T14:42:00.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>minio 在今年 5 月份时, 控制台 ui 出现了一个很大的变化 – 删减了绝大多数 ui 特性</p><span id="more"></span><h3 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h3><p>下图是社区版前后的对比</p><p><img src="https://static.wuhunyu.top/images/2025/10/1e6f33ae8a7c11b013cc9f4171612e78.png" alt="RELEASE.2025-04-22T22-12-26Z"></p><p><img src="https://static.wuhunyu.top/images/2025/10/2d4aef645b4dcb4a3cfbb5f2117473fe.png" alt="RELEASE.2025-09-07T16-13-09Z"></p><p>可以看到 <strong>Access Keys</strong> 和 <strong>Policies</strong> 的菜单都没了</p><h4 id="讨论"><a href="#讨论" class="headerlink" title="讨论"></a>讨论</h4><p>在 github 上,有讨论这个问题的相关 <a href="https://github.com/minio/object-browser/issues/3546">issue</a></p><p>官方给出的答复如下图</p><p><img src="https://static.wuhunyu.top/images/2025/10/9077d7d320b57beafb78ed5c7c79514a.png" alt="minio ui 删减官方答复"></p><h3 id="我的看法"><a href="#我的看法" class="headerlink" title="我的看法"></a>我的看法</h3><p>minio 在 oss 的开源圈中小有名气,我自己的图床也是基于 minio 搭建的</p><p>minio 项目的开源协议是 AGPL-3.0. 这个协议最大限制是它的传染性,就是说如果你修改了源代码,那么你必须要公开你修改之后的版本</p><p>就协议来说,对于我这种没有修改需求的用户而言,没有什么影响</p><p>这次的主要问题在于,我一个社区用户不能再通过控制台 ui 来管理访问 key,也不能通过控制台 ui 来管理访问策略</p><h3 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h3><p>如果想要在 minio 的控制台 ui 上用上以上的特性,有两个选择</p><ol><li>回退 minio 版本到 RELEASE.2025-04-22T22-12-26Z, 这是拥有完整 ui 特性的最后版本</li><li>升级到商用版本</li></ol><p>我最近刷到的有关 rustfs 的广告真的有点多,那不然就试试呗</p><p>rustfs 现在最新的版本是 1.0.0-alpha.66,都还没发布正式版本,也不知道是哪些人在吹</p><p>不过 rustfs 是一个国产项目,文档有中文版本,对国人还是很友好的</p><h3 id="开搞"><a href="#开搞" class="headerlink" title="开搞"></a>开搞</h3><h4 id="部署-rustfs"><a href="#部署-rustfs" class="headerlink" title="部署 rustfs"></a>部署 rustfs</h4><p>直接部署一个新环境肯定没什么问题,但我之前使用的是 minio, 数据也要迁移过来才行</p><p>另外就是,我在 minio 中配置的是多磁盘,那肯定也是想要能直接换到 rustfs 就能用的</p><blockquote><p>我的环境虽然说是多磁盘,但实际上是伪多磁盘,实际磁盘也只有一块</p></blockquote><p>之前的部署使用的是 docker compose 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:RELEASE.2025-04-22T22-12-26Z</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">xxx</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/minio/data/disk1:/mnt/data/disk1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/minio/data/disk2:/mnt/data/disk2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/minio/data/disk3:/mnt/data/disk3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/minio/data/disk4:/mnt/data/disk4</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      server </span></span><br><span class="line"><span class="string">      /mnt/data/disk&#123;1...4&#125; </span></span><br><span class="line"><span class="string">      --console-address &quot;:9001&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.29.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">route-minio</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/minio/nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/cert/home.wuhunyu.top:/etc/cert:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/minio/nginx/logs:/opt/nginx/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9001</span><span class="string">:9001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p>简单修改一下 docker compose 的配置,换成 rustfs</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rustfs:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rustfs/rustfs:1.0.0-alpha.66</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rustfs</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rustfs</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">RUSTFS_ACCESS_KEY:</span> <span class="string">xxx</span></span><br><span class="line">      <span class="attr">RUSTFS_SECRET_KEY:</span> <span class="string">xxx</span></span><br><span class="line">      <span class="attr">RUST_LOG:</span> <span class="string">error</span></span><br><span class="line">      <span class="attr">RUSTFS_OBS_LOG_DIRECTORY:</span> <span class="string">&quot;/var/logs/rustfs/&quot;</span></span><br><span class="line">      <span class="attr">RUSTFS_ADDRESS:</span> <span class="string">&quot;:9000&quot;</span></span><br><span class="line">      <span class="attr">RUSTFS_CONSOLE_ENABLE:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/data/disk1:/mnt/data/disk1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/data/disk2:/mnt/data/disk2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/data/disk3:/mnt/data/disk3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/data/disk4:/mnt/data/disk4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/logs:/var/logs/rustfs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      /mnt/data/disk&#123;1...4&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.29.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">route-rustfs</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rustfs</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rustfs</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/cert/home.wuhunyu.top:/etc/cert:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/rustfs/nginx/logs:/opt/nginx/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9001</span><span class="string">:9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">rustfs:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p>启动, 登录控制台 ui</p><p><img src="https://static.wuhunyu.top/images/2025/10/5d8956fc176aadb103b5985cad1ade9a.png" alt="rustfs 协议"></p><h4 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h4><p>部署的任务是完成了,但之前在 minio 的数据也需要迁移过来</p><p>如果要一个个地走 <strong>S3</strong> 的标准 API 那就有点麻烦了.看官方文档也支持 mc 工具,那不妨拿来用用</p><blockquote><p>mc 工具是 minio 官方开发的一个命令行工具,它的功能要比控制台 ui 上的特性更丰富</p><p>但对于一般用户来说用的还是比较少</p></blockquote><p>要用 mc 工具,那就得把两个 oss 服务都跑起来才行. 简单地修改修改一下原来的 minio 服务的端口就行了,避免端口冲突</p><blockquote><p>比方说,我修改 minio 的 api 端口为 9002, 控制台 ui 端口为 9003</p></blockquote><p>真实操作之前,还等登录控制台 ui 生成一个 Access Keys, minio 和 rustfs 都需要</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 minio</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mc <span class="built_in">alias</span> <span class="built_in">set</span> minio https://[访问地址]:9002 [Access Key] [Secret Key]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 rustfs</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mc <span class="built_in">alias</span> <span class="built_in">set</span> rustfs https://[访问地址]:9000 [Access Key] [Secret Key]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始全量迁移</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mc mirror --overwrite --remove --preserve minio/ rustfs/</span></span><br></pre></td></tr></table></figure><p>等结束就好了</p><p><img src="https://static.wuhunyu.top/images/2025/10/6e8e85469a3bbe17e0fa3bd99ff19a30.png" alt="rustfs 性能"></p><p>最后我的 images bucket 是需要匿名可访问的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mc anonymous <span class="built_in">set</span> download rustfs/images</span></span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h4 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h4><p>如果像我一样配置了 nginx 反向代理,迁移过程中可能会因为迁移的文件太大而超时</p><p>这时候需要修改 nginx 配置,调大请求体,调大超时时间</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxy_send_timeout 3000s;</span><br><span class="line">proxy_read_timeout 3000s;</span><br><span class="line">proxy_connect_timeout 3000s;</span><br><span class="line">client_max_body_size 100G;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;minio 在今年 5 月份时, 控制台 ui 出现了一个很大的变化 – 删减了绝大多数 ui 特性&lt;/p&gt;</summary>
    
    
    
    <category term="oss" scheme="https://wuhunyu.top/categories/oss/"/>
    
    
    <category term="minio" scheme="https://wuhunyu.top/tags/minio/"/>
    
    <category term="rustfs" scheme="https://wuhunyu.top/tags/rustfs/"/>
    
  </entry>
  
  <entry>
    <title>MultipartFile 输入流可重复读吗</title>
    <link href="https://wuhunyu.top/java/2025/10/10/multipart-file/index.html"/>
    <id>https://wuhunyu.top/java/2025/10/10/multipart-file/index.html</id>
    <published>2025-10-10T10:53:00.000Z</published>
    <updated>2026-01-07T07:38:46.861Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="结论在前"><a href="#结论在前" class="headerlink" title="结论在前"></a>结论在前</h4><p>每次调用 <code>org.springframework.web.multipart.MultipartFile#getInputStream</code> 都会返回一个全新的输入流</p><p>所以每次 <code>MultipartFile</code> 输入流可重复读</p><span id="more"></span><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>通常而言,流是单向读取,且不可重复读的</p><p>上面指的流包括 jdk 中的 <code>java.io</code> 和 <code>java.util.stream</code> 都遵守这个规则</p><p>这个例子中,第二次读取同一个流出现了异常</p><figure class="highlight plaintext"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var inputStream = new FileInputStream(&quot;/Users/wuhunyu/Desktop/image.jpeg&quot;);</span><br><span class="line"></span><br><span class="line">// 第一次读取</span><br><span class="line">try &#123;</span><br><span class="line">    var read1 = inputStream.read();</span><br><span class="line">    var read2 = inputStream.read();</span><br><span class="line">    System.out.println(read1 + &quot; / &quot; + read2);</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    // 关闭流</span><br><span class="line">    inputStream.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 第二次读取</span><br><span class="line">var read3 = inputStream.read();</span><br></pre></td></tr></table></figure><p>控制台打印如下</p><figure class="highlight plaintext"><figcaption><span>shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">255 / 216</span><br><span class="line">Exception in thread &quot;main&quot; java.io.IOException: Stream Closed</span><br><span class="line">  at java.base/java.io.FileInputStream.read0(Native Method)</span><br><span class="line">  at java.base/java.io.FileInputStream.read(FileInputStream.java:231)</span><br></pre></td></tr></table></figure><p>换成 <code>java.util.stream</code> 也是一样的</p><figure class="highlight plaintext"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">final var intStream = IntStream.range(1, 4);</span><br><span class="line">// 第一次读取</span><br><span class="line">intStream.boxed()</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">// 第二次读取</span><br><span class="line">intStream.boxed()</span><br><span class="line">        .forEach(System.out::println);</span><br></pre></td></tr></table></figure><p>控制台打印如下</p><figure class="highlight plaintext"><figcaption><span>shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: stream has already been operated upon or closed</span><br><span class="line">  at java.base/java.util.stream.AbstractPipeline.&lt;init&gt;(AbstractPipeline.java:203)</span><br><span class="line">  at java.base/java.util.stream.ReferencePipeline.&lt;init&gt;(ReferencePipeline.java:96)</span><br><span class="line">  at java.base/java.util.stream.ReferencePipeline$StatelessOp.&lt;init&gt;(ReferencePipeline.java:800)</span><br><span class="line">  at java.base/java.util.stream.IntPipeline$1.&lt;init&gt;(IntPipeline.java:174)</span><br><span class="line">  at java.base/java.util.stream.IntPipeline.mapToObj(IntPipeline.java:174)</span><br><span class="line">  at java.base/java.util.stream.IntPipeline.boxed(IntPipeline.java:233)</span><br></pre></td></tr></table></figure><h4 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h4><p>假设你需要开发一个日志切面,这个日志切面需要记录每次请求的 <code>uri</code> ,请求明细数据以及响应数据</p><blockquote><p>这里我们不探讨需求是否合理,只研究如何实现</p></blockquote><p>比较常见的做法是,利用 spring 的 aop 特性,编写一个切面,来记录网络请求的各项参数</p><p>这里比较棘手的问题在于,<strong>请求体</strong>中的数据如果不事先缓存起来,那么在这个日志切面中读取一次之后,在业务层就无法再次读取<strong>请求体</strong></p><p>原因在于请求体是 <code>java.io.InputStream</code> 类型,遵守单向读取,且不可重复读</p><p>为了处理这个问题,一般会缓存原始的请求体数据,每次要读取时,就从缓存中读取即可</p><p>那么,接下来,再看看这个例子</p><blockquote><p>这个例子的功能很简单,把上传的文件复制了两份,分别叫做 <code>image1.jpeg</code> 和 <code>image2.jpeg</code>,并保存在 <code>/Users/wuhunyu/Desktop</code> 目录下</p><p>可以看到复制过程中使用了 try-with-resources 语法,也就说, <code>input</code> 流使用完毕之后就会被关闭</p></blockquote><figure class="highlight plaintext"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/upload&quot;)</span><br><span class="line">public String inputStream(</span><br><span class="line">        @RequestParam(&quot;file&quot;) final MultipartFile file</span><br><span class="line">) &#123;</span><br><span class="line">    final Consumer&lt;String&gt; task = fileName -&gt; &#123;</span><br><span class="line">        try (</span><br><span class="line">                final var output = new FileOutputStream(&quot;/Users/wuhunyu/Desktop/&quot; + fileName);</span><br><span class="line">                final var input = file.getInputStream()</span><br><span class="line">        ) &#123;</span><br><span class="line">            input.transferTo(output);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    task.accept(&quot;image1.jpeg&quot;);</span><br><span class="line">    task.accept(&quot;image2.jpeg&quot;);</span><br><span class="line"></span><br><span class="line">    return &quot;ok&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MultipartFile</code> 是 spring 中对网络文件对象的抽象, 我使用的是 tomcat 内置容器,它的实现是 <code>org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.StandardMultipartFile</code></p><p>在上面的例子中, <code>file.getInputStream()</code> 被执行了两次,如果 <code>org.springframework.web.multipart.MultipartFile#getInputStream</code> 返回的是同一个流对象,那么必然会出现前两个例子中的异常</p><p>但很幸运的是,代码正常运行,且在 <code>/Users/wuhunyu/Desktop</code> 目录下,也像我们预期的那样多了两个文件( <code>image1.jpeg</code> 和 <code>image2.jpeg</code>)</p><p>这就令人疑惑了,难道 <code>org.springframework.web.multipart.MultipartFile#getInputStream</code> 返回的不是同一个流对象吗</p><p>翻看源码,来到了 <code>org.apache.tomcat.util.http.fileupload.disk.DiskFileItem#getInputStream</code></p><figure class="highlight plaintext"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns an &#123;@link java.io.InputStream InputStream&#125; that can be</span><br><span class="line"> * used to retrieve the contents of the file.</span><br><span class="line"> *</span><br><span class="line"> * @return An &#123;@link java.io.InputStream InputStream&#125; that can be</span><br><span class="line"> *         used to retrieve the contents of the file.</span><br><span class="line"> *</span><br><span class="line"> * @throws IOException if an error occurs.</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public InputStream getInputStream()</span><br><span class="line">    throws IOException &#123;</span><br><span class="line">    if (!isInMemory()) &#123;</span><br><span class="line">        return Files.newInputStream(dfos.getFile().toPath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (cachedContent == null) &#123;</span><br><span class="line">        cachedContent = dfos.getData();</span><br><span class="line">    &#125;</span><br><span class="line">    return new ByteArrayInputStream(cachedContent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>别的不看,两个 return 都是创建了新的流.那就说明每次 <code>getInputStream</code> 时,都是一个全新的 <code>InputStream</code> 对象,这样就不奇怪为什么 <code>org.springframework.web.multipart.MultipartFile#getInputStream</code> 获取的流可以被多次使用了</p><p>那么, spring 是怎么做到的呢,莫非也是缓存?</p><p>简单 debug 之后,发现在 <code>org.apache.tomcat.util.http.fileupload.FileUploadBase#parseRequest</code> 中</p><figure class="highlight plaintext"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Processes an &lt;a href=&quot;http://www.ietf.org/rfc/rfc1867.txt&quot;&gt;RFC 1867&lt;/a&gt;</span><br><span class="line"> * compliant &#123;@code multipart/form-data&#125; stream.</span><br><span class="line"> *</span><br><span class="line"> * @param ctx The context for the request to be parsed.</span><br><span class="line"> *</span><br><span class="line"> * @return A list of &#123;@code FileItem&#125; instances parsed from the</span><br><span class="line"> *         request, in the order that they were transmitted.</span><br><span class="line"> *</span><br><span class="line"> * @throws FileUploadException if there are problems reading/parsing</span><br><span class="line"> *                             the request or storing files.</span><br><span class="line"> */</span><br><span class="line">public List&lt;FileItem&gt; parseRequest(final RequestContext ctx)</span><br><span class="line">        throws FileUploadException &#123;</span><br><span class="line">    final List&lt;FileItem&gt; items = new ArrayList&lt;&gt;();</span><br><span class="line">    boolean successful = false;</span><br><span class="line">    try &#123;</span><br><span class="line">        final FileItemIterator iter = getItemIterator(ctx);</span><br><span class="line">        final FileItemFactory fileItemFactory = Objects.requireNonNull(getFileItemFactory(),</span><br><span class="line">                &quot;No FileItemFactory has been set.&quot;);</span><br><span class="line">        final byte[] buffer = new byte[Streams.DEFAULT_BUFFER_SIZE];</span><br><span class="line">        while (iter.hasNext()) &#123;</span><br><span class="line">            if (items.size() == fileCountMax) &#123;</span><br><span class="line">                // The next item will exceed the limit.</span><br><span class="line">                throw new FileCountLimitExceededException(ATTACHMENT, getFileCountMax());</span><br><span class="line">            &#125;</span><br><span class="line">            final FileItemStream item = iter.next();</span><br><span class="line">            // Don&#x27;t use getName() here to prevent an InvalidFileNameException.</span><br><span class="line">            final String fileName = item.getName();</span><br><span class="line">            final FileItem fileItem = fileItemFactory.createItem(item.getFieldName(), item.getContentType(),</span><br><span class="line">                                               item.isFormField(), fileName);</span><br><span class="line">            items.add(fileItem);</span><br><span class="line">            try &#123;</span><br><span class="line">                Streams.copy(item.openStream(), fileItem.getOutputStream(), true, buffer);</span><br><span class="line">            &#125; catch (final FileUploadIOException e) &#123;</span><br><span class="line">                throw (FileUploadException) e.getCause();</span><br><span class="line">            &#125; catch (final IOException e) &#123;</span><br><span class="line">                throw new IOFileUploadException(String.format(&quot;Processing of %s request failed. %s&quot;,</span><br><span class="line">                                                       MULTIPART_FORM_DATA, e.getMessage()), e);</span><br><span class="line">            &#125;</span><br><span class="line">            final FileItemHeaders fih = item.getHeaders();</span><br><span class="line">            fileItem.setHeaders(fih);</span><br><span class="line">        &#125;</span><br><span class="line">        successful = true;</span><br><span class="line">        return items;</span><br><span class="line">    &#125; catch (final FileUploadException e) &#123;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (final IOException e) &#123;</span><br><span class="line">        throw new FileUploadException(e.getMessage(), e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (!successful) &#123;</span><br><span class="line">            for (final FileItem fileItem : items) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    fileItem.delete();</span><br><span class="line">                &#125; catch (final Exception ignored) &#123;</span><br><span class="line">                    // ignored TODO perhaps add to tracker delete failure list somehow?</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第 34 行,出现了一个流复制.其中,输入流来源于请求,输出流如下源码.创建了一个临时文件</p><figure class="highlight plaintext"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns an &#123;@link java.io.OutputStream OutputStream&#125; that can</span><br><span class="line"> * be used for storing the contents of the file.</span><br><span class="line"> *</span><br><span class="line"> * @return An &#123;@link java.io.OutputStream OutputStream&#125; that can be used</span><br><span class="line"> *         for storing the contents of the file.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public OutputStream getOutputStream() &#123;</span><br><span class="line">    if (dfos == null) &#123;</span><br><span class="line">        final File outputFile = getTempFile();</span><br><span class="line">        dfos = new DeferredFileOutputStream(sizeThreshold, outputFile);</span><br><span class="line">    &#125;</span><br><span class="line">    return dfos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且在 <code>org.apache.tomcat.util.http.fileupload.FileUploadBase#parseRequest</code> 的 finally 块中,对 <code>items</code> 进行了清理</p><p>这样说来,spring 在处理文件上传时,会先将上传的文件写入到临时文件中,而后续开发者对 <code>MultipartFile</code> 对象的操作本质都是针对这个已经缓存在服务器上的临时文件,即便是多次创建新的输入流,成本也并没有网络io那么高</p><p>可为什么要这么做呢?spring 大可以告知开发者们,文件流只允许读取一次,如果有多次读取的需求,请自行实现</p><p>带着这个问题,我想看看在 go 中,它的一个热门 web 框架 gin 是怎么看待这个问题的</p><p>示例代码如下,省略了很多错误处理</p><figure class="highlight plaintext"><figcaption><span>go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">  r := gin.Default()</span><br><span class="line">  r.POST(&quot;/upload&quot;, func(c *gin.Context) &#123;</span><br><span class="line">    formFile, _ := c.FormFile(&quot;file&quot;)</span><br><span class="line">    task := func(targetName string) bool &#123;</span><br><span class="line">      file, err := formFile.Open()</span><br><span class="line">      if err != nil &#123;</span><br><span class="line">        return false</span><br><span class="line">      &#125;</span><br><span class="line">      targetFile, _ := os.OpenFile(targetName, os.O_WRONLY|os.O_CREATE, 0666)</span><br><span class="line">      defer func() &#123;</span><br><span class="line">        _ = targetFile.Close()</span><br><span class="line">      &#125;()</span><br><span class="line">      _, _ = io.Copy(targetFile, file)</span><br><span class="line">      if err := file.Close(); err != nil &#123;</span><br><span class="line">        return false</span><br><span class="line">      &#125;</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if !task(&quot;/Users/wuhunyu/Desktop/image1.jpeg&quot;) &#123;</span><br><span class="line">      c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">        &quot;message&quot;: fmt.Sprintf(&quot;upload file to %s failed&quot;, &quot;image1&quot;),</span><br><span class="line">      &#125;)</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    if !task(&quot;/Users/wuhunyu/Desktop/image2.jpeg&quot;) &#123;</span><br><span class="line">      c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">        &quot;message&quot;: fmt.Sprintf(&quot;upload file to %s failed&quot;, &quot;image2&quot;),</span><br><span class="line">      &#125;)</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">      &quot;message&quot;: &quot;upload success&quot;,</span><br><span class="line">    &#125;)</span><br><span class="line">    c.Done()</span><br><span class="line">  &#125;)</span><br><span class="line">  err := r.Run(&quot;:8080&quot;)</span><br><span class="line">  if err != nil &#123;</span><br><span class="line">    panic(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码中, <code>formFile</code> 被 <code>Open</code> 了两次,最后的结果也是正常,且成功复制了两个文件( <code>image1.jpeg</code> 和 <code>image2.jpeg</code>)</p><p>也就是说, gin 的处理和 spring 是一样的,都是支持流被重复读取</p><p>至于为什么 <code>StandardMultipartFile</code>  被设计成可以被重复读取, ai 给我的回答如下</p><ol><li>HTTP 请求在本质上是一个<strong>原子性的、一次性的事务</strong>。服务器必须<strong>读取完整个请求的输入流</strong>，才能确认请求已经结束并且没有损坏。一旦这个底层的网络输入流被读取完毕，它就被消费掉了，无法“倒带”或重读</li><li>将文件缓存下来，最大的好处就是<strong>文件内容可以被多次、独立地访问</strong></li><li>将文件的<strong>接收阶段</strong>和<strong>处理阶段</strong>解耦，可以极大地提高系统的可靠性</li><li>框架（如 Spring MVC）和 Servlet 容器的设计目标之一就是<strong>简化开发者的工作</strong></li></ol><p>主要能说服我的是第一点</p><h4 id="响应式编程"><a href="#响应式编程" class="headerlink" title="响应式编程"></a>响应式编程</h4><p>传统的HTTP请求是请求-响应式的,如果换成响应式编程呢</p><table><thead><tr><th>特性</th><th>Spring MVC (MultipartFile)</th><th>Spring WebFlux (FilePart)</th></tr></thead><tbody><tr><td><strong>核心机制</strong></td><td><strong>先缓存，后处理 (Buffer-then-process)</strong></td><td><strong>真正的流式处理 (True Streaming)</strong></td></tr><tr><td><strong>调用时机</strong></td><td>控制器方法在<strong>整个文件接收并缓存完毕后</strong>才被调用。</td><td>控制器方法在<strong>请求头到达后立即被调用</strong>，文件内容以流的形式后续提供。</td></tr><tr><td><strong>资源占用</strong></td><td>内存或磁盘占用与<strong>上传文件大小成正比</strong>。一个 1GB 的文件会占用 1GB 的临时存储。</td><td>内存占用非常小且<strong>基本恒定</strong>，与文件大小无关。只占用一小块缓冲区来处理当前的数据块。</td></tr><tr><td><strong>编程模型</strong></td><td><strong>命令式、阻塞式</strong>。transferTo() 是一个阻塞操作，直到文件写完才返回。</td><td><strong>响应式、非阻塞</strong>。transferTo() 返回一个 Mono，立即返回，文件写入在后台异步进行。</td></tr><tr><td><strong>可扩展性</strong></td><td>处理大量并发大文件上传时，会因临时存储耗尽或线程阻塞而遇到瓶颈。</td><td><strong>高度可扩展</strong>。由于资源占用低且非阻塞，可以用少量线程处理大量并发上传。</td></tr></tbody></table><p><strong>响应式编程默认情况下文件流不会被完整缓存到服务器内存或磁盘后才交给代码处理,它采用了真正的流式处理</strong></p>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;结论在前&quot;&gt;&lt;a href=&quot;#结论在前&quot; class=&quot;headerlink&quot; title=&quot;结论在前&quot;&gt;&lt;/a&gt;结论在前&lt;/h4&gt;&lt;p&gt;每次调用 &lt;code&gt;org.springframework.web.multipart.MultipartFile#getInputStream&lt;/code&gt; 都会返回一个全新的输入流&lt;/p&gt;
&lt;p&gt;所以每次 &lt;code&gt;MultipartFile&lt;/code&gt; 输入流可重复读&lt;/p&gt;</summary>
    
    
    
    <category term="MultipartFile" scheme="https://wuhunyu.top/categories/MultipartFile/"/>
    
    <category term="流" scheme="https://wuhunyu.top/categories/MultipartFile/%E6%B5%81/"/>
    
    
    <category term="java" scheme="https://wuhunyu.top/tags/java/"/>
    
    <category term="go" scheme="https://wuhunyu.top/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>记一次个人服务器操作系统切换</title>
    <link href="https://wuhunyu.top/linux/2025/10/04/mac-mini/index.html"/>
    <id>https://wuhunyu.top/linux/2025/10/04/mac-mini/index.html</id>
    <published>2025-10-04T13:19:00.000Z</published>
    <updated>2025-10-04T13:19:00.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>早年买了一台 mac mini,后面因为又购入了 mac book pro 而闲置了</p><p>一直没有找到合理利用它的场景</p><span id="more"></span><h4 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h4><p>前面说到一直没有找到好好利用这台闲置的 mac mini 的场景</p><p>我同事有使用自己的 mac mini 办公,但我已经有 mac book pro 了,有些数据如果要在多个机器上传输还是很麻烦的.如果能做到工作和生活完全分离,那么工作用 mac mini,生活用 mac book pro 也是不错的.但对于我这种手机卡都只习惯使用一张的人来说,多机器还是有点麻烦了</p><p>mac os 作为一个个人桌面操作系统,相对于 windows 操作系统,我体验下来还是很不错的,具体体现在</p><ul><li><strong>类 linux 操作系统</strong>.虽然命令不怎么兼容各类 linux 发行版,但比起 windows 操作系统的终端来说,要好很多.如果直接使用 linux 桌面,针对个人来说,软件源太匮乏应该算是它最大的原罪</li><li><strong>硬件也很精致</strong>. mac os 的流畅和它硬件强大也有很多关系, windows 平台这边,我没发现能与之匹敌的笔记本</li><li><strong>品牌效应</strong>. 我得承认使用 mac 也受到了网络上一些群友,自媒体的引导, mac os 对我而言,除了不能打游戏以外, 以前在 windows 上能做的事情,现在在 mac os 上一样也能做(当然,我不会认为换成了 mac os 就会效果提升)</li></ul><p>虽然有以上的这些特点,但其实我一直想要将闲置的 mac mini 用作个人的服务器,用于替换我的 x86 笔记本</p><p>原因在于</p><ul><li><strong>性能</strong>. 家里的 x86 笔记本硬件上不如 mac mini</li><li><strong>能耗</strong>. mac mini 是 arm 架构,它的能耗控制的更好</li><li><strong>电池</strong>. 服务器需要长期开机运行,我一直想要拆卸 x86 笔记本上的电池.我经常不在家,我还是比较害怕电池鼓包着火的,但一直没有动手拆卸它</li><li><strong>网口</strong>. x86 笔记本用的是 type-c 转 rj45 转接头,我一直怀疑这个接口限制了局域网的速度上限.不过我家的带宽是 300M,作为互联网使用来说,网络的没有瓶颈,方便的地方就在少一个转接头</li></ul><p>既然有了充足的理由,那就开干</p><h4 id="第一次尝试"><a href="#第一次尝试" class="headerlink" title="第一次尝试"></a>第一次尝试</h4><p>最初我尝试直接使用 mac os 作为服务器</p><p>我的主要使用场景还是容器,只要能安装 docker,一般也不需要在宿主机上做多少准备工作</p><p>但我发现 mac os 不适合作为服务器操作系统</p><p>来回想一下服务器的一些特性</p><ol><li><p>长时间运行无异常</p></li><li><p>终端远程登录</p></li></ol><p>第一个特性我不好说,有可能没问题</p><p>第二个特性有比较大的问题</p><ol><li>mac os 启动之后需要本地登录之后才允许远程登录.如果没有登录一个本地账户,我怀疑 mac os 的 sshd 进程根本就不会运行</li><li>mac os 需要一个显示器,否则远程桌面也不行.mac os 的远程和 windows 还不一样,它是共享,需要一个主,远程的画面算是从.这个可以通过一些配件来欺骗 mac os,实践时可以不需要真的连接一个显示器,那样功耗太大了,不过我没有实践过</li></ol><p><strong>第一个问题我没有找到可行的解决方案</strong></p><p>所以第一次尝试就搁置了</p><h4 id="第二次尝试"><a href="#第二次尝试" class="headerlink" title="第二次尝试"></a>第二次尝试</h4><p>那么,如果在 mac mini 的硬件上安装 一个 linux 发行版,是否可行呢?</p><p>答案是,早就有人在实践了,而且有个 release 版本</p><p>现在如果你这样问 Gemini 2.5 pro</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">Q: 我用一台闲置的mac mini,它是 m2 芯片的.现在我想要为它安装一个 linux 操作系统,请问有哪些 linux 发行版推荐?</span><br><span class="line">A: 太棒了！M2 Mac Mini 是一台性能强劲、功耗极低的小主机，用来运行 Linux 非常合适。</span><br><span class="line"></span><br><span class="line">对于 Apple Silicon (M1/M2/M3 芯片) 的 Mac，情况比较特殊，你不能像在普通 x86 电脑上那样随意选择任何 Linux 发行版。因为苹果的硬件是自研的，需要专门的驱动程序。</span><br><span class="line"></span><br><span class="line">目前，在这个领域有一个绝对的核心项目，那就是 Asahi Linux。</span><br><span class="line"></span><br><span class="line">核心概念： Asahi Linux 项目的目标是逆向工程苹果芯片，并为主线 Linux 内核开发开源的、完全功能的驱动程序。它本身不是一个独立的发行版，而是一个提供底层支持（内核、驱动、引导程序）的项目。其他的 Linux 发行版可以基于 Asahi 的工作成果来适配苹果芯片。</span><br><span class="line"></span><br><span class="line">因此，你的选择基本上就是“集成了 Asahi 项目成果的 Linux 发行版”。</span><br><span class="line"></span><br><span class="line">推荐列表 (从最推荐到备选)</span><br><span class="line">1. Fedora Asahi Remix (⭐⭐⭐⭐⭐ - 首选推荐)</span><br><span class="line"></span><br><span class="line">这是 Asahi Linux 项目官方的旗舰发行版，也是目前最推荐、最成熟、开箱即用体验最好的选择。</span><br><span class="line"></span><br><span class="line">为什么推荐？</span><br><span class="line"></span><br><span class="line">官方合作： Asahi Linux 团队与 Fedora 项目紧密合作，这意味着你能最快获得最新的硬件驱动和系统更新，集成度最高。</span><br><span class="line"></span><br><span class="line">开箱即用： 安装完成后，Wi-Fi、蓝牙、USB、GPU 硬件加速（OpenGL 3.3）、扬声器、电源管理等基本都已正常工作。M2 Mac Mini 的硬件支持度非常好。</span><br><span class="line"></span><br><span class="line">桌面环境： 默认使用非常精致的 KDE Plasma 桌面，对 Wayland 支持良好，完美利用了 Mac 的 Retina 显示屏。你也可以选择安装 GNOME 或其他桌面环境。</span><br><span class="line"></span><br><span class="line">安装简单： 官方提供一个非常简单的命令行安装脚本，在 macOS 的终端里运行一行命令即可，它会自动处理分区、下载和安装，非常安全，不会破坏你现有的 macOS 系统。</span><br><span class="line"></span><br><span class="line">适合谁？</span><br><span class="line"></span><br><span class="line">几乎所有人，特别是希望获得一个稳定、美观、功能完整的桌面 Linux 体验的用户。</span><br><span class="line"></span><br><span class="line">Linux 新手和老手都适用。</span><br><span class="line"></span><br><span class="line">2. Asahi Arch Linux ARM (⭐⭐⭐ - 进阶选择)</span><br><span class="line"></span><br><span class="line">这是 Asahi Linux 项目最初的参考发行版，基于 Arch Linux ARM。</span><br><span class="line"></span><br><span class="line">为什么推荐？</span><br><span class="line"></span><br><span class="line">滚动更新： 如果你喜欢永远使用最新的软件和内核，Arch Linux 的滚动更新模式非常适合你。</span><br><span class="line"></span><br><span class="line">高度可定制： Arch Linux 允许你从一个最小化的系统开始，完全按照自己的需求来构建整个系统和桌面环境。</span><br><span class="line"></span><br><span class="line">强大的社区和文档： Arch Wiki 是 Linux 世界里最详尽的文档库之一。</span><br><span class="line"></span><br><span class="line">需要注意什么？</span><br><span class="line"></span><br><span class="line">相比 Fedora Asahi Remix，它的配置过程更手动，需要你对 Linux 有一定的了解。</span><br><span class="line"></span><br><span class="line">更适合喜欢“折腾”、想要完全掌控系统的资深用户。</span><br><span class="line"></span><br><span class="line">适合谁？</span><br><span class="line"></span><br><span class="line">经验丰富的 Linux 用户，开发者，以及 Arch Linux 的爱好者。</span><br><span class="line"></span><br><span class="line">3. 其他选择 (需要更多手动配置)</span><br><span class="line"></span><br><span class="line">虽然官方主推以上两种，但你也可以在其他 ARM64 发行版上手动安装 Asahi 的内核和脚本，但这通常比较复杂，不推荐新手尝试。例如：</span><br><span class="line"></span><br><span class="line">Ubuntu Server / Debian (ARM64): 你可以安装一个基础的 ARM64 服务器系统，然后手动添加 Asahi 的软件源并安装其内核和支持包。这适合想把 Mac Mini 当作一个纯粹的、无图形界面的服务器（比如跑 Docker、做 Web 服务器）的用户。</span><br><span class="line"></span><br><span class="line">在你开始之前，需要了解的关键点</span><br><span class="line"></span><br><span class="line">硬件支持状态： 尽管 Asahi 项目进展神速，但仍有部分硬件功能尚未完美支持。对于 M2 Mac Mini 来说，绝大部分功能都已工作，但你需要注意：</span><br><span class="line"></span><br><span class="line">Thunderbolt / USB4: 端口可以作为普通的 USB-C 3.2 端口使用，但完整的 Thunderbolt 功能仍在开发中。</span><br><span class="line"></span><br><span class="line">HDMI 2.1: 部分高级功能（如高刷新率、VRR）可能还在完善中。</span><br><span class="line"></span><br><span class="line">内置扬声器： 已经有了重大突破并基本可用，但音质优化仍在进行中。</span><br><span class="line"></span><br><span class="line">麦克风： 目前还不支持。</span><br><span class="line"></span><br><span class="line">你可以随时在官方网站查看最新的硬件支持列表：Asahi Linux Wiki - Feature Support</span><br><span class="line"></span><br><span class="line">安装过程：</span><br><span class="line"></span><br><span class="line">双系统： Asahi 的标准安装过程是双系统。它会智能地缩减你当前的 macOS 分区，然后创建新的分区来安装 Linux。你的 macOS 系统和数据都是安全的。</span><br><span class="line"></span><br><span class="line">需要 macOS： 安装必须从最新的 macOS 系统下启动。你需要保持你的 Mac Mini 系统是最新版本。</span><br><span class="line"></span><br><span class="line">引导切换： 安装后，你可以在开机时按住电源键，进入启动选项菜单，自由选择启动到 macOS 还是 Asahi Linux。</span><br><span class="line"></span><br><span class="line">总结与最终建议</span><br><span class="line"></span><br><span class="line">对于你的 M2 Mac Mini，我强烈推荐你首先尝试 Fedora Asahi Remix。</span><br><span class="line"></span><br><span class="line">它的安装过程最简单，体验最完整，可以让你以最快的速度在 M2 Mac Mini 上拥有一个功能齐全的 Linux 桌面环境。它几乎就是为你的设备量身定做的。</span><br><span class="line"></span><br><span class="line">如何开始？</span><br><span class="line"></span><br><span class="line">将你的 Mac Mini 更新到最新的 macOS 版本。</span><br><span class="line"></span><br><span class="line">打开 macOS 的“终端” (Terminal) 应用。</span><br><span class="line"></span><br><span class="line">复制并粘贴以下命令并回车，然后按照屏幕提示操作即可：</span><br><span class="line"></span><br><span class="line">code</span><br><span class="line">Bash</span><br><span class="line">download</span><br><span class="line">content_copy</span><br><span class="line">expand_less</span><br><span class="line">curl https://fedora-asahi-remix.org/install | sh</span><br><span class="line"></span><br><span class="line">安装程序会引导你完成所有步骤，包括分区大小选择等，整个过程非常自动化。祝你玩得开心！</span><br></pre></td></tr></table></figure><p>在这一次回答中, 大模型给出的前两个选项都是 <a href="https://asahilinux.org/">asahi</a> 操作系统</p><p>其中, <strong>Asahi Arch Linux ARM</strong> 是早期的版本,现在比较推荐 <strong>Fedora Asahi Remix</strong></p><p>考虑到 <strong>Fedora Asahi Remix</strong> 专门针对 mac 的硬件做了优化,那就没有其它的道理选择其它的发行版,也没其他选择了</p><p>再上官网上一看,也是明确支持 mac mini m2 的</p><p><img src="https://static.wuhunyu.top/images/2025/10/0369f00e11115c911a0fa0be725fb044.png" alt="device support"></p><p>再看看官方这么吹它的 <strong>Fedora Asahi Remix</strong></p><ul><li>With Fedora’s excellent 64-bit ARM support and mature development process, you can expect a solid and high-quality experience without any unwanted surprises.</li></ul><blockquote><p>翻译: 凭借 Fedora 出色的 64 位 ARM 支持和成熟的开发流程，您可以期待获得稳定、高品质的体验，而不会有任何意外问题。</p></blockquote><ul><li><p>Fedora Asahi Remix ❤️ KDE Plasma</p></li><li><p>Whether you’re a KDE enthusiast or a GNOME lover, Fedora Asahi Remix comes right out of the box with a 100% <a href="https://wayland.freedesktop.org/">Wayland</a> environment, bringing you the newest desktop and display server technologies, which are a perfect match for Apple hardware.</p></li></ul><blockquote><p>翻译: 无论您是 KDE 爱好者还是 GNOME 爱好者，Fedora Asahi Remix 都开箱即为您提供了一个 100% 的 <a href="https://www.google.com/url?sa=E&q=https://wayland.freedesktop.org/">Wayland</a> 环境。其最新的桌面和显示服务器技术，与苹果硬件堪称绝配。</p></blockquote><ul><li>The best Linux laptop audio you’ve ever heard</li></ul><blockquote><p>翻译: 您所听过的最佳 Linux 笔记本音质。</p></blockquote><p>对于我的用途来说</p><p>音质无所谓</p><p>fedora 并不是一个很稳定的操作系统,你了解的话,就知道 fedora 是 centos stream 的上游,但 centos stream 都已经很少企业会使用了</p><p>但咱不是没得挑吗,硬着头皮上喽</p><p>安装命令也就一行命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://alx.sh | sh</span><br></pre></td></tr></table></figure><p>开整</p><h4 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">          /:-------------:\          wuhunyu@wuhunyu </span><br><span class="line">       :-------------------::        --------------- </span><br><span class="line">     :-----------/shhOHbmp---:\      OS: Fedora Linux Asahi Remix 42 (Forty Two [Adams]) aarch64 </span><br><span class="line">   /-----------omMMMNNNMMD  ---:     Host: Apple Mac mini (M2, 2023) </span><br><span class="line">  :-----------sMMMMNMNMP.    ---:    Kernel: 6.16.8-400.asahi.fc42.aarch64+16k </span><br><span class="line"> :-----------:MMMdP-------    ---\   Uptime: 1 hour, 10 mins </span><br><span class="line">,------------:MMMd--------    ---:   Packages: 2070 (rpm), 24 (brew) </span><br><span class="line">:------------:MMMd-------    .---:   Shell: bash 5.2.37 </span><br><span class="line">:----    oNMMMMMMMMMNho     .----:   Resolution: 3840x2160 </span><br><span class="line">:--     .+shhhMMMmhhy++   .------/   Terminal: /dev/pts/0 </span><br><span class="line">:-    -------:MMMd--------------:    CPU: (8) @ 2.424GHz </span><br><span class="line">:-   --------/MMMd-------------;     Memory: 1559MiB / 15705MiB </span><br><span class="line">:-    ------/hMMMy------------:</span><br><span class="line">:-- :dMNdhhdNMMNo------------;                               </span><br><span class="line">:---:sdNMMMMNds:------------:                                </span><br><span class="line">:------:://:-------------::</span><br><span class="line">:---------------------://</span><br></pre></td></tr></table></figure><h4 id="使用体验"><a href="#使用体验" class="headerlink" title="使用体验"></a>使用体验</h4><p>你别说,这个 linux 发行版还真是让我大开眼界了</p><p>这个系统第一个我用着用着不是因为资源不足直接崩溃死机的</p><p><img src="https://static.wuhunyu.top/images/2025/10/7c6fa766d44633ac76b99875a1817355.png" alt="崩溃日志"></p><p>除此之外,还出现过一次找不到磁盘的错误.重新安装之后就好了</p><p>arm64 架构带来的问题是,要开始考虑软件适配问题了</p><p>好处是</p><p>性能强劲,还基本听不到风扇转,还是不错的</p><p><img src="https://static.wuhunyu.top/images/2025/10/e064000e0f75c4553ce3e9a94b40d227.png" alt="负载信息"></p><h4 id="后手"><a href="#后手" class="headerlink" title="后手"></a>后手</h4><p>上面说到新系统不太稳定</p><p>那么,旧的 x86 笔记本还是得运行着,需要一些时间来观察新系统的稳定性</p>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;早年买了一台 mac mini,后面因为又购入了 mac book pro 而闲置了&lt;/p&gt;
&lt;p&gt;一直没有找到合理利用它的场景&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://wuhunyu.top/categories/linux/"/>
    
    
    <category term="mac mini" scheme="https://wuhunyu.top/tags/mac-mini/"/>
    
    <category term="asahi" scheme="https://wuhunyu.top/tags/asahi/"/>
    
  </entry>
  
  <entry>
    <title>自组折叠自行车</title>
    <link href="https://wuhunyu.top/bike/2025/09/bike/index.html"/>
    <id>https://wuhunyu.top/bike/2025/09/bike/index.html</id>
    <published>2025-09-14T03:08:00.000Z</published>
    <updated>2025-09-14T03:08:00.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前几个月对折叠自行车比较感兴趣,通过视频,网络好友,配件卖家等渠道了解到了一些自组折叠自行车的相关知识</p><p>写一篇博客记录分享一下</p><blockquote><p>这部分知识和组装折叠自行车强相关</p><p>知识比较偏向于理论,并没有实践来验证</p><p>强烈建议想要了解自组折叠车的朋友转到<strong>附表-配件简图</strong>先认识一下各个配件的样子</p></blockquote><span id="more"></span><h3 id="什么是折叠自行车"><a href="#什么是折叠自行车" class="headerlink" title="什么是折叠自行车"></a>什么是折叠自行车</h3><p>折叠自行车肯定是要能折叠的,不过也因为折叠属性,我目前没见过大轮径的折叠车</p><p>折叠也分多种,两折叠比较常见,一般在大梁的位置可以折叠一次;也有三折叠,在一些小众名牌中</p><p>只要能折叠,是自行车.我认为它被称作<strong>折叠自行车</strong>就是没有毛病的</p><blockquote><p>下面我着重介绍的折叠自行车是指带变速的类型</p><p>以下两张图并非我的组装成果,来自山东某位网友</p></blockquote><p><img src="https://static.wuhunyu.top/images/2025/09/a2767e93ec0e65298e832c5f726dcb31.jpg" alt="骑行状态"></p><p><img src="https://static.wuhunyu.top/images/2025/09/7852840d0caedea4b6c753cc8b92e55f.jpg" alt="折叠状态"></p><h3 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h3><h4 id="碳纤维"><a href="#碳纤维" class="headerlink" title="碳纤维"></a>碳纤维</h4><p>碳纤维是一种新工艺,其主要的成份是碳材料.制作好的成品一般具有不错的滤震能力,且重量相比于铝制来说也要轻不少,刚性也不错</p><p>碳纤维在自行车领域在我看来是一种高级材料,你可以将车身的许多配件都找到它的制品.比如碳车架,碳前叉,碳车把,碳坐管,碳轮组,甚至碳坐垫,碳脚踏和碳盘片</p><p>碳纤维的特点是轻和滤震,也具有不错的强度,但它比较脆,不像金属一样具有一定的延展性,受到强力的挤压会导致碳制零件断裂报废</p><p>另外一点就是,碳纤维技术虽然在90年代就被发明了,但在工业化的现在,其成本依然高于钢制铝制材料</p><h4 id="钛合金"><a href="#钛合金" class="headerlink" title="钛合金"></a>钛合金</h4><p>钛制品在很多领域都具有一种特殊的光环.比如钛制水杯</p><p>基于钛金属本身的一些特性(耐腐蚀,重量相对钢制品较轻,强度高),在一小部分人群中,会追求钛车架</p><p>但钛本身滤震性并不如碳,基于它的成本和碳都不是普通人愿意接受的价格,不推荐普通人接触这个东西</p><h4 id="刚性"><a href="#刚性" class="headerlink" title="刚性"></a>刚性</h4><blockquote><p>指的是自行车车架和各个部件在受力时抵抗形变（弯曲、扭曲）的能力</p><p>以上发言来自 ai Gemini 2.5 pro</p></blockquote><p>什么是刚性呢?我简单理解为稳定性</p><p>折叠车由于需要折叠,整个车架并不是一体的,比起传统的一体式车架,更需要考虑在暴力骑行中是否会出现车身晃动甚至散架的问题</p><p>折叠车的刚性和车架的结构和材质关系比较大</p><p>比如,<strong>大行 P8</strong>为了增加稳定性,在中轴和碗组的位置安装了一根叫马甲线的线材</p><p>比如,蚂蚁腿车架使用了铬钼钢作为车架材料</p><h3 id="整车品牌"><a href="#整车品牌" class="headerlink" title="整车品牌"></a>整车品牌</h3><blockquote><p>虽然主要介绍的是组装,但了解一下整车也是很有必要的</p><p>有一些不那么爱折腾的朋友,有一种途径是买整车然后再替换部分配件</p><p>换下来的旧配件可以放闲鱼上卖.事实上也不少人是这么做的</p></blockquote><h4 id="大行-DAHON"><a href="#大行-DAHON" class="headerlink" title="大行(DAHON)"></a>大行(DAHON)</h4><p>这是个美国的品牌,在国内的折叠车领域也算得上是一把手了,比较有名的型号是<strong>大行 P8</strong></p><img src="https://static.wuhunyu.top/images/2025/09/ed42484afae83738783755bbe499254c.png" alt="大行 P8" style="zoom:30%;" /><p>只看线上电商平台的渲染图,我更喜欢大行的另一个车型<strong>大行 K3 Plus</strong></p><img src="https://static.wuhunyu.top/images/2025/09/6c14bcd3c3100b3e25d9d8cba2c8d2f3.png" alt="大行 K3 Plus" style="zoom:30%;" /><p>我在线下试骑过这个,但车店只有一辆二手的车型,车子骑起来特别软,刚性很差,导致我放弃了这个车型</p><h4 id="燕鸥-Tern"><a href="#燕鸥-Tern" class="headerlink" title="燕鸥(Tern)"></a>燕鸥(Tern)</h4><p>这是牌子是从大行出来的员工新创立的牌子</p><img src="https://static.wuhunyu.top/images/2025/09/25778a8b0303cb406f804be590e4df00.png" alt="燕鸥 B8" style="zoom:40%;" /><h3 id="配件"><a href="#配件" class="headerlink" title="配件"></a>配件</h3><p>按重要性来排序,各个大件我会这样排序</p><ol><li><p>车架</p></li><li><p>变速套件</p></li><li><p>内外胎</p></li><li><p>坐管</p></li><li><p>头管</p></li><li><p>刹车</p></li><li><p>轮组</p></li><li><p>车把</p></li><li><p>坐垫</p></li><li><p>其它</p></li></ol><h4 id="车架"><a href="#车架" class="headerlink" title="车架"></a>车架</h4><blockquote><p>折叠车的车架一般都是带前叉的</p></blockquote><p>自行车圈子有一句调侃的话是</p><p>穷玩车架,富玩轮</p><p>车架作为联通自行车各个部件的中间人,地位就像是电脑中的主板一样.有些人狠狠加料,有些人觉得够用就行</p><p><img src="https://static.wuhunyu.top/images/2025/09/57cae7ed6c60b6843594b2439d6d843f.png" alt="蚂蚁腿车架"></p><p>前面有说到,有部分朋友是买的整车然后改装,然后闲鱼出售旧的配件</p><p>既然有出售配件的,当然也有平台车车架的.你也可以选择在闲鱼蹲一辆大行的拆车车架</p><p>不过,二手产品的稳定性不那么好保证,如果有洁癖还是选择新购入吧</p><p>车架方面,国内比较知名一些的车架平台有风行,科瑞斯(Crius),犀牛(EIOSIX)</p><p>这里面,名声最大的是风行,这个品牌早期是给整车品牌大行做车架代工的.所以也有人会说风行的车架是盗版的</p><p>车架也有几种不同的大类,我比较熟悉的有</p><h5 id="K架"><a href="#K架" class="headerlink" title="K架"></a>K架</h5><p><img src="https://static.wuhunyu.top/images/2025/09/2d4096e1f0e75695daa28890e9d03ea4.png" alt="K架"></p><h5 id="Y架"><a href="#Y架" class="headerlink" title="Y架"></a>Y架</h5><p><img src="https://static.wuhunyu.top/images/2025/09/0b16b75a92af279710ebdf3d0682d4af.png" alt="Y架"></p><h5 id="海豚架"><a href="#海豚架" class="headerlink" title="海豚架"></a>海豚架</h5><p><img src="https://static.wuhunyu.top/images/2025/09/08a4e801e50d801ed9a0387cb110af4b.png" alt="海豚架"></p><h5 id="蚂蚁架-蚂蚁腿"><a href="#蚂蚁架-蚂蚁腿" class="headerlink" title="蚂蚁架(蚂蚁腿)"></a>蚂蚁架(蚂蚁腿)</h5><p><img src="https://static.wuhunyu.top/images/2025/09/57cae7ed6c60b6843594b2439d6d843f.png" alt="蚂蚁腿"></p><p>以上都是风行的几款车架,你更喜欢哪一款呢</p><p>K架作为大行P8经典车型的同款车架,算是老大哥了</p><p>Y架多一条横梁,是这四款车架中刚性最好的</p><blockquote><p>什么是刚性呢?我简单理解为稳定性</p><p>折叠车由于折叠的特性,稳定性不如一体式车架</p><p>对于大体重的人来说,骑折叠车或许不是一个好选择</p></blockquote><p>海豚架是最有特点的一个车架,整个车身像是一个已经跃出海面的海豚</p><p>蚂蚁腿是我个人认为最漂亮的一款车架,电商平台把它归类到了复古风格的车架</p><h5 id="材质"><a href="#材质" class="headerlink" title="材质"></a>材质</h5><p>再说说车架的材质</p><p>风行的上述四个车架,除了蚂蚁腿是铬钼钢,其它的三款都是铝合金材质</p><p>在自行车领域,材质比较多为铝合金材质,这个材质在工业化的现在易加工成本比较低,有较好的稳定性</p><p>如果资金富裕,可以尝试进军碳纤维领域.富玩轮的轮说的就是碳纤维的轮组</p><p>碳纤维有很好的避震性能,它本身也具有不错的刚性,更重要的是,相比于铝,碳纤维可以大大降低整车的重量</p><p>还有钢架.一般而言,钢材是比较重的,折叠车为了加强车架的刚性,有些车型会选择铬钼钢作为车架材质,比如风行的蚂蚁腿车架</p><p>最后还有一种很小众的车架,钛金属车架.这个材质的车架成本和高级碳纤维应该是大差不差的.都是有钱人的玩具.据车友自述,钛架的避震性能很差,而且重,普通玩家不建议入手</p><h5 id="尺码"><a href="#尺码" class="headerlink" title="尺码"></a>尺码</h5><blockquote><p>先下一个结论,折叠车并没有尺码这个说法,至少我没没见到同一款车型可以选择不同尺码的折叠车</p></blockquote><p>尺码在公路车,山地车,瓜车中出现的比较多</p><p>下图是瓜车 骁风真挚 的车架尺码</p><img src="https://static.wuhunyu.top/images/2025/09/71c597a10e63055dff5710bc378610d7.png" alt="骁风真挚" style="zoom: 33%;" /><p>但折叠车也不是完全没有尺码,只不过折叠车的尺码不同于公路车的尺码</p><p>比如风行蚂蚁腿这个车架,有 <strong>FGD2018</strong> 和 <strong>FGD1618</strong> 两种</p><p><strong>FGD2018</strong> 安装 20 英寸和 21 英寸的轮组,一般安装 20 英寸</p><p><strong>FGD1618</strong> 安装 16 英寸和 17 英寸的轮组,一般安装 16 英寸</p><p>这个尺码会直接影响你的其它配件</p><h4 id="变速套件"><a href="#变速套件" class="headerlink" title="变速套件"></a>变速套件</h4><img src="https://static.wuhunyu.top/images/2025/09/61b8e29fd0f405fe32d0b6f0ad087618.png" alt="4700-1×10速中套件" style="zoom:50%;" /><h5 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h5><p>套件分为大中小大类</p><blockquote><p>它们包含的配件不一样,但具体包含了哪些配件没有统一的规定,甚至每个店家对于小中大套件的定义也是不一样的</p><p>购买的时候需要注意套件中包含的配件</p></blockquote><p>下面给出一个示例,不一定标准</p><table><thead><tr><th>套件</th><th>配件</th></tr></thead><tbody><tr><td>小套件</td><td>前拨 + 后拨 + 变速器 + 链条 + 飞轮</td></tr><tr><td>中套件</td><td>小套件 + 曲柄 + 牙盘 + 中轴</td></tr><tr><td>大套件</td><td>中套件 + 刹车碟片 + 刹把</td></tr></tbody></table><p>自行车套件逃不过的一个品牌是禧玛诺(SHIMANO),国内还有顺泰,蓝图等厂商</p><p>不过,据广大网友评价的结论,禧玛诺依旧还是第一梯队</p><p>接下来只简单说说禧玛诺</p><p>在公路车领域,禧玛诺有</p><ol><li>CLARIS</li><li>SORA</li><li>TIAGRA</li><li>105</li><li>ULTEGRA</li><li>DURA-ACE</li></ol><p>这六个等级,品质级别从低到高,普通骑友的套件天花板是105.理由是105摸到了ULTEGRA的绝大多数体验,但性价比比ULTEGRA高很多,被称为专业入门的套件</p><p>作为折叠车,我觉得上TIAGRA就行了</p><blockquote><p>如果你去自行车店购买自行车,店家宣称自己的车是禧玛诺的变速套件.希望你能询问老板自行车的哪些配件是禧玛诺,以及使用的是那个级别的禧玛诺套件</p></blockquote><p>为了有一个直观的感觉,我贴一个大概的价格</p><blockquote><p>价格表来源为淘宝,时间为 2025.09.14</p></blockquote><table><thead><tr><th>禧玛诺套件</th><th>价格 &#x2F; ¥</th></tr></thead><tbody><tr><td>TIAGRA 4700 小套件(中腿后拨 + 变速器 + 链条 + 飞轮)</td><td>410</td></tr><tr><td>TIAGRA 4700 中套件(中腿后拨 + 变速器 + 链条 + 飞轮 + 曲柄 + 牙盘(1 x 10速) + 中轴)</td><td>880</td></tr><tr><td>105 R7120 小套件(前拨 + 后拨 + 手变 + 夹器)</td><td>1,720</td></tr><tr><td>105 R7120 中套件(前拨 + 后拨 + 手变 + 夹器 + 链条 + 飞轮 + 曲柄 + 牙盘(2 x 12速))</td><td>2,350</td></tr></tbody></table><h4 id="内外胎"><a href="#内外胎" class="headerlink" title="内外胎"></a>内外胎</h4><p>其实主要讲的是外胎,内胎可讲的不多</p><h5 id="内胎"><a href="#内胎" class="headerlink" title="内胎"></a>内胎</h5><p>我知道的内胎材质有两种</p><p>传统的几丁质材料 和 TPU塑料材质</p><p>它们两的主要区别是</p><table><thead><tr><th>对比参数</th><th>几丁质</th><th>TPU</th></tr></thead><tbody><tr><td>重量</td><td>重</td><td>很轻</td></tr><tr><td>气密性</td><td>好</td><td>很差</td></tr><tr><td>稳定性</td><td>好</td><td>很差</td></tr></tbody></table><h5 id="外胎"><a href="#外胎" class="headerlink" title="外胎"></a>外胎</h5><p>先说说品牌</p><p>世文(SCHWALBE): 在防刺方面做的比较出色. 大行P8 用到的大苹果胎(Big Apple)就出自这个平台</p><p>德国马牌: 相对比较综合一些,防刺和竞速方面都不错</p><p>对于公路车而言,为了竞速,公路车的外胎通常会做的比较细,且胎面较薄,轮胎的胎压也会比较高,这么做是为了降低轮胎的滚阻,让自行车的气动性更佳</p><p>对于山地车而言,情况就不一样了,它们的轮胎一般又大又宽,胎面有很明显的花纹用来增加与地面的摩擦力,这么做是为了适应不同的路面环境</p><p>公路车为了速度,轮胎会做的细窄且胎压较高,但代价是公路车的轮胎更适合在路况良好的路面,对于路况差的路面来说,公路车的轮胎往往更容易出现爆胎,避震性差的问题</p><p>山地车为了适应性,轮胎做的又大又宽,代价是轮胎更重,滚阻更高</p><p>对于折叠车如何选择,我想这因人而异</p><p>但就像是在公路车和山地车之间,还有一种瓜车一样,多数折叠车的轮胎选择既不会像公路车那样激进,也不会像是山地车那样被要求适应复杂路况.所以我的选择是世文的马拉松plus系列</p><h4 id="坐管"><a href="#坐管" class="headerlink" title="坐管"></a>坐管</h4><img src="https://static.wuhunyu.top/images/2025/09/7c7e8f0e3d2762e7268b57d5d042c026.png" alt="坐管" style="zoom:60%;" /><p>坐管是 ai 强烈推荐我换成碳纤维的配件之一,理由是它能低成本避震</p><p>不过说是低成本,其实也是相对于碳前叉和碳车架来说</p><p>不过说到碳坐管,除了它避震和重量轻的优点,也有个缺点,碳纤维坐管更容易出现滑落的问题.所以你可能要加配<strong>双层坐管夹</strong>以及增加摩擦性的<strong>止滑剂</strong></p><p>个人推荐折叠车使用铝坐管即可</p><h4 id="头管"><a href="#头管" class="headerlink" title="头管"></a>头管</h4><img src="https://static.wuhunyu.top/images/2025/09/96225a9b90711f2cf6c1778558e30f76.png" alt="鹅颈头管" style="zoom:50%;" /><p>折叠车的头管也是可以折叠的</p><h5 id="折叠方式"><a href="#折叠方式" class="headerlink" title="折叠方式"></a>折叠方式</h5><p>按照折叠方式可以分为两种<strong>内折</strong>和<strong>外折</strong></p><p>据说<strong>外折</strong>头管会更不容易磕碰到车架</p><h5 id="拆卸方式"><a href="#拆卸方式" class="headerlink" title="拆卸方式"></a>拆卸方式</h5><p>按照拆卸方式,可以分为<strong>快拆</strong>,<strong>T型</strong>和<strong>双钉</strong></p><ul><li>快拆: 上图左一,左二,右三,右一都是快拆,意思是顶部有一个折叠扣可以徒手取下车把</li><li>T型: 这个了解的不多</li><li>双钉: 需要借助内六角扳手才能取下来车把,与它的安装和拆卸麻烦相比,稳定性要比快拆头管好不少</li></ul><h5 id="形状"><a href="#形状" class="headerlink" title="形状"></a>形状</h5><p>主要有两种形状,一种是上图这样弯弯的,叫<strong>鹅颈头管</strong></p><p>还有一种更常见的直立头管</p><img src="https://static.wuhunyu.top/images/2025/09/c93cd6981fe9dbfafde11e334712c981.png" alt="直立头管" style="zoom:40%;" /><h5 id="高度"><a href="#高度" class="headerlink" title="高度"></a>高度</h5><p>折叠自行车的坐管是很长的,可以自由调节,但头管的高度是不可变的,建议有条件可以先去一些自行车线下店(比如大行,迪卡侬等等)实际体验一下它们的整车并观察其头管的长度,寻找合适自己的高度</p><p>与头管一样,车把的长度我也是推荐在线下实际体验之后再确定</p><h4 id="刹车"><a href="#刹车" class="headerlink" title="刹车"></a>刹车</h4><h5 id="圈刹"><a href="#圈刹" class="headerlink" title="圈刹"></a>圈刹</h5><img src="https://static.wuhunyu.top/images/2025/09/3c45838b442fc12a064056382ed175c0.png" alt="圈刹" style="zoom:50%;" /><p>共享单车的刹车使用的就是这个</p><p>相对于碟刹来说,无论是购买成本还是维护成本都更低,缺点是刹车的制动性能一般都是不如碟刹的</p><h5 id="碟刹"><a href="#碟刹" class="headerlink" title="碟刹"></a>碟刹</h5><p>圈刹的刹车位置在轮组的轮圈上,碟刹的刹车位置在轮组轴承的碟片上</p><img src="https://static.wuhunyu.top/images/2025/09/ec64a3d3ef07b3184b30d86b246ff9e6.png" alt="碟刹" style="zoom:50%;" /><p>碟刹也分多种</p><h6 id="线拉碟"><a href="#线拉碟" class="headerlink" title="线拉碟"></a>线拉碟</h6><p>刹车的制动力通过拉动钢线来传导,有小部分人认为线拉碟调教得好甚至不逊于油碟</p><h6 id="油碟"><a href="#油碟" class="headerlink" title="油碟"></a>油碟</h6><p>刹车的制动力通过压迫线管中的油来传导</p><p>除了安装难度高,维护成本高,算是自行车领域刹车的王者</p><p>油碟刹车会比圈刹制动更短,意味着捏刹车不能一下捏死,不然在快速行驶时容易轮胎抱死摔车</p><h5 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h5><p>折叠车上推荐使用禧玛诺的 MT200油压碟刹 + 禧玛诺RT56油刹碟片</p><p>至于为什么,问就是大家都这么选,性价比和功用性在折叠车上都拉满了,甚至性能过剩</p><p>网上有传言说,折叠车上油刹维护成本高,因为折叠更容易导致油管漏油</p><p>关于这个问题,我咨询过一个五年骑友,他自组的折叠车都是油压碟刹,我想问题应该没那么大</p><h4 id="轮组"><a href="#轮组" class="headerlink" title="轮组"></a>轮组</h4><p>轮组我了解的不多</p><blockquote><p>需要注意的是,根据车架的尺寸(20英寸,16英寸比较常见)以及刹车系统(圈刹或者碟刹)的不同,选择的轮组也是不同的</p></blockquote><p>有一个有意思的轮组叫<strong>星芒轮组</strong>(下图左)</p><img src="https://static.wuhunyu.top/images/2025/09/52d770c1f4e4a589faede59c66737cdb.png" alt="星芒轮组 - 左" style="zoom:40%;" /><p>说是辐条的形状像是一个五芒星一样,辐条的减少可见降低风阻,但也一定程度上降低轮组的可靠性</p><p>另一个问题是星芒轮组会更贵一些</p><h4 id="车把"><a href="#车把" class="headerlink" title="车把"></a>车把</h4><img src="https://static.wuhunyu.top/images/2025/09/f63607d7c72b92629a39405a1f639745.png" alt="车把" style="zoom:40%;" /><p>和坐管一样, ai 认为这是低成本换碳车把,可以在避震和重量上带来很大收益的配件</p><p>我的建议是有钱可以上碳纤车把,预算吃紧还是用铝的吧</p><h4 id="坐垫"><a href="#坐垫" class="headerlink" title="坐垫"></a>坐垫</h4><img src="https://static.wuhunyu.top/images/2025/09/5e6fff9348a45ac38d83a2b0256b08f8.png" alt="坐垫" style="zoom:35%;" /><p>很多坐垫都做了中空处理,女士我不清楚.对于男士而言,骑行的姿势使得前列腺一直处于压迫状态</p><p>有过长时间骑车经验的男士小伙伴,应该都会感觉到下体发麻甚至短时间内没有知觉</p><p>骑行圈处理这个问题主要是四大措施</p><ol><li>坐垫.像是图中的坐垫一样中间留空,减少压迫</li><li>骑行裤.貌似是在裆部加了一层垫子</li><li>铁锭.多骑多练,让身体慢慢适应</li><li>换避震性能好的配件.比如碳车架,碳前叉甚至避震前叉等</li></ol><h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><h5 id="脚踏"><a href="#脚踏" class="headerlink" title="脚踏"></a>脚踏</h5><p>脚踏按材质分类,有普通塑料的,尼龙塑料的,金属的</p><p>我个人比较推荐尼龙塑料,金属虽然质感好,但折叠之后容易剐蹭到车身导致掉漆</p><img src="https://static.wuhunyu.top/images/2025/09/7cefaab2a4b0b27a3fff90b80bbb5ab0.png" alt="尼龙脚踏" style="zoom:50%;" /><p>还有一种是快拆类型的脚踏,也就是说脚踏可以徒手拆卸下来</p><p>不过这种脚踏会更重一些</p><img src="https://static.wuhunyu.top/images/2025/09/bb0c02d41aa6803f7e227fc12e01a741.png" alt="快拆脚踏" style="zoom:40%;" /><h5 id="B柱前转换座"><a href="#B柱前转换座" class="headerlink" title="B柱前转换座"></a>B柱前转换座</h5><blockquote><p>如果安装的是圈刹,就不需要这个小配件</p></blockquote><img src="https://static.wuhunyu.top/images/2025/09/1e50d6a12f92cd8759271314192274a9.png" alt="B柱前转换座" style="zoom:50%;" /><p>折叠车的车架前叉如果安装碟刹需要一个金属垫来垫高碟刹夹器</p><p>注意后轮一般不需要</p><h5 id="刹车线管套保护套-非必须"><a href="#刹车线管套保护套-非必须" class="headerlink" title="刹车线管套保护套(非必须)"></a>刹车线管套保护套(非必须)</h5><img src="https://static.wuhunyu.top/images/2025/09/7ef91a6439fb77a9d4908a9c5d1ca085.png" alt="刹车线管套保护套" style="zoom:40%;" /><p>用来束缚刹车线和变速线管的保护套,起到一个美观和保护的作用,可不用</p><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><h4 id="内六角扳手-必备"><a href="#内六角扳手-必备" class="headerlink" title="内六角扳手(必备)"></a>内六角扳手(必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/20730596d07b333ca87964b200d933a2.png" alt="内六角扳手" style="zoom:50%;" /><p>内六角属于是必备的工具,无论是安装还是维护,是比较常用的工具</p><p>对于常用的工具,推荐买一套材质比较好的,避免滑丝或者断裂</p><h4 id="苹果酱润滑脂-必备"><a href="#苹果酱润滑脂-必备" class="headerlink" title="苹果酱润滑脂(必备)"></a>苹果酱润滑脂(必备)</h4><blockquote><p>业内人士称它为苹果酱大概率是因为颜色吧</p></blockquote><img src="https://static.wuhunyu.top/images/2025/09/12d1aa0d177868503cbb4fa5ba68ef91.png" alt="苹果酱润滑脂" style="zoom:30%;" /><p>功效就如同图里说的,几乎所有金属零件的连接出处都可以来上一点,可以达到防水,润滑的作用</p><p>如果配件中还有碳纤维制品,还需要额外购买止滑剂增加摩擦力</p><h4 id="打气筒-必备"><a href="#打气筒-必备" class="headerlink" title="打气筒(必备)"></a>打气筒(必备)</h4><p>无须解释,有压力表显示的更佳</p><h4 id="链条截链器-必备"><a href="#链条截链器-必备" class="headerlink" title="链条截链器(必备)"></a>链条截链器(必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/01c6d4b773ec28feefe60ef7f821f5e5.png" alt="链条截链器" style="zoom:50%;" /><p>购买的链条一般都是偏长的,需要<strong>链条截链器</strong>截断几节链条之后通过魔术扣连接</p><h4 id="魔术扣钳子-非必备"><a href="#魔术扣钳子-非必备" class="headerlink" title="魔术扣钳子(非必备)"></a>魔术扣钳子(非必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/9cf28af15fc54e202f64672df8050a91.png" alt="魔术扣钳子" style="zoom:50%;" /><p>链条使用魔术扣连接之后,需要通过这个工具来夹紧</p><p>或者你也可以省略这个工具,通过大力踩踏脚踏让链条自然拉紧</p><h4 id="卡飞套筒-必备"><a href="#卡飞套筒-必备" class="headerlink" title="卡飞套筒(必备)"></a>卡飞套筒(必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/3aafb9a364964b82ef7279ef2959b408.png" alt="卡飞套筒" style="zoom:50%;" /><p>安装飞轮的工具,需要配合扳手一起使用</p><h4 id="活动扳手-必备"><a href="#活动扳手-必备" class="headerlink" title="活动扳手(必备)"></a>活动扳手(必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/39cc45effa9da2c22ba822228591e88a.png" alt="活动扳手" style="zoom:50%;" /><p>这家伙应该不会有人不认识吧</p><h4 id="卡飞扳手-非必备"><a href="#卡飞扳手-非必备" class="headerlink" title="卡飞扳手(非必备)"></a>卡飞扳手(非必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/2fea8a3f96f9d0fe9b28e29703ded402.png" alt="卡飞扳手" style="zoom:50%;" /><p>这个工具需要配合<strong>卡飞套筒</strong>一起使用</p><p>作用是用来固定飞轮.看到上面的链条了吗,使用链条卡住飞轮的齿轮以固定飞轮不转动</p><p>这个工具在拆卸飞轮时才需要,安装飞轮的时候必须</p><h4 id="中轴扳手-必备"><a href="#中轴扳手-必备" class="headerlink" title="中轴扳手(必备)"></a>中轴扳手(必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/fc67ca8f8e2824001ef2834984a5aeec.png" alt="中轴扳手" style="zoom:30%;" /><p>中轴扳手顾名思义是用来安装中轴的</p><p>禧玛诺和浩盟的许多中轴都只需要这个工具就可以完成安装</p><p>小部分中轴还需要用到<strong>中轴套筒</strong>,关于这一点可以向中轴的店家咨询是否需要<strong>中轴套筒</strong></p><img src="https://static.wuhunyu.top/images/2025/09/b33e1b50056c013c37709ca5b2a7a659.png" alt="中轴套筒" style="zoom:50%;" /><h4 id="碗组压入工具-非必备"><a href="#碗组压入工具-非必备" class="headerlink" title="碗组压入工具(非必备)"></a>碗组压入工具(非必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/d722c5e65853c095ab3765eabf251711.webp" alt="碗组压入工具" style="zoom:50%;" /><blockquote><p>购买车架的时候可以询问店家是否可以帮忙压入碗组(当然,你也需要在同一家店铺购买碗组),同意帮忙的话可以省下这个工具</p></blockquote><p>也有人大力出奇迹暴力压入碗组,只能说风险有点大,可能导致车架或者碗组报废</p><h4 id="电工胶带-非必备"><a href="#电工胶带-非必备" class="headerlink" title="电工胶带(非必备)"></a>电工胶带(非必备)</h4><img src="https://static.wuhunyu.top/images/2025/09/2ba87da7e01898b3b8be74c624eff532.png" alt="电工胶带" style="zoom:40%;" /><p>电工胶带的作用有很多</p><p>在安装刹车把和变速车把的时候,可以现在车把上缠一两圈胶带再固定安装刹车把和变速车把会更佳</p><h3 id="个人组装配置单"><a href="#个人组装配置单" class="headerlink" title="个人组装配置单"></a>个人组装配置单</h3><blockquote><p>配置单具有时效性,可能当你看到时已经过时,或者已经有更合适的配置</p><p>同时也具有强主观性,选择某一个配件只因我的喜好</p></blockquote><h4 id="折叠自行车配置单"><a href="#折叠自行车配置单" class="headerlink" title="折叠自行车配置单"></a>折叠自行车配置单</h4><blockquote><p>参考价格均来自 淘宝,时间为 2025.09.14</p></blockquote><table><thead><tr><th>配件名称</th><th>规格</th><th>备注</th><th>参考价格 &#x2F; ¥</th></tr></thead><tbody><tr><td>车架 风行FGD2018碟刹 蚂蚁架</td><td>黑金</td><td></td><td>1247</td></tr><tr><td>变速套件</td><td>TIAGRA 4700小套件</td><td></td><td>395</td></tr><tr><td>- 飞轮</td><td></td><td></td><td></td></tr><tr><td>- 指拨</td><td></td><td></td><td></td></tr><tr><td>- 后拨</td><td></td><td>28T飞轮短腿</td><td></td></tr><tr><td>- 链条</td><td></td><td></td><td></td></tr><tr><td>内外胎</td><td></td><td>数量 * 2</td><td>213.4 * 2</td></tr><tr><td>- 世文马拉松PLUS</td><td>20*1.35</td><td></td><td></td></tr><tr><td>- AV6美嘴内胎</td><td></td><td></td><td></td></tr><tr><td>坐管 MaxtroN美壮 Tower5</td><td>黑色</td><td></td><td>86.2</td></tr><tr><td>头管</td><td>黑色-双钉外折(31.5cm)</td><td>鹅颈头管</td><td>172.66</td></tr><tr><td>刹车</td><td></td><td></td><td></td></tr><tr><td>- 碟片 禧玛诺 RT56</td><td>160mm * 2</td><td></td><td>80</td></tr><tr><td>- 油刹 禧玛诺MT200油压碟刹</td><td>油管长100-170cm</td><td>购买前请咨询店家油管长度,避免不必要的截管</td><td>185</td></tr><tr><td>轮组 EIOSIX犀牛 中刀碟刹</td><td>406 全黑色 * 2</td><td>406 代表轮组的轮径,表示20英寸; 451 表示 21 英寸</td><td>466.98</td></tr><tr><td>车把 MaxtroN美壮Needle5</td><td>黑色 25.4*500mm短直把</td><td>车把长度建议线下体验之后解决</td><td>74.8</td></tr><tr><td>坐垫 SELLE ROYAL 自行车座垫</td><td>treking旅行款</td><td></td><td>77.4</td></tr><tr><td>脚踏 尼龙脚踏</td><td>三培林脚踏 橘色</td><td></td><td>62.74</td></tr><tr><td>中轴 + 曲柄 + 盘片 + 盘钉 prowheel浩盟</td><td></td><td>有没有盘钉需要执行咨询店家,没有需要额外购买</td><td>189.38</td></tr><tr><td>- 中轴</td><td>中空</td><td></td><td></td></tr><tr><td>- 曲柄</td><td>170曲柄</td><td></td><td></td></tr><tr><td>- 盘片</td><td>52T盘片</td><td></td><td></td></tr><tr><td>- 盘钉</td><td></td><td></td><td></td></tr><tr><td>碗组 MaxtroN美壮</td><td>红色</td><td>也可以换成<strong>景晔</strong>的碗组.买前咨询店家是否可以帮忙压入碗组再发货</td><td>68.6</td></tr><tr><td>把套 美国ODI橡胶肉球</td><td>红色</td><td></td><td>18.25</td></tr><tr><td>碟刹转换座 禧玛诺</td><td>160MM-B柱前转换座</td><td></td><td>10</td></tr><tr><td>脚撑</td><td>20寸黑色</td><td>非必须</td><td>48</td></tr><tr><td>折叠自行车磁铁</td><td></td><td>非必须,折叠之后避免车架散开</td><td>11.13</td></tr><tr><td>刹车线管套保护套</td><td>12mm红色 2米</td><td>非必须,固定,美观刹车和变速线管</td><td>24.1</td></tr><tr><td>合计</td><td></td><td></td><td><strong>3644.04</strong></td></tr></tbody></table><h4 id="折叠自行车组装工具配置单"><a href="#折叠自行车组装工具配置单" class="headerlink" title="折叠自行车组装工具配置单"></a>折叠自行车组装工具配置单</h4><blockquote><p>参考价格均来自 淘宝,时间为 2025.09.14</p></blockquote><table><thead><tr><th>配件名称</th><th>规格</th><th>备注</th><th>参考价格 &#x2F; ¥</th></tr></thead><tbody><tr><td>内六角扳手</td><td>S2钢材</td><td></td><td>35</td></tr><tr><td>苹果酱润滑脂</td><td>50克</td><td></td><td>17.91</td></tr><tr><td>打气筒</td><td>气压表 + 多功能气针</td><td>脚踩式</td><td>30.9</td></tr><tr><td>中轴扳手</td><td>TL-BB01扳手</td><td>注意与中轴的适配,请在购买前咨询店家是否适配你所购买的中轴</td><td>25</td></tr><tr><td>魔术扣钳子</td><td></td><td></td><td>8.8</td></tr><tr><td>链条截链器 + 卡飞套筒 + 卡飞扳手</td><td></td><td>只是安装可以不需要卡飞扳手,卡飞扳手只在拆卸时有用</td><td>32</td></tr><tr><td>碗组压入工具</td><td>简约款</td><td>非必须.购买车架时,请咨询店家是否可以帮忙压入碗组.可省略此工具</td><td>28</td></tr><tr><td>活动扳手</td><td>10寸开口35mm</td><td></td><td>13.6</td></tr><tr><td>电工胶带</td><td>黑色1卷30米</td><td>非必须</td><td>3.9</td></tr><tr><td>总计</td><td></td><td></td><td><strong>195.11</strong></td></tr></tbody></table><h3 id="附表"><a href="#附表" class="headerlink" title="附表"></a>附表</h3><h4 id="配件简图"><a href="#配件简图" class="headerlink" title="配件简图"></a>配件简图</h4><table><thead><tr><th>配件</th><th>简图</th></tr></thead><tbody><tr><td>车架</td><td><img src="https://static.wuhunyu.top/images/2025/09/57cae7ed6c60b6843594b2439d6d843f.png" alt="车架" style="zoom:40%;" /></td></tr><tr><td>前叉</td><td><img src="https://static.wuhunyu.top/images/2025/09/ceaac5ebcaaa7081de8d4622e0ea9b1a.png" alt="前叉" style="zoom:35%;" /></td></tr><tr><td>车把</td><td><img src="https://static.wuhunyu.top/images/2025/09/f63607d7c72b92629a39405a1f639745.png" alt="车把" style="zoom:20%;" /></td></tr><tr><td>把套</td><td><img src="https://static.wuhunyu.top/images/2025/09/a3cb36d1e4d3af77d2ad49f0c8fb6b68.png" alt="把套" style="zoom:25%;" /></td></tr><tr><td>头管</td><td><img src="https://static.wuhunyu.top/images/2025/09/0189f9e02d350b5e3079a3a56d3014b7.png" alt="头管" style="zoom:25%;" /></td></tr><tr><td>碗组</td><td><img src="https://static.wuhunyu.top/images/2025/09/df2cdad235553fad9cb381e043f75693.png" alt="碗组" style="zoom:25%;" /></td></tr><tr><td>坐管</td><td><img src="https://static.wuhunyu.top/images/2025/09/7c7e8f0e3d2762e7268b57d5d042c026.png" alt="坐管" style="zoom:35%;" /></td></tr><tr><td>坐垫</td><td><img src="https://static.wuhunyu.top/images/2025/09/5e6fff9348a45ac38d83a2b0256b08f8.png" alt="坐垫" style="zoom:35%;" /></td></tr><tr><td>脚撑</td><td><img src="https://static.wuhunyu.top/images/2025/09/924332c6012b4f196f7debde59715210.png" alt="脚撑" style="zoom:20%;" /></td></tr><tr><td>脚踏</td><td><img src="https://static.wuhunyu.top/images/2025/09/fd077e553262a5e438ae651b44b6830b.png" alt="脚踏" style="zoom:25%;" /></td></tr><tr><td>曲柄</td><td><img src="https://static.wuhunyu.top/images/2025/09/09ced9b7798114a3cde090b836415a0f.png" alt="曲柄" style="zoom:25%;" /></td></tr><tr><td>链条</td><td><img src="https://static.wuhunyu.top/images/2025/09/305a7afbccdf2505e4c3629553c15690.png" alt="链条" style="zoom:20%;" /></td></tr><tr><td>飞轮</td><td><img src="https://static.wuhunyu.top/images/2025/09/19c51e7a2e70202ba2597034fcba99eb.png" alt="飞轮" style="zoom:25%;" /></td></tr><tr><td>后拨</td><td><img src="https://static.wuhunyu.top/images/2025/09/a310d3bf62841aebdebadeed5cfe5481.png" alt="后拨" style="zoom:25%;" /></td></tr><tr><td>指拨</td><td><img src="https://static.wuhunyu.top/images/2025/09/011633bfe8086dcbe31d622073193565.png" alt="指拨" style="zoom:25%;" /></td></tr><tr><td>油刹</td><td><img src="https://static.wuhunyu.top/images/2025/09/c49ac97eca09a9ea14478ab035102249.png" alt="油刹" style="zoom:20%;" /></td></tr><tr><td>刹车片</td><td><img src="https://static.wuhunyu.top/images/2025/09/6ef1a14b2cc8d2c7a7ffa69ef35daa84.png" alt="刹车片" style="zoom:17%;" /></td></tr><tr><td>外胎</td><td><img src="https://static.wuhunyu.top/images/2025/09/e0843c6010b006a4f253eb59c20d3b7e.png" alt="外胎" style="zoom:25%;" /></td></tr><tr><td>内胎</td><td><img src="https://static.wuhunyu.top/images/2025/09/508f0dc01fa9c7e0b438362b934bba80.png" alt="内胎" style="zoom:35%;" /></td></tr><tr><td>轮组</td><td><img src="https://static.wuhunyu.top/images/2025/09/572c74d7ede93bd904d475207d3d4717.png" alt="轮组" style="zoom:25%;" /></td></tr><tr><td>碟刹转换座</td><td><img src="https://static.wuhunyu.top/images/2025/09/7f73419d69d98dc0ae42a661392ba278.png" alt="碟刹转换座" style="zoom:25%;" /></td></tr><tr><td>折叠自行车磁铁</td><td><img src="https://static.wuhunyu.top/images/2025/09/aca166d1df1262486c95e30a5d9863be.png" alt="折叠自行车磁铁" style="zoom:25%;" /></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;前几个月对折叠自行车比较感兴趣,通过视频,网络好友,配件卖家等渠道了解到了一些自组折叠自行车的相关知识&lt;/p&gt;
&lt;p&gt;写一篇博客记录分享一下&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这部分知识和组装折叠自行车强相关&lt;/p&gt;
&lt;p&gt;知识比较偏向于理论,并没有实践来验证&lt;/p&gt;
&lt;p&gt;强烈建议想要了解自组折叠车的朋友转到&lt;strong&gt;附表-配件简图&lt;/strong&gt;先认识一下各个配件的样子&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="折叠自行车" scheme="https://wuhunyu.top/categories/%E6%8A%98%E5%8F%A0%E8%87%AA%E8%A1%8C%E8%BD%A6/"/>
    
    
    <category term="自组" scheme="https://wuhunyu.top/tags/%E8%87%AA%E7%BB%84/"/>
    
  </entry>
  
  <entry>
    <title>浅谈 @EventListener 和 @TransactionalEventListener</title>
    <link href="https://wuhunyu.top/chat/2025/08/event-listener/index.html"/>
    <id>https://wuhunyu.top/chat/2025/08/event-listener/index.html</id>
    <published>2025-08-20T09:46:00.000Z</published>
    <updated>2026-01-07T07:38:46.861Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>spring 有一个事件传播机制,可以较为方便地实现一个简单的广播模型</p><p>一般使用 <code>ApplicationEventPublisher</code>(org.springframework.context.ApplicationEventPublisher) 来发布一个事件,然后使用 <code>@EventListener</code> 或者 <code>@TransactionalEventListener</code> 标记的方法来接收指定的事件</p><p>这样做有什么好处呢?一方面是解耦,另一方面提高可拓展性</p><span id="more"></span><h3 id="EventListener-使用"><a href="#EventListener-使用" class="headerlink" title="@EventListener 使用"></a>@EventListener 使用</h3><p>我一般会这样使用</p><h5 id="事件定义"><a href="#事件定义" class="headerlink" title="事件定义"></a>事件定义</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">UserUpdateEvent</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="事件发布者-xxxService-中"><a href="#事件发布者-xxxService-中" class="headerlink" title="事件发布者: xxxService 中"></a>事件发布者: xxxService 中</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 其他业务逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布一个 用户修改 事件</span></span><br><span class="line">    publisher.publishEvent(UserUpdateEvent.builder()</span><br><span class="line">            .id(userId)</span><br><span class="line">            .build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="监听器-xxxListener-中"><a href="#监听器-xxxListener-中" class="headerlink" title="监听器: xxxListener 中"></a>监听器: xxxListener 中</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventListener(UserUpdateEvent.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUserUpdate</span><span class="params">(<span class="keyword">final</span> UserUpdateEvent userUpdateEvent)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;onUserUpdate listener: &#123;&#125;&quot;</span>, userUpdateEvent.id());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这种的用法中,但发布者发布事件之后,就会触发该事件的所有监听器,并在同一个线程中,一个一个地执行监听器的动作,最后才返回到发布事件的位置继续往下执行</p><blockquote><p>如果想要执行执行监听器而不影响主流程,可以配合 @Async 注解实现异步</p></blockquote><h4 id="EventListener-不适用场景"><a href="#EventListener-不适用场景" class="headerlink" title="@EventListener 不适用场景"></a>@EventListener 不适用场景</h4><p>试想一下这样一个场景</p><p>如果事件发布时处于处于一个数据库事务当中,同步监听这个事件的监听器发出了一个异步通知给第三方系统,第三方系统接收到这个通知之后需要回查状态.那么使用上面的方案可能会遇到什么问题</p><ul><li><input checked="" disabled="" type="checkbox"> 第三方系统回查状态时,事件发布者所在的事务已经完成提交</li><li><input disabled="" type="checkbox"> 第三方系统回查状态时,事件发布者所在的事务还未提交</li></ul><p>回查时事件发布者所在的事务还未提交,那么就可能查询到旧数据,导致数据不一致</p><p><img src="https://static.wuhunyu.top/images/2025/08/2f4de54806d65114e7de332b5c6812cd.png" alt="回查状态不一致"></p><p>想要解决这个问题,有哪些处理方案呢?</p><ol><li>使用手动事务,在提交之后再发布事件</li><li>使用 @TransactionalEventListener 注解,使监听器在事务提交后再执行</li><li>本地消息表.适用于最终一致性场景</li></ol><p><strong>方案1</strong> 我在实践中遇到一个问题</p><p>一般而言, spring 的事务传播机制是 <code>Propagation.REQUIRED</code>,通俗来讲就是有事务时加入,没事务时新建一个事务</p><p>在上面的例子中,如果 <code>updateUser</code> 的调用者已经处于一个事务之中,那么 <code>updateUser</code> 便会加入这个事务</p><p>也就是在这种场景下说这个事务的边界并非时我们在 <strong>方案1</strong> 预想的那样,等待 <code>updateUser</code> 执行完毕之后,事务就被提交了.那么监听器仍然是有可能在一个事务之中被执行</p><p>将事务传播机制换成 <code>Propagation.REQUIRES_NEW</code> 也能解决这个问题,但这个改动不一定符合实际使用场景是吧</p><p><strong>方案2</strong> 我重点说说</p><p>把原来的监听器改成如下这样,和之前的区别就是方法上的注解,它从 <code>@EventListener</code> 变成了 <code>@TransactionalEventListener</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TransactionalEventListener(value = UserUpdateEvent.class, phase = TransactionPhase.AFTER_COMMIT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUserUpdate</span><span class="params">(<span class="keyword">final</span> UserUpdateEvent userUpdateEvent)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;onUserUpdate listener: &#123;&#125;&quot;</span>, userUpdateEvent.id());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>来看看这个注解的定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TransactionalEventListener &#123;</span><br><span class="line"></span><br><span class="line">    TransactionPhase <span class="title function_">phase</span><span class="params">()</span> <span class="keyword">default</span> TransactionPhase.AFTER_COMMIT;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">fallbackExecution</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(annotation = EventListener.class, attribute = &quot;classes&quot;)</span></span><br><span class="line">    Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(annotation = EventListener.class, attribute = &quot;classes&quot;)</span></span><br><span class="line">    Class&lt;?&gt;[] classes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(annotation = EventListener.class, attribute = &quot;condition&quot;)</span></span><br><span class="line">    String <span class="title function_">condition</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(annotation = EventListener.class, attribute = &quot;id&quot;)</span></span><br><span class="line">    String <span class="title function_">id</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是个复合注解,它扩展了 <code>@EventListener</code></p><p>比较重要的属性是</p><ul><li>phase: 定义监听器的执行时机,可以配置成 <code>BEFORE_COMMIT</code>, <code>AFTER_COMMIT</code>, <code>AFTER_ROLLBACK</code>, <code>AFTER_COMPLETION</code> 四种.四个配置项基本都能见名知意,最后一个 <code>AFTER_COMPLETION</code> 的意思是无法事务执行成功与否都会执行监听器的动作</li><li>fallbackExecution: <code>@TransactionalEventListener</code> 比 <code>@EventListener</code> 更加特别的一个地方是,如果事件的发布者没有处于一个事务中,默认不会触发监听器的动作.但如果配置 <code>fallbackExecution</code> 为 <code>true</code>,那么在无事务时发布事件,也可以触发监听器</li><li>value 和 classes: 这两互为别名,和 <code>@EventListener</code> 中是一样的,表示监听的事件类型</li></ul><p><strong>方案3</strong> 就不讲了, spring 的事件机制不支持持久化,也不支持分布式,使用本地消息表方案建议配合 mq 食用</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p><code>@EventListener</code> 适合用在无事务,或者不关心监听器的执行与事件发布者处于同一个事务中的场景</p><p><code>@TransactionalEventListener</code> 适合用在存在事务,且需要控制监听器在事务执行的某个阶段(<code>BEFORE_COMMIT</code>, <code>AFTER_COMMIT</code>, <code>AFTER_ROLLBACK</code>, <code>AFTER_COMPLETION</code> )执行的场景</p><p>问题解决,如果使用 <code>@EventListener</code> 和 <code>@TransactionalEventListener</code> 同时监听同一个事件,会怎么样呢</p><p>首先,需要明确一个前提,同时使用 <code>@EventListener</code> 和 <code>@TransactionalEventListener</code> 意味着发布事件的时机在事务中(<code>@TransactionalEventListener</code> 也可以用在非事务环境,但一般不会这样使用吧),那么可以确认了,<code>@EventListener</code> 的监听器会先于 <code>@TransactionalEventListener</code>  被执行</p><p>理由是 <code>@EventListener</code> 的监听器总是在发布事件之后就被触发,而此时事务仍然处于未提交状态</p><h3 id="EventListener-的原理"><a href="#EventListener-的原理" class="headerlink" title="@EventListener 的原理"></a>@EventListener 的原理</h3><h4 id="注册-ApplicationListener"><a href="#注册-ApplicationListener" class="headerlink" title="注册 ApplicationListener"></a>注册 ApplicationListener</h4><p>在 spring 容器启动时,会将标记了 <code>@EventListener</code> 的方法包装成一个 <code>ApplicationListener</code> 对象存放到容器中</p><p><code>ApplicationListener</code> 中包含了监听器被触发是需要执行的动作,也就是 <code>onApplicationEvent</code> 方法</p><p>在 <code>ApplicationListenerMethodAdapter</code>(org.springframework.context.event.ApplicationListenerMethodAdapter) 中,它的 <code>onApplicationEvent</code>  方法如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">  <span class="comment">// 触发监听器动作</span></span><br><span class="line">  processEvent(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">  <span class="comment">// 解析参数</span></span><br><span class="line">  Object[] args = resolveArguments(event);</span><br><span class="line">  <span class="comment">// 根据 condition 属性判断是否需要触发</span></span><br><span class="line">  <span class="keyword">if</span> (shouldHandle(event, args)) &#123;</span><br><span class="line">    <span class="comment">// 反射执行监听器动作</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> doInvoke(args);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">      handleResult(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;No result object given - no result to handle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="再看一下事件的发布者做了什么"><a href="#再看一下事件的发布者做了什么" class="headerlink" title="再看一下事件的发布者做了什么"></a>再看一下事件的发布者做了什么</h4><p>在 <code>SimpleApplicationEventMulticaster</code>(org.springframework.context.event.SimpleApplicationEventMulticaster) 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multicastEvent</span><span class="params">(ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> &#123;</span><br><span class="line">  <span class="type">ResolvableType</span> <span class="variable">type</span> <span class="operator">=</span> (eventType != <span class="literal">null</span> ? eventType : ResolvableType.forInstance(event));</span><br><span class="line">  <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> getTaskExecutor();</span><br><span class="line">  <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (executor != <span class="literal">null</span> &amp;&amp; listener.supportsAsyncExecution()) &#123;</span><br><span class="line">      <span class="comment">// 异步执行</span></span><br><span class="line">      executor.execute(() -&gt; invokeListener(listener, event));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 同步执行</span></span><br><span class="line">      invokeListener(listener, event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="根据事件类型取出所有的监听器"><a href="#根据事件类型取出所有的监听器" class="headerlink" title="根据事件类型取出所有的监听器"></a>根据事件类型取出所有的监听器</h4><blockquote><p>这里的源码我也没太看明白,但逻辑就是根据<strong>事件类型</strong>取出监听器</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners(</span><br><span class="line">    ApplicationEvent event, ResolvableType eventType) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">Object</span> <span class="variable">source</span> <span class="operator">=</span> event.getSource();</span><br><span class="line">  Class&lt;?&gt; sourceType = (source != <span class="literal">null</span> ? source.getClass() : <span class="literal">null</span>);</span><br><span class="line">  <span class="type">ListenerCacheKey</span> <span class="variable">cacheKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListenerCacheKey</span>(eventType, sourceType);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Potential new retriever to populate</span></span><br><span class="line">  <span class="type">CachedListenerRetriever</span> <span class="variable">newRetriever</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Quick check for existing entry on ConcurrentHashMap</span></span><br><span class="line">  <span class="type">CachedListenerRetriever</span> <span class="variable">existingRetriever</span> <span class="operator">=</span> <span class="built_in">this</span>.retrieverCache.get(cacheKey);</span><br><span class="line">  <span class="keyword">if</span> (existingRetriever == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Caching a new ListenerRetriever if possible</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.beanClassLoader == <span class="literal">null</span> ||</span><br><span class="line">        (ClassUtils.isCacheSafe(event.getClass(), <span class="built_in">this</span>.beanClassLoader) &amp;&amp;</span><br><span class="line">            (sourceType == <span class="literal">null</span> || ClassUtils.isCacheSafe(sourceType, <span class="built_in">this</span>.beanClassLoader)))) &#123;</span><br><span class="line">      newRetriever = <span class="keyword">new</span> <span class="title class_">CachedListenerRetriever</span>();</span><br><span class="line">      existingRetriever = <span class="built_in">this</span>.retrieverCache.putIfAbsent(cacheKey, newRetriever);</span><br><span class="line">      <span class="keyword">if</span> (existingRetriever != <span class="literal">null</span>) &#123;</span><br><span class="line">        newRetriever = <span class="literal">null</span>;  <span class="comment">// no need to populate it in retrieveApplicationListeners</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (existingRetriever != <span class="literal">null</span>) &#123;</span><br><span class="line">    Collection&lt;ApplicationListener&lt;?&gt;&gt; result = existingRetriever.getApplicationListeners();</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If result is null, the existing retriever is not fully populated yet by another thread.</span></span><br><span class="line">    <span class="comment">// Proceed like caching wasn&#x27;t possible for this current local attempt.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> retrieveApplicationListeners(eventType, sourceType, newRetriever);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="然后循环挨个触发监听器动作"><a href="#然后循环挨个触发监听器动作" class="headerlink" title="然后循环挨个触发监听器动作"></a>然后循环挨个触发监听器动作</h4><p>一路追下去,可以在 <code>invokeListener</code> -&gt; <code>doInvokeListener</code> -&gt; <code>listener.onApplicationEvent(event)</code> 看到 <code>onApplicationEvent</code> 被触发了.完成了一个闭环</p><h3 id="TransactionalEventListener-的原理"><a href="#TransactionalEventListener-的原理" class="headerlink" title="@TransactionalEventListener 的原理"></a>@TransactionalEventListener 的原理</h3><p>上面说的是 @EventListener 的原理,那么 @TransactionalEventListener 会怎么样呢</p><p>它们区别在于注册监听器类型不一样</p><p><code>@EventListener</code> 使用了 <code>ApplicationListenerMethodAdapter</code> 包装它的执行动作</p><p><code>@TransactionalEventListener</code> 使用了 <code>TransactionalApplicationListenerMethodAdapter</code> 包装它的执行动作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TransactionalApplicationListenerMethodAdapter 继承了 ApplicationListenerMethodAdapter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionalApplicationListenerMethodAdapter</span> <span class="keyword">extends</span> <span class="title class_">ApplicationListenerMethodAdapter</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">TransactionalApplicationListener</span>&lt;ApplicationEvent&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><p>此外, <code>TransactionalApplicationListenerMethodAdapter</code> 额外保存了 <code>@TransactionalEventListener</code> 注解特有的 <code>transactionPhase</code> 和 <code>fallbackExecution</code> 属性</p><p><code>TransactionalApplicationListenerMethodAdapter</code> 还重写了 <code>onApplicationEvent</code> 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (TransactionalApplicationListenerSynchronization.register(event, <span class="built_in">this</span>, <span class="built_in">this</span>.callbacks)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Registered transaction synchronization for &quot;</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.fallbackExecution) &#123;</span><br><span class="line">    <span class="keyword">if</span> (getTransactionPhase() == TransactionPhase.AFTER_ROLLBACK &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">      logger.warn(<span class="string">&quot;Processing &quot;</span> + event + <span class="string">&quot; as a fallback execution on AFTER_ROLLBACK phase&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    processEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No transactional event execution at all</span></span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;No transaction is active - skipping &quot;</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最重要的就是 <code>TransactionalApplicationListenerSynchronization.register(event, this, this.callbacks)</code></p><p>它依赖了 spring 事务,注册了一个事件,方便在事务的生命周期内执行注册的动作. <code>register</code> 方法会判断当前是否处于一个事务中,如果不处于事务中,则会返回 <code>false</code></p><p>如果事务未开启,则会进入第二个 <strong>if</strong> 判断,即 <code>fallbackExecution</code> 设置为 <code>true</code> 时,即便没有事务也会执行</p><p>否则,什么都不做</p><h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>对比 <code>@EventListener</code> 和 <code>@TransactionalEventListener</code>,会发现,其实这两在底层代码上的区别并不是很大.</p><p><code>@TransactionalEventListener</code> 的主流程和 <code>@EventListener</code> 大差不差</p><blockquote><ol><li><p>spring 启动时注册 监听器 为 ApplicationListener</p></li><li><p>事件发布者发布事件,触发 onApplicationEvent 方法</p></li><li><p>反射调用 监听器方法</p></li></ol></blockquote><p>区别在于 <code>@TransactionalEventListener</code> 在触发 <code>onApplicationEvent</code> 时通过 <code>TransactionalApplicationListenerSynchronization.register</code> 将监听器事件注册给了事务管理器,之后的触发逻辑就由事务管理器来负责了</p><h3 id="TransactionalApplicationListenerSynchronization"><a href="#TransactionalApplicationListenerSynchronization" class="headerlink" title="TransactionalApplicationListenerSynchronization"></a>TransactionalApplicationListenerSynchronization</h3><p>最后我们来看看 <code>TransactionalApplicationListenerSynchronization</code> 的 <code>register</code> 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span>&gt; <span class="type">boolean</span> <span class="title function_">register</span><span class="params">(</span></span><br><span class="line"><span class="params">      E event, TransactionalApplicationListener&lt;E&gt; listener,</span></span><br><span class="line"><span class="params">      List&lt;TransactionalApplicationListener.SynchronizationCallback&gt; callbacks)</span> &#123;</span><br><span class="line">  <span class="comment">// 事务处于执行状态</span></span><br><span class="line">  <span class="keyword">if</span> (TransactionSynchronizationManager.isSynchronizationActive() &amp;&amp; TransactionSynchronizationManager.isActualTransactionActive()) &#123;</span><br><span class="line">    TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> <span class="title class_">PlatformSynchronization</span>&lt;&gt;(event, listener, callbacks));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 和响应式事务有关</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (event.getSource() <span class="keyword">instanceof</span> TransactionContext txContext) &#123;</span><br><span class="line">    <span class="type">TransactionSynchronizationManager</span> <span class="variable">rtsm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionSynchronizationManager</span>(txContext);</span><br><span class="line">    <span class="keyword">if</span> (rtsm.isSynchronizationActive() &amp;&amp; rtsm.isActualTransactionActive()) &#123;</span><br><span class="line">      rtsm.registerSynchronization(<span class="keyword">new</span> <span class="title class_">ReactiveSynchronization</span>&lt;&gt;(event, listener, callbacks));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我的环境使用的是普通的事务,走第一个 <strong>if</strong> 判断.如果事务处于执行状态,则将监听器事件包装起来并注册到事务管理器中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerSynchronization</span><span class="params">(TransactionSynchronization synchronization)</span></span><br><span class="line">    <span class="keyword">throws</span> IllegalStateException &#123;</span><br><span class="line">  Assert.notNull(synchronization, <span class="string">&quot;TransactionSynchronization must not be null&quot;</span>);</span><br><span class="line">  Set&lt;TransactionSynchronization&gt; synchs = synchronizations.get();</span><br><span class="line">  <span class="keyword">if</span> (synchs == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Transaction synchronization is not active&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  synchs.add(synchronization);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后面的触发实际就有 spring 事务管理了</p><p>再看看提交给事务管理器的 <code>PlatformSynchronization</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PlatformSynchronization</span>&lt;AE <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span>&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">TransactionalApplicationListenerSynchronization</span>&lt;AE&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">org</span>.springframework.transaction.support.TransactionSynchronization &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">PlatformSynchronization</span><span class="params">(AE event, TransactionalApplicationListener&lt;AE&gt; listener,</span></span><br><span class="line"><span class="params">      List&lt;TransactionalApplicationListener.SynchronizationCallback&gt; callbacks)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(event, listener, callbacks);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeCommit</span><span class="params">(<span class="type">boolean</span> readOnly)</span> &#123;</span><br><span class="line">    <span class="comment">// 事务提交前</span></span><br><span class="line">    <span class="keyword">if</span> (getTransactionPhase() == TransactionPhase.BEFORE_COMMIT) &#123;</span><br><span class="line">      processEventWithCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">    <span class="type">TransactionPhase</span> <span class="variable">phase</span> <span class="operator">=</span> getTransactionPhase();</span><br><span class="line">    <span class="comment">// 事务提交后</span></span><br><span class="line">    <span class="keyword">if</span> (phase == TransactionPhase.AFTER_COMMIT &amp;&amp; status == STATUS_COMMITTED) &#123;</span><br><span class="line">      processEventWithCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 事务回滚</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (phase == TransactionPhase.AFTER_ROLLBACK &amp;&amp; status == STATUS_ROLLED_BACK) &#123;</span><br><span class="line">      processEventWithCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 无论如何都执行</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (phase == TransactionPhase.AFTER_COMPLETION) &#123;</span><br><span class="line">      processEventWithCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>刚好处理了 <code>@TransactionalEventListener</code> 中 <code>phase</code> 的四个配置项</p><p>而它实现的接口 <code>TransactionSynchronization</code> 定义了事务的生命周期钩子方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionSynchronization</span> <span class="keyword">extends</span> <span class="title class_">Ordered</span>, Flushable &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">STATUS_COMMITTED</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">STATUS_ROLLED_BACK</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">STATUS_UNKNOWN</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">default</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">suspend</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">resume</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">beforeCommit</span><span class="params">(<span class="type">boolean</span> readOnly)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">beforeCompletion</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">afterCommit</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>本文简单阐述了 <code>@EventListener</code> 和 <code>@TransactionalEventListener</code> 的使用场景,以及区别,尝试结合源码来说明事件的发布流程</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;spring 有一个事件传播机制,可以较为方便地实现一个简单的广播模型&lt;/p&gt;
&lt;p&gt;一般使用 &lt;code&gt;ApplicationEventPublisher&lt;/code&gt;(org.springframework.context.ApplicationEventPublisher) 来发布一个事件,然后使用 &lt;code&gt;@EventListener&lt;/code&gt; 或者 &lt;code&gt;@TransactionalEventListener&lt;/code&gt; 标记的方法来接收指定的事件&lt;/p&gt;
&lt;p&gt;这样做有什么好处呢?一方面是解耦,另一方面提高可拓展性&lt;/p&gt;</summary>
    
    
    
    <category term="spring event" scheme="https://wuhunyu.top/categories/spring-event/"/>
    
    <category term="spring transaction" scheme="https://wuhunyu.top/categories/spring-event/spring-transaction/"/>
    
    
    <category term="java" scheme="https://wuhunyu.top/tags/java/"/>
    
    <category term="event" scheme="https://wuhunyu.top/tags/event/"/>
    
  </entry>
  
  <entry>
    <title>珂朵莉树</title>
    <link href="https://wuhunyu.top/chat/2025/08/odt/index.html"/>
    <id>https://wuhunyu.top/chat/2025/08/odt/index.html</id>
    <published>2025-08-07T09:39:00.000Z</published>
    <updated>2026-01-07T07:38:46.861Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>不知道你是否听说过一个叫<strong>珂朵莉树</strong>(ODT, Old Driver Tree)的”数据结构“，它有个名称：“老司机树”</p><span id="more"></span><p><strong>珂朵莉</strong>这个人物名称来源于日漫《末日时在做什么？有没有空？可以来拯救吗？》中的女主角，之所以叫<strong>珂朵莉树</strong>是因为被发布在 <a href="https://codeforces.com/">codeforces</a> 算法题背景人物中有珂朵莉</p><p>在<a href="https://www.luogu.com.cn/">洛谷</a>的题目<a href="https://www.luogu.com.cn/problem/CF896C">CF896C</a>中文翻译中，不仅把题目背景介绍移除了，连背景图也移除了，真是本末倒置</p><p><a href="https://en.oi-wiki.org/ds/odt/">wiki</a> 上对它的解释如下</p><blockquote><p>老司机树，ODT(Old Driver Tree)，又名珂朵莉树（Chtholly Tree)。起源自 <a href="https://codeforces.com/problemset/problem/896/C">CF896C</a>。</p><p>会用 STL 的 set 就行。</p><p>把值相同的区间合并成一个结点保存在 set 里面。</p></blockquote><p>这是一个基于 TreeMap 的暴力算法，用来解决一些<strong>区间赋值</strong>操作的数据结构题。在相对随机的数据场合，也堪堪能通过</p><p>几年前我刚在网络上偶然刷到相关的文章时，那时候我能找到的相关题解都还是基于 cpp 语言的，对 cpp 不熟悉成了我放弃理解这个算法的拦路虎</p><p>在现在大语言模型的帮助下，我重新理解了这个算法，并按自己的理解实现了 Java 版本和 Go 版本的 ODT</p><h4 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h4><p>先看题目要求</p><p><img src="https://static.wuhunyu.top/images/2025/08/f4172a1aa3fd9b6d79cd8d5852962137.png" alt="题目要求"></p><p>分别要求四个操作</p><ol><li>区间加</li><li>区间赋值</li><li>区间排序</li><li>区间求和</li></ol><p>我认为 ODT 树实现的核心就是，执行操作前，先按要执行的区间进行拆分</p><p>比如，区间 [left, right] 加操作，先以拆成以 left 起始的区间，再拆 right + 1 （以 right + 1为起始，就意味着必定有一个区间以 right 结尾）为起始的区间</p><p>拆完之后，就意味着在 [left, right] 这个大区间中，刚好会存在一个或者多个子区间在这个大区间内，而且这些子区间可以保证是大区间的子集</p><p>这样处理之后，只需要快速遍历这个大区间的所有子区间，就可以很方便地执行上面的四个操作</p><ol><li>对于操作1，每个子区间都加上给定的 val</li><li>对于操作2，直接移除所有的子区间，并新增一个区间，范围就是 [left, right]，值为给定的值</li><li>对于操作3，稍稍复杂一些，需要把所有子区间按 val 排序，然后找第 k 个值所在的区间</li><li>对于操作4，同样是遍历整个子区间，使用快速幂计算模</li></ol><p>对于查找子区间，由于 TreeMap 的特性，只需要<br>$$<br>O(log(n))<br>$$<br>的时间复杂度即可定位到起始区间</p><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ODT</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;TreeNode&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> left;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> val;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">TreeNode</span><span class="params">(<span class="type">int</span> left, <span class="type">int</span> right, <span class="type">long</span> val)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.left = left;</span><br><span class="line">            <span class="built_in">this</span>.right = right;</span><br><span class="line">            <span class="built_in">this</span>.val = val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">TreeNode</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> left)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.left = left;</span><br><span class="line">            <span class="built_in">this</span>.right = Integer.MIN_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(<span class="keyword">final</span> ODT.TreeNode o)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(<span class="built_in">this</span>.left, o.left);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="keyword">final</span> Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">TreeNode</span> <span class="variable">treeNode</span> <span class="operator">=</span> (TreeNode) o;</span><br><span class="line">            <span class="keyword">return</span> left == treeNode.left &amp;&amp; right == treeNode.right &amp;&amp; val == treeNode.val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hash(left, right, val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TreeSet&lt;TreeNode&gt; tree = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ODT</span><span class="params">(<span class="type">long</span>[] data)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(data, <span class="string">&quot;input data is null&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> data.length;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">pre</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[i] != data[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="built_in">this</span>.tree.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(pre, i - <span class="number">1</span>, data[i - <span class="number">1</span>]));</span><br><span class="line">                pre = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.tree.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(pre, n - <span class="number">1</span>, data[n - <span class="number">1</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">split</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">floor</span> <span class="operator">=</span> tree.floor(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(index));</span><br><span class="line">        <span class="keyword">if</span> (floor == <span class="literal">null</span> || floor.left == index || floor.right &lt; index) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tree.remove(floor);</span><br><span class="line">        tree.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(floor.left, index - <span class="number">1</span>, floor.val));</span><br><span class="line">        tree.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(index, floor.right, floor.val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> left, <span class="keyword">final</span> <span class="type">int</span> right, <span class="keyword">final</span> <span class="type">long</span> val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.split(right + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">this</span>.split(left);</span><br><span class="line"></span><br><span class="line">        tree.subSet(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(left), <span class="keyword">new</span> <span class="title class_">TreeNode</span>(right + <span class="number">1</span>))</span><br><span class="line">                .forEach(node -&gt; node.val += val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assign</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> left, <span class="keyword">final</span> <span class="type">int</span> right, <span class="keyword">final</span> <span class="type">long</span> val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.split(right + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">this</span>.split(left);</span><br><span class="line"></span><br><span class="line">        tree.subSet(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(left), <span class="keyword">new</span> <span class="title class_">TreeNode</span>(right + <span class="number">1</span>))</span><br><span class="line">                .clear();</span><br><span class="line">        tree.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(left, right, val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">kth</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> left, <span class="keyword">final</span> <span class="type">int</span> right, <span class="keyword">final</span> <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.split(right + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">this</span>.split(left);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">treeNodes</span> <span class="operator">=</span> tree.subSet(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(left), <span class="keyword">new</span> <span class="title class_">TreeNode</span>(right + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">sortTreeNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TreeNode&gt;(treeNodes.size());</span><br><span class="line">        sortTreeNodes.addAll(treeNodes);</span><br><span class="line">        sortTreeNodes.sort(Comparator.comparingLong(node -&gt; node.val));</span><br><span class="line">        <span class="type">var</span> <span class="variable">kth</span> <span class="operator">=</span> k;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">var</span> sortTreeNode : sortTreeNodes) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">var</span> <span class="variable">length</span> <span class="operator">=</span> sortTreeNode.right - sortTreeNode.left + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (length &gt;= kth) &#123;</span><br><span class="line">                <span class="keyword">return</span> sortTreeNode.val;</span><br><span class="line">            &#125;</span><br><span class="line">            kth -= length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">powerSum</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> left, <span class="keyword">final</span> <span class="type">int</span> right, <span class="keyword">final</span> <span class="type">long</span> x, <span class="keyword">final</span> <span class="type">long</span> y)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.split(right + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">this</span>.split(left);</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">var</span> treeNode : tree.subSet(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(left), <span class="keyword">new</span> <span class="title class_">TreeNode</span>(right + <span class="number">1</span>))) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">var</span> <span class="variable">length</span> <span class="operator">=</span> treeNode.right - treeNode.left + <span class="number">1</span>;</span><br><span class="line">            ans = (ans + <span class="built_in">this</span>.pow(treeNode.val, x, y) * (length % y) % y) % y;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">pow</span><span class="params">(<span class="type">long</span> base, <span class="type">long</span> pow, <span class="keyword">final</span> <span class="type">long</span> mod)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        base %= mod;</span><br><span class="line">        <span class="keyword">while</span> (pow &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((pow &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                ans = (ans * base) % mod;</span><br><span class="line">            &#125;</span><br><span class="line">            base = (base * base) % mod;</span><br><span class="line">            pow &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://static.wuhunyu.top/images/2025/08/0f501af977740e8e6f04012fc2d83804.png" alt="提交记录"></p><p>这里也有一份 Go 的实现，但 Go 的标准库中并没有 TreeMap 的实现，所以依赖了一个第三方库 <a href="https://github.com/emirpasic/gods">gods</a>，但 <a href="https://codeforces.com/">codeforces</a> 不接受引入第三方库，以下代码提交后直接提示编译错误了，但实际应该是可行的实现（可以跑过给出的测试用例，虽然只有两个测试用例）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/emirpasic/gods/trees/redblacktree&quot;</span></span><br><span class="line">  <span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ODT <span class="keyword">struct</span> &#123;</span><br><span class="line">  tree *redblacktree.Tree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> treeNode <span class="keyword">struct</span> &#123;</span><br><span class="line">  left  <span class="type">int</span></span><br><span class="line">  right <span class="type">int</span></span><br><span class="line">  val   <span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewODT</span><span class="params">(data []<span class="type">int64</span>)</span></span> *ODT &#123;</span><br><span class="line">  tree := redblacktree.NewWith(<span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    treeNode1 := a.(*treeNode)</span><br><span class="line">    treeNode2 := b.(*treeNode)</span><br><span class="line">    <span class="keyword">return</span> treeNode1.left - treeNode2.left</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;ODT&#123;tree&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pre := <span class="number">0</span></span><br><span class="line">  n := <span class="built_in">len</span>(data)</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; n; i++ &#123;</span><br><span class="line">    <span class="keyword">if</span> data[i] != data[i<span class="number">-1</span>] &#123;</span><br><span class="line">      tree.Put(&amp;treeNode&#123;pre, i - <span class="number">1</span>, data[i<span class="number">-1</span>]&#125;, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;)</span><br><span class="line">      pre = i</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  tree.Put(&amp;treeNode&#123;pre, n - <span class="number">1</span>, data[n<span class="number">-1</span>]&#125;, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;ODT&#123;tree&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ODT)</span></span> split(index <span class="type">int</span>) &#123;</span><br><span class="line">  key, ok := o.tree.Floor(&amp;treeNode&#123;left: index&#125;)</span><br><span class="line">  <span class="keyword">if</span> !ok || key.Key.(*treeNode).left == index || key.Key.(*treeNode).right &lt; index &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  node := key.Key.(*treeNode)</span><br><span class="line">  o.tree.Remove(node)</span><br><span class="line">  o.tree.Put(&amp;treeNode&#123;node.left, index - <span class="number">1</span>, node.val&#125;, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;)</span><br><span class="line">  o.tree.Put(&amp;treeNode&#123;index, node.right, node.val&#125;, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ODT)</span></span> foreach(start, end <span class="type">int</span>, handle <span class="function"><span class="keyword">func</span><span class="params">(*treeNode)</span></span>) &#123;</span><br><span class="line">  cur, _ := o.tree.Floor(&amp;treeNode&#123;left: start&#125;)</span><br><span class="line">  iterator := o.tree.IteratorAt(cur)</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    node := iterator.Key().(*treeNode)</span><br><span class="line">    <span class="keyword">if</span> node.left &gt; end &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    handle(node)</span><br><span class="line">    <span class="keyword">if</span> !iterator.Next() &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ODT)</span></span> Add(left, right <span class="type">int</span>, val <span class="type">int64</span>) &#123;</span><br><span class="line">  o.split(right + <span class="number">1</span>)</span><br><span class="line">  o.split(left)</span><br><span class="line"></span><br><span class="line">  o.foreach(left, right, <span class="function"><span class="keyword">func</span><span class="params">(node *treeNode)</span></span> &#123;</span><br><span class="line">    node.val += val</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ODT)</span></span> Assign(left, right <span class="type">int</span>, val <span class="type">int64</span>) &#123;</span><br><span class="line">  o.split(right + <span class="number">1</span>)</span><br><span class="line">  o.split(left)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> deleteNodes []*treeNode</span><br><span class="line">  o.foreach(left, right, <span class="function"><span class="keyword">func</span><span class="params">(node *treeNode)</span></span> &#123;</span><br><span class="line">    deleteNodes = <span class="built_in">append</span>(deleteNodes, node)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, node := <span class="keyword">range</span> deleteNodes &#123;</span><br><span class="line">    o.tree.Remove(node)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  o.tree.Put(&amp;treeNode&#123;left, right, val&#125;, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ODT)</span></span> Kth(left, right, kth <span class="type">int</span>) <span class="type">int64</span> &#123;</span><br><span class="line">  o.split(right + <span class="number">1</span>)</span><br><span class="line">  o.split(left)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> sortNodes []*treeNode</span><br><span class="line">  o.foreach(left, right, <span class="function"><span class="keyword">func</span><span class="params">(node *treeNode)</span></span> &#123;</span><br><span class="line">    sortNodes = <span class="built_in">append</span>(sortNodes, node)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  slices.SortFunc(sortNodes, <span class="function"><span class="keyword">func</span><span class="params">(a, b *treeNode)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">int</span>(a.val - b.val)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, node := <span class="keyword">range</span> sortNodes &#123;</span><br><span class="line">    length := node.right - node.left + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> kth &lt;= length &#123;</span><br><span class="line">      <span class="keyword">return</span> node.val</span><br><span class="line">    &#125;</span><br><span class="line">    kth -= length</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ODT)</span></span> PowerSum(left, right <span class="type">int</span>, x, y <span class="type">int64</span>) <span class="type">int64</span> &#123;</span><br><span class="line">  o.split(right + <span class="number">1</span>)</span><br><span class="line">  o.split(left)</span><br><span class="line"></span><br><span class="line">  ans := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">  o.foreach(left, right, <span class="function"><span class="keyword">func</span><span class="params">(node *treeNode)</span></span> &#123;</span><br><span class="line">    ans = (ans + ((<span class="type">int64</span>(node.right-node.left+<span class="number">1</span>)%y)*pow(node.val, x, y))%y) % y</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> ans</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pow</span><span class="params">(base, pow, mod <span class="type">int64</span>)</span></span> <span class="type">int64</span> &#123;</span><br><span class="line">  ans := <span class="type">int64</span>(<span class="number">1</span>)</span><br><span class="line">  base %= mod</span><br><span class="line">  <span class="keyword">for</span> pow &gt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pow &amp; <span class="number">1</span>) == <span class="number">1</span> &#123;</span><br><span class="line">      ans = (ans * base) % mod</span><br><span class="line">    &#125;</span><br><span class="line">    base = (base * base) % mod</span><br><span class="line">    pow &gt;&gt;= <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ans</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>ODT 树不算是一个多高级的数据结构，甚至也不算一个数据结构，强依赖了 TreeMap</p><p>我之所以有想法去探讨这个算法，应该是因为我们都喜欢珂朵莉吧</p>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;不知道你是否听说过一个叫&lt;strong&gt;珂朵莉树&lt;/strong&gt;(ODT, Old Driver Tree)的”数据结构“，它有个名称：“老司机树”&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://wuhunyu.top/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="珂朵莉树" scheme="https://wuhunyu.top/tags/%E7%8F%82%E6%9C%B5%E8%8E%89%E6%A0%91/"/>
    
    <category term="老司机树" scheme="https://wuhunyu.top/tags/%E8%80%81%E5%8F%B8%E6%9C%BA%E6%A0%91/"/>
    
  </entry>
  
  <entry>
    <title>基于 langchain4j 的简易 MCP Client</title>
    <link href="https://wuhunyu.top/ai/rag/2025/06/langchain4j-mcp-example/index.html"/>
    <id>https://wuhunyu.top/ai/rag/2025/06/langchain4j-mcp-example/index.html</id>
    <published>2025-06-10T10:30:00.000Z</published>
    <updated>2026-01-07T07:38:46.859Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>这次的定语比较多，又是 <strong>简易</strong> 又是 <strong>client</strong> 的</p><p>如果你去翻阅 langchain4j 有关 MCP 的文档（<a href="https://docs.langchain4j.dev/tutorials/mcp">点击这里</a>），你会发现有关它的内容比起 RAG 少的可怜</p><p>在我看来，应该是以下几个原因有关</p><ul><li>langchain4j 并没有实现完整的 MCP 协议。在目前版本（1.0.1）的 langchain4j 中是不存在 <strong>MCP Server</strong> 这个组件的</li><li>langchain4j 对于 <strong>MCP Client</strong> 的理解和 <strong>Function Calling</strong> 异曲同工，有一些逻辑在其他模块已经实现了</li></ul><p>我其实是有些纳闷的，因为我最初就是想用 langchain4j 把现有的服务构建成一个 <strong>MCP Server</strong>，至于 <strong>MCP Client</strong> 我想许多客户端都可以充当这个角色</p><blockquote><p>以上推论主观性很强，如果有错误，可以联系我的<a href="mailto:wuhunyu@gmail.com">邮箱</a></p></blockquote><span id="more"></span><h4 id="langchain4j-中的-MCP-Client"><a href="#langchain4j-中的-MCP-Client" class="headerlink" title="langchain4j 中的 MCP Client"></a>langchain4j 中的 MCP Client</h4><p>在 langchain4j 中，McpClient 本质还是一个 tool</p><p>从官方文档中给的例子中可以看出来一些端倪</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">McpTransport</span> <span class="variable">transport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpMcpTransport</span>.Builder()</span><br><span class="line">    .sseUrl(<span class="string">&quot;http://localhost:3001/sse&quot;</span>)</span><br><span class="line">    .logRequests(<span class="literal">true</span>) <span class="comment">// if you want to see the traffic in the log</span></span><br><span class="line">    .logResponses(<span class="literal">true</span>)</span><br><span class="line">    .build();</span><br><span class="line">    </span><br><span class="line"><span class="type">McpClient</span> <span class="variable">mcpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMcpClient</span>.Builder()</span><br><span class="line">    .key(<span class="string">&quot;MyMCPClient&quot;</span>)</span><br><span class="line">    .transport(transport)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">McpToolProvider</span> <span class="variable">toolProvider</span> <span class="operator">=</span> McpToolProvider.builder()</span><br><span class="line">    .mcpClients(mcpClient)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">Bot</span> <span class="variable">bot</span> <span class="operator">=</span> AiServices.builder(Bot.class)</span><br><span class="line">    .chatModel(model)</span><br><span class="line">    .toolProvider(toolProvider)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure><p>先是构建了一个基于 SSE 的传输对象 <code>transport</code>，然后封装成一个 <code>McpClient</code> 客户端，再包装成一个工具供应商 <code>McpToolProvider</code>，最后交给 <code>AiServices</code> 构建一个服务组件</p><p><code>AiServices</code> 除了有 <code>toolProvider</code> 属性，还有 <code>tools</code> 属性。而这个 <code>tools</code> 属性就是 <strong>Function Calling</strong> 用来配置 <code>tool</code> 的</p><p>看一下源码（<code>dev.langchain4j.service.tool.ToolService#createContext</code>）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ToolServiceContext <span class="title function_">createContext</span><span class="params">(Object memoryId, UserMessage userMessage)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.toolProvider == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.toolSpecifications.isEmpty() ?</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ToolServiceContext</span>(<span class="literal">null</span>, <span class="literal">null</span>) :</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ToolServiceContext</span>(<span class="built_in">this</span>.toolSpecifications, <span class="built_in">this</span>.toolExecutors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;ToolSpecification&gt; toolsSpecs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.toolSpecifications);</span><br><span class="line">    Map&lt;String, ToolExecutor&gt; toolExecs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="built_in">this</span>.toolExecutors);</span><br><span class="line">    <span class="type">ToolProviderRequest</span> <span class="variable">toolProviderRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToolProviderRequest</span>(memoryId, userMessage);</span><br><span class="line">    <span class="type">ToolProviderResult</span> <span class="variable">toolProviderResult</span> <span class="operator">=</span> toolProvider.provideTools(toolProviderRequest);</span><br><span class="line">    <span class="keyword">if</span> (toolProviderResult != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ToolSpecification, ToolExecutor&gt; entry :</span><br><span class="line">                toolProviderResult.tools().entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (toolExecs.putIfAbsent(entry.getKey().name(), entry.getValue()) == <span class="literal">null</span>) &#123;</span><br><span class="line">                toolsSpecs.add(entry.getKey());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalConfigurationException</span>(</span><br><span class="line">                        <span class="string">&quot;Duplicated definition for tool: &quot;</span> + entry.getKey().name());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ToolServiceContext</span>(toolsSpecs, toolExecs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>逻辑大概是</p><ol><li>如果 <code>toolProvider</code> 为空，则只包装了 <code>tools</code> 来源的工具</li></ol><blockquote><p>toolSpecifications 和 toolExecutors 是 tools 属性处理得到的</p></blockquote><ol start="2"><li>否则，先将 <code>toolSpecifications</code> 和 <code>toolExecutors</code> 添加到容器中做准备</li><li>重点在于 <code>provideTools</code> 方法，它将 <code>McpClient</code> 的 <code>tool</code> 列举出来（通过 <code>MCP</code> 协议的实现 <code>dev.langchain4j.mcp.client.McpClient#listTools</code>）并返回了 <code>ToolProviderResult</code></li></ol><p><code>dev.langchain4j.mcp.McpToolProvider#provideTools(dev.langchain4j.service.tool.ToolProviderRequest, java.util.function.BiPredicate&lt;dev.langchain4j.mcp.client.McpClient,dev.langchain4j.agent.tool.ToolSpecification&gt;)</code> 源码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> ToolProviderResult <span class="title function_">provideTools</span><span class="params">(ToolProviderRequest request, BiPredicate&lt;McpClient, ToolSpecification&gt; mcpToolsFilter)</span> &#123;</span><br><span class="line">    ToolProviderResult.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> ToolProviderResult.builder();</span><br><span class="line">    <span class="keyword">for</span> (McpClient mcpClient : mcpClients) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mcpClient.listTools().stream().filter(tool -&gt; mcpToolsFilter.test(mcpClient, tool))</span><br><span class="line">                    .forEach(toolSpecification -&gt; &#123;</span><br><span class="line">                builder.add(toolSpecification, (executionRequest, memoryId) -&gt; mcpClient.executeTool(executionRequest));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalConfigurationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (failIfOneServerFails) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to retrieve tools from MCP server&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Failed to retrieve tools from MCP server&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就可以看出来，其实本质上和普通的 <code>Function Calling</code> 没有什么区别</p><ol start="4"><li>将 <code>ToolProviderResult</code> 中的 <code>tool</code> 添加到第二步准备好的容器内</li></ol><p>剩下就是和 <code>Function Calling</code> 一样，把 <code>tool</code> 的描述交给大模型，让大模型判断应该使用哪些工具来协助完成用户的提问</p><h4 id="项目演示"><a href="#项目演示" class="headerlink" title="项目演示"></a>项目演示</h4><h5 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h5><p>利用 langchain4j 的 <code>MCP Client</code> 能力，使用 <strong>高德地图</strong> 和 <strong>腾讯地图</strong> 的 <code>MCP Server</code> 来实现一个旅行规划</p><h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><ul><li>deepseek api key：<a href="https://platform.deepseek.com/api_keys">申请地址</a></li><li>高德地图 api key：<a href="https://console.amap.com/dev/key/app">申请地址</a></li><li>腾讯地图 api key：<a href="https://lbs.qq.com/dev/console/application/mine">申请地址</a></li></ul><blockquote><p>大模型换用其它的国内模型也没问题，我习惯用 deepseek 了</p><p>其实百度地图也提供了它们的 MCP Server，不过它们的 key 申请需要认证开发者</p></blockquote><h5 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h5><h6 id="pom-依赖"><a href="#pom-依赖" class="headerlink" title="pom 依赖"></a>pom 依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.wuhunyu.mcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-mcp-client-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">langchain4j.version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">langchain4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- springboot 版本锁定 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- langchain4j 版本锁定 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- web --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j springboot 启动器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j 响应式编程 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j openai 接入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j mcp 接入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-mcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h6 id="application-yml-配置"><a href="#application-yml-配置" class="headerlink" title="application.yml 配置"></a>application.yml 配置</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">langchain4j-mcp-client-example</span></span><br><span class="line"></span><br><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="comment"># 大模型</span></span><br><span class="line">  <span class="attr">open-ai:</span></span><br><span class="line">    <span class="attr">chat-model:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com/v1</span></span><br><span class="line">      <span class="attr">api-key:</span> [<span class="string">替换成你的</span> <span class="string">deepseek</span> <span class="string">api</span> <span class="string">key</span>]</span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 流式大模型</span></span><br><span class="line">    <span class="attr">streaming-chat-model:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">$&#123;langchain4j.open-ai.chat-model.base-url&#125;</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">$&#123;langchain4j.open-ai.chat-model.api-key&#125;</span></span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="string">$&#123;langchain4j.open-ai.chat-model.log-requests&#125;</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="string">$&#123;langchain4j.open-ai.chat-model.log-responses&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mcp:</span></span><br><span class="line">  <span class="comment"># 高德地图</span></span><br><span class="line">  <span class="attr">amap:</span></span><br><span class="line">    <span class="attr">sse-url:</span> <span class="string">https://mcp.amap.com/sse?key=[替换成你的</span> <span class="string">高德地图</span> <span class="string">api</span> <span class="string">key]</span></span><br><span class="line">    <span class="attr">client-name:</span> <span class="string">amap-client</span></span><br><span class="line">    <span class="attr">client-version:</span> <span class="number">0.0</span><span class="number">.1</span></span><br><span class="line">  <span class="comment"># 腾讯地图</span></span><br><span class="line">  <span class="attr">qq:</span></span><br><span class="line">    <span class="attr">sse-url:</span> <span class="string">https://mcp.map.qq.com/sse?key=[替换成你的</span> <span class="string">腾讯地图</span> <span class="string">api</span> <span class="string">key]</span></span><br><span class="line">    <span class="attr">client-name:</span> <span class="string">qq-client</span></span><br><span class="line">    <span class="attr">client-version:</span> <span class="number">0.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><h6 id="组件配置"><a href="#组件配置" class="headerlink" title="组件配置"></a>组件配置</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MapClientService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SystemMessage(&quot;你是一个旅行规划专家，你可以根据用户的需求，为用户规划出旅行路线。&quot;)</span></span><br><span class="line">    Result&lt;String&gt; <span class="title function_">plan</span><span class="params">(<span class="meta">@MemoryId</span> Long userId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手动构建 AiService</span></span><br><span class="line"><span class="meta">@Bean(&quot;mapService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> MapClientService <span class="title function_">mapService</span><span class="params">(</span></span><br><span class="line"><span class="params">        ChatModel chatModel,</span></span><br><span class="line"><span class="params">        StreamingChatModel streamingChatModel,</span></span><br><span class="line"><span class="params">        ChatMemoryProvider chatMemoryProvider,</span></span><br><span class="line"><span class="params">        RetrievalAugmentor retrievalAugmentor,</span></span><br><span class="line"><span class="params">        <span class="meta">@Qualifier(&quot;amapMcpClient&quot;)</span> McpClient amapMcpClient,</span></span><br><span class="line"><span class="params">        <span class="meta">@Qualifier(&quot;qqMcpClient&quot;)</span> McpClient qqMcpClient,</span></span><br><span class="line"><span class="params">        DateTool dateTool</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">var</span> <span class="variable">mcpToolProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">McpToolProvider</span>.Builder()</span><br><span class="line">            .failIfOneServerFails(<span class="literal">false</span>)</span><br><span class="line">            .mcpClients(List.of(</span><br><span class="line">                    amapMcpClient,</span><br><span class="line">                    qqMcpClient</span><br><span class="line">            ))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> AiServices.builder(MapClientService.class)</span><br><span class="line">            .chatModel(chatModel)</span><br><span class="line">            .streamingChatModel(streamingChatModel)</span><br><span class="line">            .chatMemoryProvider(chatMemoryProvider)</span><br><span class="line">            .retrievalAugmentor(retrievalAugmentor)</span><br><span class="line">            .toolProvider(mcpToolProvider)</span><br><span class="line">            .tools(dateTool)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只贴出了最关键的部分</p><p>注意除了 <code>toolProvider</code> 配置 <code>MCP Client</code> 以外，还添加了一个 <code>tools</code>。这个日期工具只提供了一个基本的当前日期时间功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;dateTool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateTool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">DateTimeFormatter</span> <span class="variable">dateTimeFormatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tool(&quot;查询当前的日期时间，以 yyyy-MM-dd HH:mm:ss 格式返回&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">now</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(dateTimeFormatter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h6><p>让我们调用 <code>MapClientService#plan</code> 看看效果。我现在想要知道这个周末在深圳的旅游规划，提示词如下</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请帮我规划一下这周周末深圳的两天旅行规划，要求精确到小时的安排</span><br></pre></td></tr></table></figure><p>这是最后的效果</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">以下是深圳周末两天（2025年6月14日-15日）的详细旅行计划，具体到每小时的活动安排：</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="section">### <span class="strong">**第一天：6月14日（星期六）**</span></span></span><br><span class="line"><span class="section">#### <span class="strong">**上午**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**08:00-09:00**</span>：早餐  </span><br><span class="line">  推荐地点：深圳本地早茶店（如点都德、陶陶居）  </span><br><span class="line">  活动：品尝广式早茶，如虾饺、叉烧包等。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**09:00-11:00**</span>：深圳湾公园  </span><br><span class="line">  活动：散步、骑行，欣赏深圳湾海景和红树林生态。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**11:00-12:00**</span>：前往华侨城创意文化园  </span><br><span class="line">  交通：打车或地铁（约20分钟）  </span><br><span class="line">  活动：参观艺术展览、创意小店。</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**中午**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**12:00-13:30**</span>：午餐  </span><br><span class="line">  推荐地点：华侨城创意园内的特色餐厅（如“旧天堂书店”或“Gaga鲜语”）  </span><br><span class="line">  活动：享用午餐，稍作休息。</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**下午**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**13:30-15:30**</span>：世界之窗  </span><br><span class="line">  交通：打车或地铁（约15分钟）  </span><br><span class="line">  活动：参观世界著名景点的微缩模型，拍照打卡。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**15:30-17:00**</span>：欢乐海岸  </span><br><span class="line">  活动：购物、散步，欣赏水秀表演（如时间合适）。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**17:00-18:00**</span>：前往深圳湾万象城  </span><br><span class="line">  交通：步行或打车（约10分钟）  </span><br><span class="line">  活动：购物或休闲。</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**晚上**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**18:00-19:30**</span>：晚餐  </span><br><span class="line">  推荐地点：深圳湾万象城的高端餐厅（如“炳胜品味”）  </span><br><span class="line">  活动：享用晚餐。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**19:30-21:00**</span>：深圳湾灯光秀（如开放）  </span><br><span class="line">  活动：欣赏深圳湾夜景和灯光表演。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**21:00-22:00**</span>：返回酒店  </span><br><span class="line">  交通：打车或地铁  </span><br><span class="line">  活动：休息。</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="section">### <span class="strong">**第二天：6月15日（星期日）**</span></span></span><br><span class="line"><span class="section">#### <span class="strong">**上午**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**08:00-09:00**</span>：早餐  </span><br><span class="line">  推荐地点：酒店早餐或附近咖啡馆。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**09:00-11:00**</span>：大梅沙海滨公园  </span><br><span class="line">  交通：打车或自驾（约40分钟）  </span><br><span class="line">  活动：沙滩漫步、游泳（如天气允许）。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**11:00-12:00**</span>：东部华侨城  </span><br><span class="line">  活动：参观茶溪谷或大峡谷，体验自然风光。</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**中午**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**12:00-13:30**</span>：午餐  </span><br><span class="line">  推荐地点：东部华侨城内的餐厅  </span><br><span class="line">  活动：享用午餐。</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**下午**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**13:30-15:30**</span>：中英街  </span><br><span class="line">  交通：打车（约30分钟）  </span><br><span class="line">  活动：购物、了解历史。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**15:30-17:00**</span>：盐田海滨栈道  </span><br><span class="line">  活动：散步，欣赏海景。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**17:00-18:00**</span>：返回市区  </span><br><span class="line">  交通：打车或地铁  </span><br><span class="line">  活动：休息。</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**晚上**</span></span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**18:00-19:30**</span>：晚餐  </span><br><span class="line">  推荐地点：市区内的海鲜餐厅（如“79号渔船”）  </span><br><span class="line">  活动：享用晚餐。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**19:30-21:00**</span>：深圳平安金融中心云际观景台  </span><br><span class="line">  活动：俯瞰深圳夜景。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**21:00-22:00**</span>：返回酒店或前往机场/车站  </span><br><span class="line">  交通：打车或地铁  </span><br><span class="line">  活动：结束行程。</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="section">### <span class="strong">**注意事项**</span></span></span><br><span class="line"><span class="bullet">1.</span> <span class="strong">**交通**</span>：深圳地铁覆盖广泛，建议使用地铁或打车。</span><br><span class="line"><span class="bullet">2.</span> <span class="strong">**天气**</span>：提前查看天气，携带防晒或雨具。</span><br><span class="line"><span class="bullet">3.</span> <span class="strong">**门票**</span>：部分景点（如世界之窗、东部华侨城）需提前购票。</span><br><span class="line"></span><br><span class="line">如果需要调整或补充，请告诉我！</span><br></pre></td></tr></table></figure><h4 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h4><p>发现了一处 bug：okhttp 的响应流未关闭，控制台打印了警告日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2025-06-10 17:37:01.957 [OkHttp ConnectionPool] WARN  okhttp3.OkHttpClient - A connection to https://mcp.map.qq.com/ was leaked. Did you forget to close a response body? To see where this was allocated, set the OkHttpClient logger level to FINE: Logger.getLogger(OkHttpClient.class.getName()).setLevel(Level.FINE);</span><br><span class="line">2025-06-10 17:37:01.957 [OkHttp ConnectionPool] WARN  okhttp3.OkHttpClient - A connection to https://mcp.map.qq.com/ was leaked. Did you forget to close a response body? To see where this was allocated, set the OkHttpClient logger level to FINE: Logger.getLogger(OkHttpClient.class.getName()).setLevel(Level.FINE);</span><br></pre></td></tr></table></figure><p>问题源码（<code>dev.langchain4j.mcp.client.transport.http.HttpMcpTransport#execute</code>）如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;JsonNode&gt; <span class="title function_">execute</span><span class="params">(Request request, Long id)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;JsonNode&gt; future = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="literal">null</span>) &#123;</span><br><span class="line">        messageHandler.startOperation(id, future);</span><br><span class="line">    &#125;</span><br><span class="line">    client.newCall(request).enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">            future.completeExceptionally(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.code();</span><br><span class="line">            <span class="keyword">if</span> (!isExpectedStatusCode(statusCode)) &#123;</span><br><span class="line">                future.completeExceptionally(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unexpected status code: &quot;</span> + statusCode));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// For messages with null ID, we don&#x27;t wait for a response in the SSE channel</span></span><br><span class="line">            <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">                future.complete(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Response</code> 对象未在使用后调用其 <code>close</code> 方法关闭连接</p><p>修复成如下应该就可以了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;JsonNode&gt; <span class="title function_">execute</span><span class="params">(Request request, Long id)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;JsonNode&gt; future = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="literal">null</span>) &#123;</span><br><span class="line">        messageHandler.startOperation(id, future);</span><br><span class="line">    &#125;</span><br><span class="line">    client.newCall(request).enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">            future.completeExceptionally(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> (response) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.code();</span><br><span class="line">                <span class="keyword">if</span> (!isExpectedStatusCode(statusCode)) &#123;</span><br><span class="line">                    future.completeExceptionally(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unexpected status code: &quot;</span> + statusCode));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// For messages with null ID, we don&#x27;t wait for a response in the SSE channel</span></span><br><span class="line">                <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">                    future.complete(<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提了一个 <a href="https://github.com/langchain4j/langchain4j/issues/3191">issue</a>，本想要提一个 pr，但 langchain4j 的源码在我本地没跑起来，这个机会让给其他有缘人吧</p><h4 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h4><p><a href="https://github.com/wuhunyu/langchain4j-mcp-client-example">GitHub</a></p><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://docs.langchain4j.dev/tutorials/mcp">langchain4j 官网</a></p>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;这次的定语比较多，又是 &lt;strong&gt;简易&lt;/strong&gt; 又是 &lt;strong&gt;client&lt;/strong&gt; 的&lt;/p&gt;
&lt;p&gt;如果你去翻阅 langchain4j 有关 MCP 的文档（&lt;a href=&quot;https://docs.langchain4j.dev/tutorials/mcp&quot;&gt;点击这里&lt;/a&gt;），你会发现有关它的内容比起 RAG 少的可怜&lt;/p&gt;
&lt;p&gt;在我看来，应该是以下几个原因有关&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;langchain4j 并没有实现完整的 MCP 协议。在目前版本（1.0.1）的 langchain4j 中是不存在 &lt;strong&gt;MCP Server&lt;/strong&gt; 这个组件的&lt;/li&gt;
&lt;li&gt;langchain4j 对于 &lt;strong&gt;MCP Client&lt;/strong&gt; 的理解和 &lt;strong&gt;Function Calling&lt;/strong&gt; 异曲同工，有一些逻辑在其他模块已经实现了&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我其实是有些纳闷的，因为我最初就是想用 langchain4j 把现有的服务构建成一个 &lt;strong&gt;MCP Server&lt;/strong&gt;，至于 &lt;strong&gt;MCP Client&lt;/strong&gt; 我想许多客户端都可以充当这个角色&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;以上推论主观性很强，如果有错误，可以联系我的&lt;a href=&quot;mailto:wuhunyu@gmail.com&quot;&gt;邮箱&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="ai" scheme="https://wuhunyu.top/categories/ai/"/>
    
    
    <category term="langchain4j" scheme="https://wuhunyu.top/tags/langchain4j/"/>
    
    <category term="mcp" scheme="https://wuhunyu.top/tags/mcp/"/>
    
    <category term="mcp-client" scheme="https://wuhunyu.top/tags/mcp-client/"/>
    
  </entry>
  
  <entry>
    <title>基于 langchain4j 的简易 RAG</title>
    <link href="https://wuhunyu.top/ai/rag/2025/06/langchain4j-rag-example/index.html"/>
    <id>https://wuhunyu.top/ai/rag/2025/06/langchain4j-rag-example/index.html</id>
    <published>2025-06-09T02:14:00.000Z</published>
    <updated>2026-01-07T07:38:46.860Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="RAG-是什么"><a href="#RAG-是什么" class="headerlink" title="RAG 是什么"></a>RAG 是什么</h4><p>langchain4j 的官网给了一段通俗易懂的描述</p><blockquote><p>简单来说，RAG 是一种在发送给 LLM 之前，从你的数据中找到并注入相关信息片段到提示中的方法</p></blockquote><p>RAG 分为两个阶段，<strong>索引</strong>和<strong>检索</strong></p><p>关于<strong>检索</strong>部分，下面的项目中将分别使用 langchain4j 的原生组件以及高级用法分别实现</p><p>简单说明一下我对这两个阶段的理解</p><span id="more"></span><h5 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h5><p><img src="https://static.wuhunyu.top/images/2025/06/6f329a92d7a0342f26eb45f2ba1429b2.png" alt="rag-索引"></p><p>上图是 langchain4j 官网给出的示意图</p><p>大概的过程就是</p><ul><li>原始的文档（可以是 word，pdf，markdown等格式的文件，即图中的 Document）经过切割之后，得到了一个个的片段（即图中的 Segments）</li><li>一般走图中的右侧的流程，将片段经过内嵌模型（即图中的 Embedding Model）计算后，得到内嵌对象（图中的 Embedding），最后将内嵌对象保存到专门的数据库（图中的 Embedding Store）中</li></ul><p>过程中出现了几个名词</p><ul><li><p>Document：理解为包含内容的文档，比如 word，pdf，markdown等格式的文件</p></li><li><p>Segment：由 Document 拆分而来，具体的拆分规则可以自定义</p></li></ul><blockquote><p>至于为什么需要拆分，因为大模型一次能处理的上下文窗口是有限制的，如果直接把一个包含有 1百万 token 的文档喂给大模型，大模型也吃不消</p><p>将文档进行拆分，然后把一个个小的片段保存到数据库中，在需要用到这个文档时，只查询出相关性比较高的 topN 片段给大模型，这样大模型才能处理地过来，也能节省 token 的消耗，以及加快大模型的运行速度。缺点是根据拆分的规则，可能会丢失一部分信息</p></blockquote><ul><li>Embedding Model：内嵌模型。我理解为把自然语言转换成向量的一个模型</li></ul><blockquote><p>为什么要转换成向量？我们需要计算两句话的相关性高不高，需要特殊的算法。比如需要判断土豆和马铃薯的相关性高还是土豆和黄豆的相关性比较高</p></blockquote><ul><li>Embedding：内嵌对象。也就是内嵌模型的输出，也是内嵌数据库的输入</li><li>Embedding Store：内嵌数据库。用来保存内嵌对象的地方</li></ul><blockquote><p>许多我们熟悉的数据库也支持保存向量，比如 redis，postgresql。但它们在向量数据的处理方面毕竟没那么专业</p></blockquote><h4 id="检索"><a href="#检索" class="headerlink" title="检索"></a>检索</h4><p><img src="https://static.wuhunyu.top/images/2025/06/77e6860633287d4e0c733f32366b52e1.png" alt="rag-检索"></p><p>在索引完成之后，内嵌数据库中已经保存了一些文档数据</p><p>而检索的过程就是将用户的提问在内嵌数据库中查询相关性最高的片段，然后将这些片段和用户的提问聚合，再喂给大模型，由大模型做整合</p><p>在 langchain4j 给的图示中，对部分内容进行了省略。我尝试以代码的角度对这个流程进行完善</p><ul><li>用户的提问信息被称为一个 Query</li><li>Query 也可以像文档一样，先进行转换。在 langchain4j 目前的实现中，给出了三种转换</li></ul><blockquote><ol><li>DefaultQueryTransformer：什么都不做</li><li>CompressingQueryTransformer：通过大模型对用户的提问进行压缩。这是给大模型的提示词</li></ol><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Read and understand the conversation between the User and the AI. </span><br><span class="line">Then, analyze the new query from the User. </span><br><span class="line">Identify all relevant details, terms, and context from both the conversation and the new query. </span><br><span class="line">Reformulate this query into a clear, concise, and self-contained format suitable for information retrieval.</span><br><span class="line"><span class="code">                    </span></span><br><span class="line"><span class="code">Conversation:</span></span><br><span class="line"><span class="code">&#123;&#123;chatMemory&#125;&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">User query: &#123;&#123;query&#125;&#125;</span><br><span class="line"></span><br><span class="line">It is very important that you provide only reformulated query and nothing else! </span><br><span class="line">Do not prepend a query with anything!</span><br></pre></td></tr></table></figure><p>翻译一下是</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">阅读并理解用户与AI之间的对话。</span><br><span class="line">然后，分析用户的新查询。</span><br><span class="line">从对话和新查询中识别所有相关细节、术语和上下文。</span><br><span class="line">将此查询重新表述为清晰、简洁且适合信息检索的独立格式。</span><br><span class="line"></span><br><span class="line">对话：</span><br><span class="line">&#123;&#123;chatMemory&#125;&#125;</span><br><span class="line"></span><br><span class="line">用户查询：&#123;&#123;query&#125;&#125;</span><br><span class="line"></span><br><span class="line">非常重要，您只能提供重新表述的查询，不得提供其他内容！</span><br><span class="line">不要在查询前添加任何内容！</span><br></pre></td></tr></table></figure><ol start="3"><li>ExpandingQueryTransformer：和 CompressingQueryTransformer 一样，通过大模型对原有的提问进行扩展。可以指定扩展的数量，默认是 3 条。提示词如下</li></ol><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Generate &#123;&#123;n&#125;&#125; different versions of a provided user query. </span><br><span class="line">Each version should be worded differently, using synonyms or alternative sentence structures, </span><br><span class="line">but they should all retain the original meaning. </span><br><span class="line">These versions will be used to retrieve relevant documents. </span><br><span class="line">It is very important to provide each query version on a separate line, </span><br><span class="line">without enumerations, hyphens, or any additional formatting!</span><br><span class="line">User query: &#123;&#123;query&#125;&#125;</span><br></pre></td></tr></table></figure><p>翻译</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">生成提供的用户查询的&#123;&#123;n&#125;&#125;个不同版本。</span><br><span class="line">每个版本应使用不同的措辞，使用同义词或不同的句子结构，</span><br><span class="line">但它们都应该保留原始意义。</span><br><span class="line">这些版本将用于检索相关文档。</span><br><span class="line">非常重要，每个查询版本应单独一行提供，</span><br><span class="line">不要使用列举、破折号或任何其他格式化！</span><br><span class="line">用户查询：&#123;&#123;query&#125;&#125;</span><br></pre></td></tr></table></figure></blockquote><ul><li>经过转换之后，得到的一个 Query 列表。接下来需要的对每个 Query 进行路由，以选择每个 Query 的检索方式</li><li>同样的，路由也有多个实现。langchain4j 中有如下两种</li></ul><blockquote><p>DefaultQueryRouter：按顺序执行全部的检索方式</p><p>LanguageModelQueryRouter：问一下大模型选择哪些检索方式</p></blockquote><ul><li>关于检索方式，可以有很多很多。比如查询关系型数据库，web搜索，查询内嵌数据库，查询es数据库等等</li></ul><blockquote><p>相对来说，对于自然语言的处理，内嵌数据库和web搜索是我觉得比较合适的搜索方式</p></blockquote><ul><li>有了路由选择，每个 Query 都能被安排到对应的检索方式去处理。而处理的结果就是一个个 Content 列表</li><li>再将这些 Content 列表进行聚合，按相关性倒序排。在 langchain4j 中也提供了两种实现</li></ul><blockquote><p>DefaultContentAggregator：有一个特殊的算法，可以计算每个 Content 的相关性分数</p><p>ReRankingContentAggregator：用专门的排序模型（ScoringModel）评分</p></blockquote><ul><li>把排序好的 Content 注入到用户的提问中。可以自定义注入的模板</li><li>最后将注入好的消息交给大模型，让大模型完成最后的总结</li></ul><p>简单总结一下整个流程</p><blockquote><p>括号中是 langchain4j 的组件接口</p></blockquote><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户提问 -&gt; 问题压缩/扩展(QueryTransformer) -&gt; 问题路由(QueryRouter) -&gt; 检索(ContentRetriever) -&gt; 聚合(ContentAggregator) -&gt; 注入(ContentInjector) -&gt; 交给llm</span><br></pre></td></tr></table></figure><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><blockquote><p>在动手实现之前，需要准备一些环境</p></blockquote><ol><li>大模型的 api key。我这里使用的是 deepseek 的 key</li><li>内嵌模型的 api key。我用的是阿里云的内嵌模型 text-embedding-v3</li><li>内嵌数据库。自建的 milvus 数据库</li><li>tavily 搜索引擎的访问 key。申请网站是 <a href="https://app.tavily.com/">https://app.tavily.com</a></li></ol><blockquote><p>也可以换用 谷歌搜索，区别不是很大</p></blockquote><p>这里给出 milvus 环境的 docker compose 配置</p><blockquote><p>注意事项：由于没有挂载数据卷，容器被销毁后，数据也会被删除</p><p>端口</p><p>19530：milvus 对外提供服务的端口</p><p>3000：milvus web 服务的访问端口</p><p>访问 3000 端口可以在网页端操作 milvus</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">milvus-etcd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/coreos/etcd:v3.5.18</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_AUTO_COMPACTION_MODE=revision</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_AUTO_COMPACTION_RETENTION=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_QUOTA_BACKEND_BYTES=4294967296</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_SNAPSHOT_COUNT=50000</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">etcd</span> <span class="string">-advertise-client-urls=http://etcd:2379</span> <span class="string">-listen-client-urls</span> <span class="string">http://0.0.0.0:2379</span> <span class="string">--data-dir</span> <span class="string">/etcd</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;etcdctl&quot;</span>, <span class="string">&quot;endpoint&quot;</span>, <span class="string">&quot;health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">milvus-minio</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ACCESS_KEY:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="attr">MINIO_SECRET_KEY:</span> <span class="string">minioadmin</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">minio</span> <span class="string">server</span> <span class="string">/minio_data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9000/minio/health/live&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">milvus:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">milvus</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.5.10</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;standalone&quot;</span>]</span><br><span class="line">    <span class="attr">security_opt:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">seccomp:unconfined</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ETCD_ENDPOINTS:</span> <span class="string">etcd:2379</span></span><br><span class="line">      <span class="attr">MINIO_ADDRESS:</span> <span class="string">minio:9000</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9091/healthz&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">90s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19530:19530&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;etcd&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;minio&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">attu:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">milvus-attu</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zilliz/attu:v2.5.7</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MILVUS_URL:</span> <span class="string">milvus:19530</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;milvus&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">milvus</span></span><br></pre></td></tr></table></figure><h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><blockquote><p>要求 jdk 版本在 21 及以上，项目中有一处使用了虚拟线程</p></blockquote><h5 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h5><p>分别使用 langchain4j 的高级语法和低级组件来实现一个简单的 RAG 功能</p><p>外部知识库的来源有两个部分，也可自行扩展</p><ol><li>内嵌数据库</li><li>tavily 搜索</li></ol><p>其中，内嵌数据库的数据库将通过 function call 的方式写入。下面将提供一个简单的案列供参考</p><h5 id="pom-依赖"><a href="#pom-依赖" class="headerlink" title="pom 依赖"></a>pom 依赖</h5><blockquote><p>maven 的中央仓库没有 langchain4j-milvus-spring-boot-starter 依赖</p><p>有两个处理方案</p><ol><li>clone <a href="https://github.com/langchain4j/langchain4j-spring">langchain4j-spring</a> 仓库打包对应的版本(1.0.0-beta3)到本地仓库</li><li>修改成 langchain4j-milvus 依赖，自行编码构建 MilvusEmbeddingStore bean 对象</li></ol><p>这里我选择的是方法一</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.wuhunyu.rag<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-rag-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">langchain4j.version</span>&gt;</span>1.0.0-beta3<span class="tag">&lt;/<span class="name">langchain4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- springboot 版本锁定 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- langchain4j 版本锁定 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- web --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j springboot 启动器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j 响应式编程 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j openai 接入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j milvus 接入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-milvus-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- langchain4j tavily 搜索引擎接入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-web-search-engine-tavily<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">langchain4j-rag-example</span></span><br><span class="line"></span><br><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="attr">open-ai:</span></span><br><span class="line">    <span class="comment"># 大模型</span></span><br><span class="line">    <span class="attr">chat-model:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com/v1</span></span><br><span class="line">      <span class="attr">api-key:</span> [<span class="string">deepseek</span> <span class="string">api</span> <span class="string">key</span>]</span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 流式大模型</span></span><br><span class="line">    <span class="attr">streaming-chat-model:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com/v1</span></span><br><span class="line">      <span class="attr">api-key:</span> [<span class="string">deepseek</span> <span class="string">api</span> <span class="string">key</span>]</span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 内嵌模型</span></span><br><span class="line">    <span class="attr">embedding-model:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://dashscope.aliyuncs.com/compatible-mode/v1</span></span><br><span class="line">      <span class="attr">api-key:</span> [<span class="string">embedding</span> <span class="string">api</span> <span class="string">key</span>]</span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">text-embedding-v3</span></span><br><span class="line">      <span class="attr">max-segments-per-batch:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">dimensions:</span> <span class="number">1024</span></span><br><span class="line">  <span class="comment"># 内嵌数据库</span></span><br><span class="line">  <span class="attr">milvus:</span></span><br><span class="line">    <span class="attr">host:</span> [<span class="string">自建</span> <span class="string">milvus</span> <span class="string">数据库主机地址</span>]</span><br><span class="line">    <span class="attr">port:</span> <span class="number">19530</span></span><br><span class="line">    <span class="attr">database-name:</span> <span class="string">rag</span></span><br><span class="line">    <span class="attr">collection-name:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">dimension:</span> <span class="number">1024</span></span><br><span class="line">    <span class="comment"># 最大搜索结果数</span></span><br><span class="line">    <span class="attr">max-results:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络搜索引擎</span></span><br><span class="line"><span class="attr">tavily:</span></span><br><span class="line">  <span class="comment"># 最大搜索结果数</span></span><br><span class="line">  <span class="attr">max-results:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">api-key:</span> [<span class="string">tavily</span> <span class="string">api</span> <span class="string">key</span>]</span><br></pre></td></tr></table></figure><h5 id="监听器"><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h5><blockquote><p>langchain4j 提供了一个监听器接口(dev.langchain4j.model.chat.listener.ChatModelListener)，可以让开发者监听与大模型的交互过程</p><p>下面的代码在请求和响应的时候打印了请求的消息对象。我们可以从中观察整个 RAG 过程和大模型交互的次数，以及中间过程的处理结果</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 大模型交互监听器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuhunyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/06/08 11:21</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;myChatModelListener&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyChatModelListener</span> <span class="keyword">implements</span> <span class="title class_">ChatModelListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequest</span><span class="params">(<span class="keyword">final</span> ChatModelRequestContext requestContext)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">chatRequest</span> <span class="operator">=</span> requestContext.chatRequest();</span><br><span class="line">        <span class="type">var</span> <span class="variable">messages</span> <span class="operator">=</span> chatRequest.messages();</span><br><span class="line">        log.debug(<span class="string">&quot;onRequest: &#123;&#125;&quot;</span>, messages);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(<span class="keyword">final</span> ChatModelResponseContext responseContext)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">chatResponse</span> <span class="operator">=</span> responseContext.chatResponse();</span><br><span class="line">        <span class="type">var</span> <span class="variable">aiMessage</span> <span class="operator">=</span> chatResponse.aiMessage();</span><br><span class="line">        log.debug(<span class="string">&quot;onResponse: &#123;&#125;&quot;</span>, aiMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(<span class="keyword">final</span> ChatModelErrorContext errorContext)</span> &#123;</span><br><span class="line">        ChatModelListener.<span class="built_in">super</span>.onError(errorContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="bean-配置"><a href="#bean-配置" class="headerlink" title="bean 配置"></a>bean 配置</h5><blockquote><p>这个配置类注入了一些 langchain4j 的 bean，在高级语法和低级组件中都有用到</p><p>具体 bean 的作用可以看注释</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rag bean 配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuhunyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/06/08 10:44</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RAGBeanConfig.TavilyProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RAGBeanConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息存储，此处为内存存储</span></span><br><span class="line">    <span class="meta">@Bean(&quot;chatMemoryStore&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemoryStore <span class="title function_">chatMemoryStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryChatMemoryStore</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于隔离不同的用户会话消息。也可使用 MessageWindowChatMemory 实现用来替换 TokenWindowChatMemory</span></span><br><span class="line">    <span class="meta">@Bean(&quot;chatMemoryProvider&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemoryProvider <span class="title function_">chatMemoryProvider</span><span class="params">(ChatMemoryStore chatMemoryStore)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memoryId -&gt; TokenWindowChatMemory.builder()</span><br><span class="line">                .chatMemoryStore(chatMemoryStore)</span><br><span class="line">                .maxTokens(<span class="number">10240</span>, <span class="keyword">new</span> <span class="title class_">OpenAiTokenizer</span>(OpenAiChatModelName.GPT_4))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Query 转换器。也可以换用 ExpandingQueryTransformer 进行 Query 扩展</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queryTransformer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> QueryTransformer <span class="title function_">queryTransformer</span><span class="params">(ChatLanguageModel chatLanguageModel)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CompressingQueryTransformer</span>(chatLanguageModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;tavily&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TavilyProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Integer maxResults;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// web 搜索引擎，此处选择的是 tavily 搜索引擎</span></span><br><span class="line">    <span class="meta">@Bean(&quot;webSearchContentRetriever&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> WebSearchContentRetriever <span class="title function_">webSearchContentRetriever</span><span class="params">(TavilyProperties tavilyProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">tavilyWebSearchEngine</span> <span class="operator">=</span> TavilyWebSearchEngine.builder()</span><br><span class="line">                .apiKey(tavilyProperties.getApiKey())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> WebSearchContentRetriever.builder()</span><br><span class="line">                .maxResults(tavilyProperties.getMaxResults())</span><br><span class="line">                .webSearchEngine(tavilyWebSearchEngine)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内嵌数据库检索器，此处选择的是 milvus 数据库</span></span><br><span class="line">    <span class="meta">@Bean(&quot;embeddingStoreContentRetriever&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> EmbeddingStoreContentRetriever <span class="title function_">embeddingStoreContentRetriever</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Value(&quot;$&#123;langchain4j.milvus.max-results:50&#125;&quot;)</span> Integer maxResults,</span></span><br><span class="line"><span class="params">            MilvusEmbeddingStore milvusEmbeddingStore,</span></span><br><span class="line"><span class="params">            EmbeddingModel embeddingModel</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> EmbeddingStoreContentRetriever.builder()</span><br><span class="line">                .embeddingStore(milvusEmbeddingStore)</span><br><span class="line">                .embeddingModel(embeddingModel)</span><br><span class="line">                .maxResults(maxResults)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Query 路由，让大模型决定选择哪一个检索器或者哪几个检索器。retrieverToDescription 属性的 key 为检索器，value 为检索器的描述</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queryRouter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> QueryRouter <span class="title function_">queryRouter</span><span class="params">(</span></span><br><span class="line"><span class="params">            ChatLanguageModel chatLanguageModel,</span></span><br><span class="line"><span class="params">            WebSearchContentRetriever webSearchContentRetriever,</span></span><br><span class="line"><span class="params">            EmbeddingStoreContentRetriever embeddingStoreContentRetriever</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LanguageModelQueryRouter.builder()</span><br><span class="line">                .chatLanguageModel(chatLanguageModel)</span><br><span class="line">                .retrieverToDescription(Map.of(</span><br><span class="line">                        webSearchContentRetriever, <span class="string">&quot;Web Search&quot;</span>,</span><br><span class="line">                        embeddingStoreContentRetriever, <span class="string">&quot;Embedding Database&quot;</span></span><br><span class="line">                ))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// content 聚合器，如果有 ReRanking 模型，也可以选择使用 ReRankingContentAggregator 对检索结果进行排序</span></span><br><span class="line">    <span class="meta">@Bean(&quot;contentAggregator&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ContentAggregator <span class="title function_">contentAggregator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultContentAggregator</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// content 注入器，可以自定义注入内容的模型</span></span><br><span class="line">    <span class="meta">@Bean(&quot;contentInjector&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ContentInjector <span class="title function_">contentInjector</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultContentInjector</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检索增强器，简单理解为把上面的几个组件联系到一起协作处理 Query，最终返回增强后的 ChatMessage</span></span><br><span class="line">    <span class="meta">@Bean(&quot;retrievalAugmentor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RetrievalAugmentor <span class="title function_">retrievalAugmentor</span><span class="params">(</span></span><br><span class="line"><span class="params">            QueryTransformer queryTransformer,</span></span><br><span class="line"><span class="params">            QueryRouter queryRouter,</span></span><br><span class="line"><span class="params">            ContentAggregator contentAggregator,</span></span><br><span class="line"><span class="params">            ContentInjector contentInjector</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="comment">// 自定义线程池</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">threadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomizableThreadFactory</span>(<span class="string">&quot;retrievalAugmentor-&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newThreadPerTaskExecutor(threadFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DefaultRetrievalAugmentor.builder()</span><br><span class="line">                .queryTransformer(queryTransformer)</span><br><span class="line">                .queryRouter(queryRouter)</span><br><span class="line">                .contentAggregator(contentAggregator)</span><br><span class="line">                .contentInjector(contentInjector)</span><br><span class="line">                .executor(executorService)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="高级语法"><a href="#高级语法" class="headerlink" title="高级语法"></a>高级语法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 高级 langchain4j 编程</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuhunyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/06/08 11:23</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = AiServiceWiringMode.EXPLICIT,</span></span><br><span class="line"><span class="meta">        chatModel = &quot;openAiChatModel&quot;,</span></span><br><span class="line"><span class="meta">        streamingChatModel = &quot;openAiStreamingChatModel&quot;,</span></span><br><span class="line"><span class="meta">        chatMemoryProvider = &quot;chatMemoryProvider&quot;,</span></span><br><span class="line"><span class="meta">        retrievalAugmentor = &quot;retrievalAugmentor&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AdvanceLLMService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SystemMessage(&quot;你是一个知识渊博的助手，请通俗易懂地回答我的问题。&quot;)</span></span><br><span class="line">    TokenStream <span class="title function_">streamChat</span><span class="params">(<span class="meta">@MemoryId</span> Long userId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>高级语法主要的配置在 <code>@AiService</code> 这个注解上</p><ul><li>chatModel 和 streamingChatModel 分别表示非流式大模型对象和流式大模型对象。这么说可能会有一些歧义。大模型都是支持流式返回的，可以称为同步返回和异步一点一点返回，带 streaming 前缀的就是一步一点一点返回的</li><li>chatMemoryProvider 用来区别不同的会话</li><li>retrievalAugmentor 检索增强，RAG 的核心实现就是这个组件，后续低级写法中，也是对这个组件进行分解成多个基础组件并手动编码实现同样的效果</li></ul><p>userId 参数是用来区别不同的会话使用的，通过同一个 id 值会讲历史的对话记录一并发送给大模型</p><p>userMessage 参数是实际用户的提问</p><p>方法顶上的 <code>@SystemMessage</code> 注解表示一个系统消息，在优先级上要高于普通的用户消息</p><p>TokenStream 类型的响应值表示这是一个流式的返回</p></blockquote><p>那么，让我们试一下这个高级语法实现的 RAG 效果如何</p><p>我们新增一个请求路由来调用这个方法</p><h6 id="请求路由"><a href="#请求路由" class="headerlink" title="请求路由"></a>请求路由</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rag</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuhunyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/06/08 11:35</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rag&quot;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RAGController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdvanceLLMService advanceLLMService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UserMessageRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Serial</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8569299218617670092L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用户id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/advance&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">advance</span><span class="params">(<span class="meta">@RequestBody</span> UserMessageRequest userMessageRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">tokenStream</span> <span class="operator">=</span> advanceLLMService.streamChat(</span><br><span class="line">                userMessageRequest.getUserId(),</span><br><span class="line">                userMessageRequest.getMessage()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 结果返回</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(-<span class="number">1L</span>);</span><br><span class="line">        tokenStream.onPartialResponse(s -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        sseEmitter.send(</span><br><span class="line">                                SseEmitter.event()</span><br><span class="line">                                        .data(s)</span><br><span class="line">                                        .build()</span><br><span class="line">                        );</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .onCompleteResponse(chatResponse -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;chatResponse: &#123;&#125;&quot;</span>, chatResponse.aiMessage().text());</span><br><span class="line">                    sseEmitter.complete();</span><br><span class="line">                &#125;)</span><br><span class="line">                .onError(throwable -&gt; &#123;</span><br><span class="line">                    sseEmitter.complete();</span><br><span class="line">                    log.error(<span class="string">&quot;&quot;</span>, throwable);</span><br><span class="line">                &#125;);</span><br><span class="line">        tokenStream.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这时候内嵌数据库还是没数据的状态，尝试询问大模型一个有关 jvm 的问题</p><p>发起一个 POST 请求，如下</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://localhost:8080/rag/advance&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;userId&quot;: 1,</span><br><span class="line">    &quot;message&quot;: &quot;请简单地描述一下 jvm 是什么&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p>此前我们配置了一个监听器，让我们来看看都和大模型交互了一些什么信息</p><h6 id="问题路由"><a href="#问题路由" class="headerlink" title="问题路由"></a>问题路由</h6><blockquote><p>可以看到，发送了一个选择给大模型，选择的条件是我的问题本身</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2025-06-08 20:27:07.224 [http-nio-8080-exec-2] DEBUG top.wuhunyu.rag.listener.MyChatModelListener - onRequest: [UserMessage &#123; name = null contents = [TextContent &#123; text = &quot;Based on the user query, determine the most suitable data source(s) to retrieve relevant information from the following options:</span><br><span class="line">1: Web Search</span><br><span class="line">2: Embedding Database</span><br><span class="line">It is very important that your answer consists of either a single number or multiple numbers separated by commas and nothing else!</span><br><span class="line">User query: 请简单地描述一下 jvm 是什么&quot; &#125;] &#125;]</span><br></pre></td></tr></table></figure><p>而此次询问大模型返回的结果是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2025-06-08 20:27:11.492 [http-nio-8080-exec-2] DEBUG top.wuhunyu.rag.listener.MyChatModelListener - onResponse: AiMessage &#123; text = &quot;1,2&quot; toolExecutionRequests = null &#125;</span><br></pre></td></tr></table></figure><blockquote><p>也就是大模型角色有必要从 <code>Web Search</code> 和 <code>Embedding Database</code> 两个数据来源中获取数据</p></blockquote><p>接下来，便是分别从两个数据来源获取响应的结果，然后进行排序，注入，最后再发送给大模型，由大模型进行总结</p><blockquote><p>最后的请求和响应日志都太长了，这里就不贴出来了</p></blockquote><p>在请求调试工具中， SSE 的返回结果形如</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">data:J</span><br><span class="line"></span><br><span class="line">data:VM</span><br><span class="line"></span><br><span class="line">data:（</span><br><span class="line"></span><br><span class="line">data:Java</span><br><span class="line"></span><br><span class="line">data: Virtual</span><br><span class="line"></span><br><span class="line">data: Machine</span><br><span class="line"></span><br><span class="line">data:，</span><br><span class="line"></span><br><span class="line">data:Java</span><br><span class="line"></span><br><span class="line">data: </span><br><span class="line"></span><br><span class="line">data:虚拟机</span><br><span class="line"></span><br><span class="line">data:）</span><br><span class="line"></span><br><span class="line">data:是</span><br><span class="line"></span><br><span class="line">data: Java</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h6 id="function-call"><a href="#function-call" class="headerlink" title="function call"></a>function call</h6><blockquote><p>上面这次问题，在内嵌数据库中，并没有查询到任何数据。这点可以通过日志观察得出来，最后一次提问中，发送给大模型的提示词中，并没有包含 web 的数据来源，而来源于 web 搜索的数据都会有一个网站的来源。比如</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">深入理解HotSpot JVM 基本原理 - 腾讯云</span><br><span class="line">它保存所有被JVM加载的类和接口的运行时常量池，成员变量以及方法的信息，静态变量以及方法的字节码。JVM的提供者可以通过不同的方式来实现方法区。在Oracle 的HotSpot JVM里，方法区被称为永久区或者永久代（PermGen）。</span><br><span class="line"></span><br><span class="line">doocs/jvm: JVM 底层原理最全知识总结 - GitHub</span><br><span class="line">🤗 JVM 底层原理最全知识总结. Contribute to doocs/jvm development by creating an account on GitHub.</span><br></pre></td></tr></table></figure><p>表明了这两条数据分别来源于 腾讯云 和 GitHub</p></blockquote><p>现在让我们利用 tool 将文档向量化并写入内嵌数据库中，不过在使用 tool 之前，我们需要先声明</p><p>本地工具 LocalFileHandlerTool</p><blockquote><p>这个工具属于 langchain4j 的高级语法，低级写法太麻烦了，个人也推荐使用注解的方式描述工具</p><p>只有两个功能</p><ol><li>列出服务器指定的路径下的所有文件</li><li>将指定的文件索引到内嵌数据库中。这里的内嵌数据库指的是<strong>环境准备</strong>中的 milvus 数据库</li></ol><p>实现中，代码有一个 <strong>PATH</strong> 常量，需要替换成自己机器上的路径，需要这个路径下有一些文档文件（比如 word，pdf，markdown等格式的文件），便于向量化然后写入到内嵌数据库中</p><p>其中标注了 <code>@Tool</code> 注解的便是一个 <code>tool</code>，可以通过 <code>@P</code> 注解对入参进行描述</p><p>最后给到大模型的是一个 json 格式的工具描述，可以自行断点观察</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 本地文件处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author wuhunyu</span></span><br><span class="line"><span class="comment"> * @date 2025/06/08 11:18</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;localFileHandlerTool&quot;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalFileHandlerTool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">&quot;/Users/wuhunyu/WorkSpace/learn&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EmbeddingModel embeddingModel;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MilvusEmbeddingStore milvusEmbeddingStore;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Tool(&quot;列出目录下的所有文件&quot;)</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">listDir</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">File</span>(PATH).listFiles()</span><br><span class="line">                )</span><br><span class="line">                .filter(File::isFile)</span><br><span class="line">                .map(File::getName)</span><br><span class="line">                .toList();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Tool(&quot;获取指定文件名的大小，单位：字节。当文件不存在或者不可读时，返回 -1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">fileSize</span><span class="params">(<span class="meta">@P(&quot;文件名称&quot;)</span> String fileName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isFile(fileName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="built_in">this</span>.getCompleteFileName(fileName)).length();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isFile</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">        fileName = <span class="built_in">this</span>.getCompleteFileName(fileName);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(fileName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileName);</span><br><span class="line">        <span class="keyword">return</span> file.exists() &amp;&amp; file.isFile() &amp;&amp; file.canRead();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getCompleteFileName</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PATH + File.separator + fileName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Tool(&quot;将指定文件的内容存放至 embedding 数据库中。操作成功时，返回 success，其他返回都为错误信息&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toEmbedding</span><span class="params">(<span class="meta">@P(&quot;文件名称&quot;)</span> String fileName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isFile(fileName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;文件不存在&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 加载文档</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">var</span> <span class="variable">document</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(</span><br><span class="line">                    <span class="built_in">this</span>.getCompleteFileName(fileName),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">TextDocumentParser</span>()</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 文档拆分器</span></span><br><span class="line">            <span class="type">DocumentBySentenceSplitter</span> <span class="variable">documentBySentenceSplitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DocumentBySentenceSplitter</span>(</span><br><span class="line">                    <span class="number">300</span>,</span><br><span class="line">                    <span class="number">100</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">OpenAiTokenizer</span>(OpenAiEmbeddingModelName.TEXT_EMBEDDING_3_SMALL));</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 文档拆分，并添加 source 元数据</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">textSegments</span> <span class="operator">=</span> documentBySentenceSplitter.split(document)</span><br><span class="line">                    .stream()</span><br><span class="line">                    .peek(textSegment -&gt; &#123;</span><br><span class="line">                        <span class="type">Metadata</span> <span class="variable">metadata</span> <span class="operator">=</span> textSegment.metadata();</span><br><span class="line">                        metadata.put(<span class="string">&quot;source&quot;</span>, fileName);</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .toList();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 添加到 内嵌数据库 中</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">listResponse</span> <span class="operator">=</span> embeddingModel.embedAll(textSegments);</span><br><span class="line">            milvusEmbeddingStore.addAll(listResponse.content(), textSegments);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 返回成功</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;读取本地文档 &#123;&#125; 到内嵌数据库失败: &quot;</span>, fileName, e);</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新增一个内嵌数据服务 EmbeddingService</p><blockquote><p>不知道你看出来和 AdvanceLLMService 的区别了吗</p><p>本质区别就是少了 retrievalAugmentor 属性，多了 tools 属性</p><p>为什么要这么做呢，不能合并成一个吗？</p><p>由于 retrievalAugmentor 内部会做各种动作对最初的提问进行增强，很可能会干扰大模型的判断，所以我们需要一个比较干净的上下文环境减少大模型的误判断</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内嵌数据准备</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gongzhiqiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/06/08 20:45</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = AiServiceWiringMode.EXPLICIT,</span></span><br><span class="line"><span class="meta">        chatModel = &quot;openAiChatModel&quot;,</span></span><br><span class="line"><span class="meta">        streamingChatModel = &quot;openAiStreamingChatModel&quot;,</span></span><br><span class="line"><span class="meta">        chatMemoryProvider = &quot;chatMemoryProvider&quot;,</span></span><br><span class="line"><span class="meta">        tools = &#123;</span></span><br><span class="line"><span class="meta">                &quot;localFileHandlerTool&quot;</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmbeddingService</span> &#123;</span><br><span class="line"></span><br><span class="line">    Result&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> Long userId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在请求路由上添加一个调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/embedding-tool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">embeddingTool</span><span class="params">(<span class="meta">@RequestBody</span> UserMessageRequest userMessageRequest)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> embeddingService.chat(userMessageRequest.getUserId(), userMessageRequest.getMessage());</span><br><span class="line">    <span class="keyword">return</span> result.content();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先要大模型列出路径下的全部文件</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://localhost:8080/rag/embedding-tool&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;userId&quot;: 2,</span><br><span class="line">    &quot;message&quot;: &quot;列出全部的文件&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">当前目录下的文件列表如下：</span><br><span class="line"></span><br><span class="line">1. Kafka.md</span><br><span class="line">2. MyBatis.md</span><br><span class="line">3. ArchLinux.md</span><br><span class="line">4. Docker操作命令.md</span><br><span class="line">5. JVM类的加载过程.md</span><br><span class="line">6. Go.md</span><br><span class="line">7. Java程序员-xxx.md</span><br><span class="line">8. SpringMVC.md</span><br><span class="line">9. Zookeeper2.md</span><br><span class="line">10. Spring5.md</span><br><span class="line">11. JVM字节码与类的加载篇.md</span><br><span class="line">12. JUC.md</span><br><span class="line">13. 面试积累.md</span><br><span class="line">14. Redis.md</span><br><span class="line">15. SpringBoot.md</span><br><span class="line">16. 二叉树前中后序遍历.md</span><br><span class="line">17. nginx.md</span><br><span class="line">18. Java工程师-xxx.md</span><br><span class="line">19. JVM内存与垃圾回收篇.md</span><br><span class="line">20. Java8新特性.md</span><br><span class="line">21. SpringSecurity.md</span><br><span class="line">22. MySQL.md</span><br><span class="line">23. ITX主机计划.md</span><br><span class="line">24. JVM.md</span><br><span class="line">25. 面试小笔记.md</span><br><span class="line">26. Linux.md</span><br><span class="line">27. JVM性能调优.md</span><br><span class="line">28. Maven.md</span><br><span class="line">29. C语言.md</span><br><span class="line">30. JVM运行时参数.md</span><br><span class="line">31. Git.md</span><br><span class="line">32. 工作经历-xxx.md</span><br><span class="line">33. ElasticSearch.md</span><br><span class="line">34. RabbiMQ.md</span><br><span class="line">35. Docker.md</span><br><span class="line">36. SpringCloud.md</span><br><span class="line">37. 反射.md</span><br><span class="line">38. 面试学习.md</span><br><span class="line">39. 实战开发.md</span><br><span class="line">40. NIO.md</span><br><span class="line">41. Spring简单整合MyBatis(基于xml方式).md</span><br><span class="line">42. MySQL调优.md</span><br><span class="line">43. Zookeeper.md</span><br><span class="line">44. 个人笔记.md</span><br><span class="line"></span><br><span class="line">如果需要进一步操作（如获取文件大小或嵌入内容），请告诉我！</span><br></pre></td></tr></table></figure><p>将 19 号文件加载到内嵌数据库中</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://localhost:8080/rag/embedding-tool&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;userId&quot;: 2,</span><br><span class="line">    &quot;message&quot;: &quot;将 19 号文件加载到内嵌数据库中&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p>结果如下</p><p><img src="https://static.wuhunyu.top/images/2025/06/a495968250ffbe6d5ce6ad93feacf41d.png" alt="向量数据库"></p><p>再次询问 <code>请简单地描述一下 jvm 是什么</code></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://localhost:8080/rag/advance&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;userId&quot;: 1,</span><br><span class="line">    &quot;message&quot;: &quot;请简单地描述一下 jvm 是什么&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p>可以在控制台观察到最后发送给大模型的消息中，除了标记由来源的消息，也有不携带消息来源的消息，这些不携带消息来源的消息就是来源于内嵌数据库中</p><h5 id="低级写法"><a href="#低级写法" class="headerlink" title="低级写法"></a>低级写法</h5><blockquote><p>所谓低级写法，就是将 @AiService 注解实现的功能用编码的方式手动实现一遍</p><p>此处只给出代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * langchain4j 低级写法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuhunyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/06/08 12:23</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;basicLLMService&quot;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicLLMService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatLanguageModel chatLanguageModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryTransformer queryTransformer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatMemoryProvider chatMemoryProvider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryRouter queryRouter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ContentAggregator contentAggregator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ContentInjector contentInjector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(Long userId, String message)</span> &#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.from(</span><br><span class="line">                message,</span><br><span class="line">                Metadata.from(</span><br><span class="line">                        UserMessage.from(message),</span><br><span class="line">                        userId,</span><br><span class="line">                        chatMemoryProvider.get(userId)</span><br><span class="line">                                .messages()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform</span></span><br><span class="line">        Collection&lt;Query&gt; queries = queryTransformer.transform(query);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// query router</span></span><br><span class="line">        Map&lt;Query, Collection&lt;List&lt;Content&gt;&gt;&gt; query2Contents = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Query curQuery : queries) &#123;</span><br><span class="line">            Collection&lt;ContentRetriever&gt; contentRetrievers = queryRouter.route(curQuery);</span><br><span class="line">            List&lt;List&lt;Content&gt;&gt; contents = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (ContentRetriever contentRetriever : contentRetrievers) &#123;</span><br><span class="line">                contents.add(contentRetriever.retrieve(curQuery));</span><br><span class="line">            &#125;</span><br><span class="line">            query2Contents.put(curQuery, contents);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// content aggregator</span></span><br><span class="line">        List&lt;Content&gt; finalContents = contentAggregator.aggregate(query2Contents);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// content injector</span></span><br><span class="line">        <span class="type">ChatMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> contentInjector.inject(</span><br><span class="line">                finalContents,</span><br><span class="line">                UserMessage.from(message)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">systemMessage</span> <span class="operator">=</span> SystemMessage.from(</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        你是一个知识渊博的助手，请通俗易懂地回答我的问题。</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 历史消息</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">var</span> <span class="variable">messages</span> <span class="operator">=</span> chatMemoryProvider.get(userId)</span><br><span class="line">                .messages();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(messages)) &#123;</span><br><span class="line">            <span class="comment">// 第一次提问</span></span><br><span class="line">            messages.add(systemMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        messages.add(userMessage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// chat</span></span><br><span class="line">        <span class="type">ChatRequest</span> <span class="variable">chatRequest</span> <span class="operator">=</span> ChatRequest.builder()</span><br><span class="line">                .messages(messages)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// response</span></span><br><span class="line">        <span class="keyword">return</span> chatLanguageModel.chat(chatRequest)</span><br><span class="line">                .aiMessage()</span><br><span class="line">                .text();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>本文先按作者自己的理解讲述了对 langchain4j 框架的 RAG 实现流程以及各个组件的作用</p><p>然后通过编码的方式实现了一个简单的 RAG 例子，基本用上了 langchain4j 的大多组件</p><h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><ol><li>超出最大窗口大小</li></ol><p>项目中使用的对话记忆方案是 <code>TokenWindowChatMemory</code>，最大的 token 被设置为了 <code>10240</code>。如果把 <code>langchain4j.milvus.max-results</code> 和 <code>tavily.max-results</code> 都调整成 <code>50</code>，可以观察到一个很诡异的事情是明明网络搜索和内嵌数据库搜索一共 <code>100</code> 条记录，最后却没有发送给大模型</p><p><img src="https://static.wuhunyu.top/images/2025/06/389de0b02007355c734dffc88c93ad1e.png" alt="网络搜索和内嵌数据库搜索"></p><p><img src="https://static.wuhunyu.top/images/2025/06/88ce80c1de6140a7dc0605917adfb0d5.png" alt="发送给大模型的消息"></p><p>其实问题出在上图中的 <code>chatMemory.add(userMessage)</code> 代码(图中 175 行)。由于 100 条记录的长度超出了 10240 长度，因此被丢弃了这部分消息</p><p><img src="https://static.wuhunyu.top/images/2025/06/94359ba90ccaed43407837ada18846ac.png" alt="实际长度"></p><p>在生产开发过程中，还是需要注意一下最大窗口问题</p><ol start="2"><li>适配 OpenAI API</li></ol><p>OpenAI API 的官方文档地址是 <a href="https://platform.openai.com/docs/api-reference/chat/create">https://platform.openai.com/docs/api-reference/chat/create</a></p><p>在 <code>langchain4j-open-ai-spring-boot-starter</code> 依赖中，提供了 <code>dev.langchain4j.model.openai.internal.chat.ChatCompletionRequest</code> 和 <code>dev.langchain4j.model.openai.internal.chat.ChatCompletionResponse</code> 作为请求体类型和响应类型</p><p>一切都很完美是不是，我们需要实现 OpenAI API 接口的话，可以直接利用这两个类而不需要自己编写又臭又长还可能出错的 VO 类</p><p>但我现在要给你拨一瓢冷水了，<code>dev.langchain4j.model.openai.internal.chat.ChatCompletionRequest#messages</code> 的类型是一个接口，这意味着网络请求在反序列化时不清楚到底应该使用哪一个实现，因此不对它进行改造是会出错的</p><p>你可以将这个接口替换为某个实现类以修复这个问题</p><ol start="3"><li>高级语法无法传递 <code>ChatRequestParameters</code> 参数</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Experimental</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatRequestParameters</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">modelName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Double <span class="title function_">temperature</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Double <span class="title function_">topP</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">topK</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Double <span class="title function_">frequencyPenalty</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Double <span class="title function_">presencePenalty</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">maxOutputTokens</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; <span class="title function_">stopSequences</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;ToolSpecification&gt; <span class="title function_">toolSpecifications</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ToolChoice <span class="title function_">toolChoice</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ResponseFormat <span class="title function_">responseFormat</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> DefaultChatRequestParameters.Builder&lt;?&gt; builder() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultChatRequestParameters</span>.Builder&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ChatRequestParameters <span class="title function_">overrideWith</span><span class="params">(ChatRequestParameters parameters)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你使用过 <code>Gemini</code> 网页版或者像是 <code>Cherry Studio</code> 这样的客户端，应该能注意到在和大模型对话时，是可以调整一些参数的，比如 <code>temperature</code>，<code>maxOutputTokens</code> 等</p><p><code>langchain4j</code> 所谓的高级语法主要是基于 <code>@AiService</code> 这个注解。而这个注解的处理类是 <code>dev.langchain4j.service.DefaultAiServices</code></p><p>以非流式对话为例（代码片段为 <code>dev.langchain4j.service.DefaultAiServices</code> 的 214 行到 224 行）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChatRequestParameters</span> <span class="variable">parameters</span> <span class="operator">=</span> ChatRequestParameters.builder()</span><br><span class="line">        .toolSpecifications(toolExecutionContext.toolSpecifications())</span><br><span class="line">        .responseFormat(responseFormat)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="type">ChatRequest</span> <span class="variable">chatRequest</span> <span class="operator">=</span> ChatRequest.builder()</span><br><span class="line">        .messages(messages)</span><br><span class="line">        .parameters(parameters)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="type">ChatResponse</span> <span class="variable">chatResponse</span> <span class="operator">=</span> context.chatModel.chat(chatRequest);</span><br></pre></td></tr></table></figure><p>看出来了没，<code>ChatRequestParameters</code> 构建时就没有注入 <code>temperature</code>，<code>maxOutputTokens</code> 等这些参数</p><p>也就是说，使用高级语法时，是无法实现对这些参数进行调整的</p><p>同样，我在 <code>langchain4j</code> 仓库中找到了一个 <a href="https://github.com/langchain4j/langchain4j/issues/2410">issue</a></p><p>有一个评论是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Response&lt;AiMessage&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@UserMessage</span> String userMessage, <span class="meta">@ChatRequestParams</span> ChatRequestParameters params)</span>;</span><br></pre></td></tr></table></figure><p><code>@ChatRequestParams</code> 在 <code>langchain4j</code> 中是不存在的，这位兄弟想要通过注解的方式实现自定义 <code>ChatRequestParameters</code></p><p>但目前这个 <a href="https://github.com/langchain4j/langchain4j/issues/2410">issue</a> 还是 open 状态，目前如果有微调参数的需要，还是只能使用低级语法</p><p>不过值得注意的是，并不是所有大模型都支持这些参数的调整</p><h4 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h4><p><a href="https://github.com/wuhunyu/langchain4j-rag-example">GitHub</a></p><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://docs.langchain4j.dev/category/tutorials">langchain4j 官网</a></p>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;RAG-是什么&quot;&gt;&lt;a href=&quot;#RAG-是什么&quot; class=&quot;headerlink&quot; title=&quot;RAG 是什么&quot;&gt;&lt;/a&gt;RAG 是什么&lt;/h4&gt;&lt;p&gt;langchain4j 的官网给了一段通俗易懂的描述&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;简单来说，RAG 是一种在发送给 LLM 之前，从你的数据中找到并注入相关信息片段到提示中的方法&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;RAG 分为两个阶段，&lt;strong&gt;索引&lt;/strong&gt;和&lt;strong&gt;检索&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;关于&lt;strong&gt;检索&lt;/strong&gt;部分，下面的项目中将分别使用 langchain4j 的原生组件以及高级用法分别实现&lt;/p&gt;
&lt;p&gt;简单说明一下我对这两个阶段的理解&lt;/p&gt;</summary>
    
    
    
    <category term="ai" scheme="https://wuhunyu.top/categories/ai/"/>
    
    
    <category term="langchain4j" scheme="https://wuhunyu.top/tags/langchain4j/"/>
    
    <category term="rag" scheme="https://wuhunyu.top/tags/rag/"/>
    
  </entry>
  
  <entry>
    <title>自建音乐流媒体的碎碎念</title>
    <link href="https://wuhunyu.top/chat/2025/01/music-stram/index.html"/>
    <id>https://wuhunyu.top/chat/2025/01/music-stram/index.html</id>
    <published>2025-01-15T15:20:00.000Z</published>
    <updated>2026-01-07T07:38:46.860Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>首先谈谈我对<strong>音乐</strong>，以及<strong>流媒体</strong>的理解</p><p>我对音乐的狭义理解是：由乐器弹奏，或者人哼唱出来的歌。对于流媒体，我认为在网络上传播的影像记录就是流媒体</p><span id="more"></span><p>现在我们来看看维基百科给它们的定义</p><blockquote><p><a href="https://zh.wikipedia.org/wiki/%E9%9F%B3%E4%B9%90">音乐</a>，广义而言，就是指任何以声音组成的艺术。英文Music一词源于古希腊语的μουσική（mousike），意即缪斯（muse）女神的艺术。而中文的音乐二字，东汉许慎《说文解字》解释为“音，声也。生于心，有节于外，谓之音。”认为音乐和声音的区别，在于音乐需要透过人心去想像和创造。</p></blockquote><blockquote><p><a href="https://zh.wikipedia.org/wiki/%E6%B5%81%E5%AA%92%E4%BD%93">流媒体</a>（英语：Streaming media），指将一连串的多媒体资料压缩后，经过互联网分段发送资料，在互联网上即时传输影音以供观赏的一种技术与过程，此技术使得资料数据包得以像流水一样发送，如果不使用此技术，就必须在使用前下载整个媒体文件。</p></blockquote><p>除此之外，我在 <a href="https://music.aqzscn.cn/">音流</a> 这款软件的文档上，看到了一段这样的说明</p><p><img src="https://static.wuhunyu.top/images/2025/01/9d3e7b614de88998da0eb9ac8fdccd49.png" alt="音流-基本要求"></p><blockquote><p><a href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E9%99%84%E6%8E%A5%E5%AD%98%E5%82%A8">网络附接存储</a>（英语：Network Attached Storage，缩写：NAS）是一种文件级（与块级存储相对）的计算机数据存储服务器，它连接到计算机网络，并提供对异构网络用户的数据访问。它专门用于通过其硬件、软件或配置来提供文件服务。它通常作为专门制造的专用计算机设备制造。 NAS系统是包含一个或多个通常排列成逻辑存储器、冗余存储器或RAID存储驱动器的网络设备。NAS消除了从网络上的其他服务器提供文件服务的负担，它们通常使用网络文件共享协议（如NFS、SMB或AFP）提供对文件的访问。作为一种在多台计算机之间共享文件的便捷方法，NAS设备从1990年代中期开始开始流行起来。与同样提供文件服务的通用服务器相比，专用网络附加存储的潜在优势包括更快的数据访问、更简单的管理和简单的配置。</p></blockquote><p>我知道自建音乐流媒体是一个小众的需求，不过搭建一个音乐流媒体平台不需要借助 NAS 也是可行的，因为我观察到较为主流的开源流媒体服务都是支持 Docker 部署的</p><h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>起初我是没有想要自建流媒体服务的，那时我对一款音乐播放器的需求是这样的</p><ol><li>功能单一，只需要有基本的播放，收藏，查看歌词，歌手封面</li><li>有云盘功能，支持移动客户端上传音乐</li><li>没有广告（不充会员的情况）</li></ol><p>我还在用的两款音乐软件，<strong>酷狗</strong>，<strong>网易云音乐</strong>都是无法满足第一点和第三点的，而且我以前根本不敢想的弹窗广告和摇一摇广告竟然都出现了。以至于很长一段时间内，我都是使用<strong>Bilibili</strong>来听视频，反正我这个木耳朵也听不出来区别</p><p>24 年<a href="https://www.ruanyifeng.com/">阮一峰</a>的博客推荐了一个音乐流媒体服务，现在尝试找了找，没找到当时的那篇博客。当时我尝试安装了试用了一下，原本以为它能像是一个只拥有播放，网盘功能的酷狗音乐。结果登录Web页面之后，什么都没有。现在想起来，是需要我先把音乐文件喂给它，它只负责读取然后播放。当时觉得这个东西根本没法用，就放弃了</p><p>最近刷到了一篇文章，问大家都用的什么音乐播放器。里面有人回答，Apple Music，Spotify，网易云音乐。使用 Apple Music 的用户觉得没广告音质好，推荐Spotify的用户说曲库全还免费，还在用网易云音乐的用户说自己是永久会员</p><ul><li><p>就我个人而言，Apple Music 我也用过，周杰伦的歌也有，但我搜索进击的巨人时，给出的列表没有网易云音乐那样丰富</p></li><li><p>Spotify 我记得是有广告的，它是在听歌的间隙插入音频广告。也因为是国外设计的软件，用起来不习惯就放弃了。因为我听歌一般只认歌名和歌手，什么专辑对我而言是多余的东西</p></li><li><p>至于网易云音乐，广告以及功能太杂了，我觉得音乐播放器不应该这么臃肿</p></li></ul><p>在众多的评论中，我看到有些人回复了一些我没听过的名字，这个 <strong>音流</strong> 就是其中之一</p><p>搜索了一下 <strong>音流</strong>，提供四端应用（Mac，Windows，Android，iOS）。看官网给出的截图也挺纯净简洁，勾起了我自建音乐流媒体的兴趣</p><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>需要说明的是，我们经常说的<strong>网易云音乐</strong>，<strong>Apple Music</strong>它们只是一个音频播放器客户端，真正大量保存音乐资源的都是在服务器上，<strong>网易云音乐</strong>有<strong>网易云音乐</strong>的服务器，<strong>Apple Music</strong>也有<strong>Apple Music</strong>的服务器，这样做才能让我们在移动终端上不需要下载也能听到音乐传作者们发布的歌曲</p><p>那么需要自建音乐平台，至少也要有一个服务端和一个终端。如果把这个服务端类比成<strong>网易云音乐</strong>的服务器，终端类比成<strong>网易云音乐</strong>的手机 app 或者电脑端的 app，应该会更形象一些</p><h4 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h4><p>先确定了终端使用 <strong>音流</strong> 这款软件，那么就要看看音流这款移动终端它适配了哪些服务。这是 <strong>音流</strong> 官网给的适配功能对比</p><blockquote><p>第一行是各个流媒体服务的名称</p></blockquote><table><thead><tr><th align="left">功能</th><th align="left">Subsonic</th><th align="left">Navidrome</th><th align="left">Audio Station</th><th align="left">Emby</th><th align="left">Jellyfin</th><th align="left">Plex</th></tr></thead><tbody><tr><td align="left"><strong>内嵌歌词</strong></td><td align="left">-</td><td align="left">√</td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left"></td></tr><tr><td align="left"><strong>外置歌词</strong></td><td align="left">-</td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left">√</td></tr><tr><td align="left"><strong>在线歌词</strong></td><td align="left">-</td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left">√</td></tr><tr><td align="left"><strong>歌手简介</strong></td><td align="left">-</td><td align="left">√</td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left">√</td></tr><tr><td align="left"><strong>歌手头像</strong></td><td align="left">-</td><td align="left"></td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left">√</td></tr><tr><td align="left"><strong>多艺术家</strong></td><td align="left">-</td><td align="left"></td><td align="left">-</td><td align="left">√</td><td align="left">√</td><td align="left"></td></tr><tr><td align="left"><strong>回放增益</strong></td><td align="left">-</td><td align="left">√</td><td align="left">√</td><td align="left"></td><td align="left"></td><td align="left">√</td></tr><tr><td align="left"><strong>评分功能</strong></td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left"></td><td align="left"></td><td align="left">√</td></tr><tr><td align="left"><strong>收藏功能</strong></td><td align="left">√</td><td align="left">√</td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left"></td></tr><tr><td align="left"><strong>文件夹</strong></td><td align="left">-</td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left"></td><td align="left">√</td></tr><tr><td align="left"><strong>删除接口</strong></td><td align="left">-</td><td align="left"></td><td align="left"></td><td align="left">√</td><td align="left">√</td><td align="left">√</td></tr></tbody></table><p>这是各个流媒体服务的特性对比</p><table><thead><tr><th>特性&#x2F;平台</th><th><strong>Subsonic</strong></th><th><strong>Navidrome</strong></th><th><strong>Audio Station</strong></th><th><strong>Emby</strong></th><th><strong>Jellyfin</strong></th><th><strong>Plex</strong></th></tr></thead><tbody><tr><td><strong>定位</strong></td><td>音乐流媒体服务器</td><td>轻量级音乐服务器</td><td>Synology 专属音频服务</td><td>多媒体服务器</td><td>多媒体服务器</td><td>多媒体服务器</td></tr><tr><td><strong>开源</strong></td><td>部分开源</td><td>开源（GPL-3.0）</td><td>闭源</td><td>部分开源</td><td>开源（GPL-2.0）</td><td>闭源</td></tr><tr><td><strong>支持的媒体类型</strong></td><td>仅音频</td><td>仅音频</td><td>仅音频</td><td>音频、视频、图片</td><td>音频、视频、图片</td><td>音频、视频、图片</td></tr><tr><td><strong>跨平台支持</strong></td><td>是</td><td>是</td><td>否（仅 Synology NAS）</td><td>是</td><td>是</td><td>是</td></tr><tr><td><strong>客户端支持</strong></td><td>多种（Web、手机应用）</td><td>Web、手机应用</td><td>手机应用、浏览器</td><td>多种（Web、应用）</td><td>多种（Web、应用）</td><td>多种（Web、应用）</td></tr><tr><td><strong>多用户支持</strong></td><td>是</td><td>是</td><td>是</td><td>是</td><td>是</td><td>是</td></tr><tr><td><strong>离线下载</strong></td><td>是</td><td>是</td><td>否</td><td>是</td><td>是</td><td>是</td></tr><tr><td><strong>流媒体转码支持</strong></td><td>是</td><td>是</td><td>否</td><td>是</td><td>是</td><td>是</td></tr><tr><td><strong>字幕支持</strong></td><td>否</td><td>否</td><td>否</td><td>是</td><td>是</td><td>是</td></tr><tr><td><strong>多设备同步</strong></td><td>否</td><td>否</td><td>是</td><td>是</td><td>是</td><td>是</td></tr><tr><td><strong>免费使用</strong></td><td>部分功能</td><td>完全免费</td><td>包含于 Synology</td><td>部分功能免费</td><td>完全免费</td><td>部分功能免费</td></tr><tr><td><strong>高级功能付费</strong></td><td>是</td><td>否</td><td>不适用</td><td>是</td><td>否</td><td>是</td></tr><tr><td><strong>活跃社区</strong></td><td>较小</td><td>较小</td><td>专注于 Synology 用户群体</td><td>较大</td><td>较大</td><td>较大</td></tr><tr><td><strong>硬件需求</strong></td><td>较低</td><td>较低</td><td>依赖 Synology NAS</td><td>中等</td><td>中等</td><td>中等</td></tr><tr><td><strong>Docker 支持</strong></td><td>是</td><td>是</td><td>否</td><td>是</td><td>是</td><td>是</td></tr></tbody></table><p>我说说我的看法</p><p><strong>Subsonic</strong> 算是老牌的流媒体服务了，后续很多的流媒体服务都是基于 <strong>Subsonic</strong> 的 api 开发的，不过 <strong>Subsonic</strong> 基于 Java 开发的，资源消耗也会大一点，而且对我来说，它的功能有点复杂了</p><p><strong>Navidrome</strong> 是使用 Go 开发的，完全开源，在网上也看见了不少朋友在推荐，也满足我的基本要求，除了上传音乐的功能</p><p><strong>Audio Station</strong> 就不说了，我需要一个能 Docker 部署的服务</p><p>另外三个我没实际安装体验过就不发表意见了</p><p>除了上面的六个流媒体服务器之外，基于上传的需求，我找到了 <a href="https://github.com/airsonic-advanced/airsonic-advanced">airsonic-advanced</a>，一个基于 <strong>Subsonic</strong> 开发的流媒体服务器，也支持上传</p><p><img src="https://static.wuhunyu.top/images/2025/01/083f3afe250aa528b3e50d97dbc86aa6.png" alt="airsonic-advanced 首页"></p><p>不知道大家会不会觉得功能太复杂了，实际安装之后我觉得有些复杂了，自用的系统不需要这么多功能</p><p>那么最终就选定 <strong>Navidrome</strong> 了，开干</p><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><p>基于 <a href="https://www.navidrome.org/docs/installation">Navidrome 的安装文档</a>，很快都能配置完毕，以下是我的 docker compose 配置，仅供参考</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">navidrome:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">deluan/navidrome:0.54.3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">navidrome</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">user:</span> <span class="number">1000</span><span class="string">:1000</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">music</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ND_SCANSCHEDULE:</span> <span class="string">1h</span></span><br><span class="line">      <span class="attr">ND_LOGLEVEL:</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">ND_SESSIONTIMEOUT:</span> <span class="string">24h</span></span><br><span class="line">      <span class="attr">ND_DEFAULTLANGUAGE:</span> <span class="string">zh-Hans</span></span><br><span class="line">      <span class="attr">ND_ENABLETRANSCODINGCONFIG:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/music/data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/music/music:/music:ro</span></span><br><span class="line">  <span class="attr">lrcapi:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hisatri/lrcapi:1.5.7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">lrcapi</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">music</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">navidrome</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">API_AUTH=xxx</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/music/music:/music</span></span><br><span class="line">  <span class="attr">route-music:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">route-music</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3312</span><span class="string">:3312</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">music</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">navidrome</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">lrcapi</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/music/nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/applications/music/nginx/logs:/opt/nginx/logs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">music:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/HisAtri/LrcApi">hisatri&#x2F;lrcapi</a>:1.5.7：是一个补充服务，用于弥补 Navidrome 无法提供歌词和封面的缺陷</p></blockquote><h4 id="上传音乐"><a href="#上传音乐" class="headerlink" title="上传音乐"></a>上传音乐</h4><p><strong>自建的流媒体是没有任何音乐的，需要手动上传到流媒体服务器上</strong>。这也是我期望有上传功能的原因，但上传并没有在 <strong>Subsonic</strong> 的 api 中</p><p>我目前是通过 <strong>SFTP</strong> 上传到服务器的。我的听歌范围变化不那么频繁，这一步虽然麻烦但还能接受</p><h4 id="成果展示"><a href="#成果展示" class="headerlink" title="成果展示"></a>成果展示</h4><p><img src="https://static.wuhunyu.top/images/2025/01/f53b942d1d60d1ae2e0d9b310f444cfc.png" alt="Navidrome 首页"></p><p><img src="https://static.wuhunyu.top/images/2025/01/2080b64bba80be8f2eebc88868bed622.jpg" alt="音流-主页"></p><p><img src="https://static.wuhunyu.top/images/2025/01/0cd4820eaff90c84cd0c655ef5ae0ce9.jpg" alt="音流-列表"></p><p><img src="https://static.wuhunyu.top/images/2025/01/cd18b535764919120fcc0d70c4827aa3.jpg" alt="音流-歌词"></p><h4 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h4><p>首先 <strong>音流</strong> 确实很简洁，没有任何广告，基本功能除了一个上传也够我用</p><p>其它一些缺点在于，<strong>Navidrome</strong> 流媒体服务安装在我家里，网络延迟有点大，有时候会出现歌词加载不及时的问题。至于听歌本身我感觉下来还是没什么问题的，主要还是因为我的歌曲大都都是 128k 音质的，大小在 5MB 以内</p><p>如此如此~~</p>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;首先谈谈我对&lt;strong&gt;音乐&lt;/strong&gt;，以及&lt;strong&gt;流媒体&lt;/strong&gt;的理解&lt;/p&gt;
&lt;p&gt;我对音乐的狭义理解是：由乐器弹奏，或者人哼唱出来的歌。对于流媒体，我认为在网络上传播的影像记录就是流媒体&lt;/p&gt;</summary>
    
    
    
    <category term="碎碎念" scheme="https://wuhunyu.top/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
    <category term="音乐流媒体" scheme="https://wuhunyu.top/tags/%E9%9F%B3%E4%B9%90%E6%B5%81%E5%AA%92%E4%BD%93/"/>
    
    <category term="自建" scheme="https://wuhunyu.top/tags/%E8%87%AA%E5%BB%BA/"/>
    
  </entry>
  
  <entry>
    <title>2024年年中消费简述</title>
    <link href="https://wuhunyu.top/chat/2024/09/cost/index.html"/>
    <id>https://wuhunyu.top/chat/2024/09/cost/index.html</id>
    <published>2024-09-05T15:17:00.000Z</published>
    <updated>2026-01-07T07:38:46.860Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h3><p>简单总结一个自从三月来深圳的大体消费支出情况</p><h3 id="基本情况"><a href="#基本情况" class="headerlink" title="基本情况"></a>基本情况</h3><ol><li>2024 年 3 月到 4 月中旬前，处于求职状态，这个时候暂无收入</li><li>2024 年 4 月下旬至今，由于有了工作，每月的开销都相对固定</li></ol><h3 id="消费类别"><a href="#消费类别" class="headerlink" title="消费类别"></a>消费类别</h3><p>个人的支出情况主要分为几大类</p><ol><li>住宿</li><li>饮食</li><li>交通</li><li>零食</li><li>生活用品</li><li>其它购物</li></ol><p>在求职阶段，主要消费类别集中在前三项</p><span id="more"></span><h3 id="消费细项"><a href="#消费细项" class="headerlink" title="消费细项"></a>消费细项</h3><h4 id="求职阶段"><a href="#求职阶段" class="headerlink" title="求职阶段"></a>求职阶段</h4><h5 id="住宿"><a href="#住宿" class="headerlink" title="住宿"></a>住宿</h5><p>住宿是消费的大头，求职阶段我的住宿是先住酒店落脚，后面找民宿 &#x2F; 公寓缓解住宿费用高的压力</p><blockquote><p>如果是初来深圳没有工作，且没有熟人帮衬的情况，先住酒店，后面换民宿 &#x2F; 公寓我认为是很好解决住宿问题的方案</p><p>如果确实没资金，还可以考虑青旅。青旅即便在南山区 &#x2F; 福田区的繁华地段，也能找到 30 &#x2F; 日的青旅。但我不推荐的青旅，因为青旅多是多人一间，这很考验人的睡眠质量。曾经我住过一次两天的青旅，较为常住的下铺室友貌似是跑外卖的，但他这个外卖员不是天天做的（我有天出去面试，正常人工作时间回来发现他还在床上）。无论你是想要正常休息，还是准备面试，青旅的环境都绝不是一个好地方</p></blockquote><p>我记得我第一次来深圳，选在了深圳市宝安区的翻身地铁站附近（后来了解到这个站算是宝安区比较繁华的一个地方），因为有酒店信任优惠，大概 160 &#x2F; 日，连续住宿了两三天</p><p>一方面，因为出来深圳，不清楚面试地点主要集中在那一个区域，所以这个时候我的住宿地点一方面受近期面试的公司地点影响；另一方面，也受到酒店 &#x2F; 民宿 &#x2F; 公寓的日租价格影响</p><blockquote><p>我比较常用的住宿订购软件是美团，简单说说遇到的两个糟心事</p><ol><li>前一天定好的民宿，到了之后被告知没空房了。所以一定要先在美团上提前和房东打招呼，询问好是否在入住的那天有空房</li><li>共享电动车有地区范围限制。扫码开锁之后没走一百米就提示超出了服务区域，被强制停电了。这个属于是我没注意看软件说明导致的</li></ol></blockquote><p>选择比较偏远的地方酒店 &#x2F; 民宿，可以把短租的住宿费用降低到 100 &#x2F; 日左右</p><blockquote><p>这个价位的酒店环境可能就比较一般了，你住宿的酒店可能会有以下问题</p><ol><li>酒店位置偏远。可能距离地铁比较远</li><li>酒店卫生一般</li><li>入住时房间的烟味甚至也没有散去</li><li>sex 方面的小广告，小玩具等</li></ol><p>民宿的话</p><ol><li>费用较低，比如 90 &#x2F; 日，房东可能不会提供空调服务。如果有电风扇，看当天的天气是否能接受</li><li>蟑螂多。这个生物在广州，深圳都是很常见的，如果非常害怕这个的话，要么多花钱去卫生条件好的地段，要么就不要来广州深圳（认真脸）</li></ol></blockquote><h5 id="饮食"><a href="#饮食" class="headerlink" title="饮食"></a>饮食</h5><p>饮食消费主要看住宿的地方</p><p>早餐</p><blockquote><p>早操因为深圳的地摊很多，如果你能接受炒面炒粉做早餐，我想早餐完全可以控制在 5 &#x2F; 日以内，即便是在福田区，南山区这些地方</p></blockquote><p>午餐，由于午餐有时候会处于两段面试中间，所以午餐需要在相对繁华的地段解决，这个时候我偏向于面食类午餐</p><blockquote><p>午餐我一般吃面，一方面面食相对较为便宜，消费一般都能在 20 &#x2F; 顿以内</p><p>或者能找到快餐店，消费也不会高出太多。大概在 (10 , 30) 这个范围浮动吧</p></blockquote><p>晚餐，一般回到住处附近吃</p><blockquote><p>一天三顿最好有一顿是大米饭的。如果硬是要给一个范围的话，30 &#x2F; 顿我是可以保证的。如果去一些快餐店（比如什么木桶饭），一般能够保持在 20 &#x2F; 顿以内</p></blockquote><p>其他</p><p>一天如果上下午都有面试，我是不回住宿的地方。中午解决完毕午餐之后，还需要找个地方能让我等到面试时间。这个地点一般是各种奶茶店</p><blockquote><p>我以前比较少喝什么喜茶，瑞幸。来了深圳之后这些奶茶和家里的三线小城市相比物价方面也还差不多吧（当然，不要选购贵的）</p></blockquote><h5 id="交通"><a href="#交通" class="headerlink" title="交通"></a>交通</h5><p>在深圳交通费用基本是地铁。我的消费主要是地铁 + 共享单车，以及几次来回深圳的高铁费用</p><blockquote><p>关于交通，我可以很认真地说，住宿的地点一定要选择离地铁近的。这样无论的工作地点在哪里，至少你能到达（中间可能需要多次转路线）</p><p>关于地铁，如果是 iPhone 手机用户，建议开启深圳通（打95折），而且开卡不需要手续费；如果是安卓用户，开卡需要手续费，不打算长期或者暂时无法遇见是否能长期呆在深圳的话，建议使用微信小程序付费（没有优惠）</p><p>深圳地铁的费用我个人觉得不低，但确实很方便出行</p><p>然后就是，深圳地铁 11 号线真的多人，每天都要挤这条线的人感觉绝望又无奈</p></blockquote><h5 id="零食"><a href="#零食" class="headerlink" title="零食"></a>零食</h5><p>–</p><h5 id="生活用品"><a href="#生活用品" class="headerlink" title="生活用品"></a>生活用品</h5><p>生活用品我大部分都是随行李箱自带，除了洗衣粉</p><h5 id="其他购物"><a href="#其他购物" class="headerlink" title="其他购物"></a>其他购物</h5><p>这个阶段除了必须的物品，一律一毛不拔</p><blockquote><p>有部分费用，比如简历的打印费用，在深圳无论是繁华地段还是偏远地段，都是 1 &#x2F; 张，在广州的一家打印店我倒是遇到一次几毛钱一张的。简历的打印我一般推荐一次不要打印过多份，一方面可能有修改的需求；另一方面A4纸在身上很容易被弄出折痕</p></blockquote><h4 id="工作阶段"><a href="#工作阶段" class="headerlink" title="工作阶段"></a>工作阶段</h4><h5 id="住宿-1"><a href="#住宿-1" class="headerlink" title="住宿"></a>住宿</h5><p>在深圳宝安区 11 号线附近找了一处 1000 &#x2F; 月的一室一卫，每月加上水电网费，大概在 1200 &#x2F; 月</p><blockquote><p>关于住宿，如果可以离公司很近，那无所谓，如果离公司很远，那必须选择离地铁站 1 公里以内的</p></blockquote><h5 id="饮食-1"><a href="#饮食-1" class="headerlink" title="饮食"></a>饮食</h5><p>早餐</p><blockquote><p>一般 3 &#x2F; 顿，两个包子。周末 5 &#x2F; 顿，肠粉</p></blockquote><p>中餐</p><blockquote><p>工作提供了 500 &#x2F; 月的餐补，勉强够工作日中餐的消费。大概 25 &#x2F; 顿，不够的是否需要自己补上一部分</p></blockquote><p>晚餐</p><blockquote><p>如果当晚跑步，一般吃面食。住宿附近的面食比较便宜，可以控制在 13 &#x2F; 顿以内</p><p>如果没有跑步，可能会选择米饭，各种快餐店（比如木桶饭），大概能控制在 15 &#x2F; 顿左右</p></blockquote><p>其他</p><blockquote><p>周末可能和朋友一起在外面搓一顿，消费一般在 300 &#x2F; 次以内</p></blockquote><h5 id="交通-1"><a href="#交通-1" class="headerlink" title="交通"></a>交通</h5><p>地铁</p><blockquote><p>每个工作日的早晨都是在挤深圳 11 号线的路上，固定消费 7 &#x2F; 次，一天一个来回，一共 14 &#x2F; 天，会有一点点打折（95折）</p><p>如果不幸中途出站上厕所，可能会把当天的地铁消费提高 1 - 2 元</p></blockquote><p>共享单车</p><blockquote><p>有时候周末去图书馆骑共享单车，一个月下来共享单车的消费应该不到 20 &#x2F; 月</p></blockquote><h5 id="零食-1"><a href="#零食-1" class="headerlink" title="零食"></a>零食</h5><blockquote><p>每个星期大概都会有 50 左右的消费在零食上面</p></blockquote><h5 id="生活用品-1"><a href="#生活用品-1" class="headerlink" title="生活用品"></a>生活用品</h5><blockquote><p>T恤，我比较喜欢纯白纯棉的，然后在深圳的几个月里，因为多雨的天气坏了三件</p><p>裤子，鞋子，洗衣粉，电风扇，电热锅，洗洁精等等</p></blockquote><h5 id="其他购物-1"><a href="#其他购物-1" class="headerlink" title="其他购物"></a>其他购物</h5><blockquote><p>我的衣服都是晚上购物的</p><p>近期购买了一个 小米平板（3200）送妹妹生日</p></blockquote><h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><ol><li>初来深圳先住酒店落脚，后面换成靠近地铁的民宿 &#x2F; 公寓</li><li>只要没有住在繁华的地段，饮食的消费一般不会太过分，一般能在住宿附近解决就在住宿附近解决</li><li>地铁是绝大多数深圳打工人的出行方式，可以在线办理深圳通，有一点点优惠</li></ol><h3 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h3><p>深圳虽然确实也没啥可玩的，但来了深圳。可以在面试或者工作之余去爬爬山，逛逛商场。生活不只有工作，一旦工作起来，下一次连续的工作日长假就要等离职了</p><p><img src="https://static.wuhunyu.top/images/2024/08/fenghuang.jpg" alt="梧桐山"></p><p><img src="https://static.wuhunyu.top/images/2024/08/me.jpg" alt="我"></p><p><img src="https://static.wuhunyu.top/images/2024/08/rainbow.jpg" alt="彩虹"></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;简述&quot;&gt;&lt;a href=&quot;#简述&quot; class=&quot;headerlink&quot; title=&quot;简述&quot;&gt;&lt;/a&gt;简述&lt;/h3&gt;&lt;p&gt;简单总结一个自从三月来深圳的大体消费支出情况&lt;/p&gt;
&lt;h3 id=&quot;基本情况&quot;&gt;&lt;a href=&quot;#基本情况&quot; class=&quot;headerlink&quot; title=&quot;基本情况&quot;&gt;&lt;/a&gt;基本情况&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;2024 年 3 月到 4 月中旬前，处于求职状态，这个时候暂无收入&lt;/li&gt;
&lt;li&gt;2024 年 4 月下旬至今，由于有了工作，每月的开销都相对固定&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;消费类别&quot;&gt;&lt;a href=&quot;#消费类别&quot; class=&quot;headerlink&quot; title=&quot;消费类别&quot;&gt;&lt;/a&gt;消费类别&lt;/h3&gt;&lt;p&gt;个人的支出情况主要分为几大类&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;住宿&lt;/li&gt;
&lt;li&gt;饮食&lt;/li&gt;
&lt;li&gt;交通&lt;/li&gt;
&lt;li&gt;零食&lt;/li&gt;
&lt;li&gt;生活用品&lt;/li&gt;
&lt;li&gt;其它购物&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在求职阶段，主要消费类别集中在前三项&lt;/p&gt;</summary>
    
    
    
    <category term="碎碎念" scheme="https://wuhunyu.top/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
    <category term="消费" scheme="https://wuhunyu.top/tags/%E6%B6%88%E8%B4%B9/"/>
    
    <category term="个人总结" scheme="https://wuhunyu.top/tags/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>搭建自己的 docker-hub 仓库</title>
    <link href="https://wuhunyu.top/tools/make-self-docker-hub/index.html"/>
    <id>https://wuhunyu.top/tools/make-self-docker-hub/index.html</id>
    <published>2024-07-12T16:52:00.000Z</published>
    <updated>2026-01-07T07:38:46.863Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>之前写了一篇通过 GitHub Actions 的容器作为中转拉取 docker-hub 博客，不过使用的还是阿里云的镜像仓库</p><p>GitHub 上有推荐自建仓库的开源项目，比如 <a href="https://github.com/bboysoulcn/registry-mirror">registry-mirror</a></p><p>网上虽然有不少活雷锋把自己的仓库开源出来，不过不少是限速的，拉取小镜像还好，一旦需要拉取像是 elasticsearch 这样大的镜像，又可能会因为拉取速度太慢导致多次重试，最后失败</p><p>这次，我也来试试自建仓库。自建的 docker 仓库，都是基于官方的一个镜像 <strong>registry</strong></p><span id="more"></span><p><img src="https://static.wuhunyu.top/images/2024/07/88b27363622a2c7b86852f35e01f0700.png" alt="image-20240712234628328"></p><p>下面简单说说自建仓库的过程</p><h4 id="资源准备"><a href="#资源准备" class="headerlink" title="资源准备"></a>资源准备</h4><ol><li>域名和证书</li></ol><blockquote><p>这个倒不是必须的，但 Docker 默认不允许非 <code>HTTPS</code> 方式推送镜像的</p></blockquote><ol start="2"><li>镜像 <code>httpd</code></li></ol><blockquote><p>这里选择的是 <code>httpd:alpine</code>，这个镜像主要用来生成 http 认证文件</p></blockquote><ol start="3"><li>镜像 <code>registry</code></li></ol><blockquote><p>这里选择的是 <code>registry:latest</code>，搭建自己 docker 仓库就靠它了</p></blockquote><h4 id="编写配置"><a href="#编写配置" class="headerlink" title="编写配置"></a>编写配置</h4><h5 id="http-认证文件"><a href="#http-认证文件" class="headerlink" title="http 认证文件"></a>http 认证文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把命令中的 username 和 password 换成自己的用户名称和密码即可，后续 docker login 时需要通过这个凭证来登陆自己搭建好的 docker 仓库</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">docker run --<span class="built_in">rm</span> \</span></span><br><span class="line"><span class="language-bash">    --entrypoint htpasswd \</span></span><br><span class="line"><span class="language-bash">    httpd:alpine \</span></span><br><span class="line"><span class="language-bash">    -Bbn username password &gt; auth/nginx.htpasswd</span></span><br></pre></td></tr></table></figure><h5 id="config-yml"><a href="#config-yml" class="headerlink" title="config.yml"></a>config.yml</h5><p>这个配置文件是 <code>registry</code> 的配置文件，默认位置在 <code>/etc/docker/registry/config.yml</code></p><p>另外，值得注意的是，保存在仓库中的镜像默认存放在 <code>/var/lib/registry</code> 目录下</p><p>此外，<code>http.tls</code> 还配置了公私钥，比如我的域名是 <code>docker.wuhunyu.top</code></p><p>以下是示例配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">accesslog:</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">warn</span></span><br><span class="line">  <span class="attr">formatter:</span> <span class="string">text</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">staging</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">filesystem:</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/var/lib/registry</span></span><br><span class="line"><span class="attr">auth:</span></span><br><span class="line">  <span class="attr">htpasswd:</span></span><br><span class="line">    <span class="attr">realm:</span> <span class="string">basic-realm</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/docker/registry/auth/nginx.htpasswd</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">addr:</span> <span class="string">:443</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">https://docker.wuhunyu.top</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> [<span class="string">nosniff</span>]</span><br><span class="line">  <span class="attr">http2:</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">certificate:</span> <span class="string">/etc/docker/registry/ssl/docker.wuhunyu.top.pem</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">/etc/docker/registry/ssl/docker.wuhunyu.top.key</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><h5 id="docker-compose-配置脚本"><a href="#docker-compose-配置脚本" class="headerlink" title="docker-compose 配置脚本"></a>docker-compose 配置脚本</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">docker-registry</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/wuhunyu/registry/config.yml:/etc/docker/registry/config.yml:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/wuhunyu/registry/repository:/var/lib/registry</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/wuhunyu/registry/auth/nginx.htpasswd:/etc/docker/registry/auth/nginx.htpasswd:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/wuhunyu/cert/docker.wuhunyu.top.pem:/etc/docker/registry/ssl/docker.wuhunyu.top.pem:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/wuhunyu/cert/docker.wuhunyu.top.key:/etc/docker/registry/ssl/docker.wuhunyu.top.key:ro</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">docker-registry:</span> </span><br></pre></td></tr></table></figure><p>分别指定了 <code>registry</code> 的配置文件，暴露仓库镜像数据卷，指定 <code>http</code> 认证文件以及公私钥文件</p><p>配置完毕之后，我的目录结构如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registry</span><br><span class="line">├── auth</span><br><span class="line">│   └── nginx.htpasswd</span><br><span class="line">├── config.yml</span><br><span class="line">├── docker-registry.yml</span><br><span class="line">└── repository</span><br></pre></td></tr></table></figure><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>通过 <code>docker-compose -f docker-registry.yml up -d </code> 完成自建仓库的部署</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+] Building 0.0s (0/0)                                                                                         docker:default</span><br><span class="line">[+] Running 2/2</span><br><span class="line"> ✔ Network registry_default   Created                                                                                     0.1s</span><br><span class="line"> ✔ Container docker-registry  Started                                                                                     0.0s</span><br></pre></td></tr></table></figure><p>通过 <code>docker ps | grep docker-registry </code> 可以观察到容器是否正常运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3e3d14457946   registry:latest  &quot;/entrypoint.sh /etc…&quot;2 minutes agoUp 2 minutes5000/tcp, 0.0.0.0:443-&gt;443/tcp, :::443-&gt;443/tcpdocker-registry</span><br></pre></td></tr></table></figure><h4 id="登录仓库"><a href="#登录仓库" class="headerlink" title="登录仓库"></a>登录仓库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">docker login docker.wuhunyu.top</span></span><br></pre></td></tr></table></figure><h4 id="对需要上传的镜像打标签"><a href="#对需要上传的镜像打标签" class="headerlink" title="对需要上传的镜像打标签"></a>对需要上传的镜像打标签</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里以 openjdk:21-jdk-slim 为例</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">docker tag openjdk:21-jdk-slim docker.wuhunyu.top/openjdk:21-jdk-slim</span></span><br></pre></td></tr></table></figure><h4 id="推送镜像到自建仓库"><a href="#推送镜像到自建仓库" class="headerlink" title="推送镜像到自建仓库"></a>推送镜像到自建仓库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里以 openjdk:21-jdk-slim 为例</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">docker push docker.wuhunyu.top/openjdk:21-jdk-slim</span></span><br></pre></td></tr></table></figure><h4 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">docker <span class="built_in">logout</span> docker.wuhunyu.top</span></span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>自建的仓库服务我放在自己的云服务器上，最所周知，带宽资源才是最昂贵的，阿里云对流入的流量我在上传镜像的时候感觉还行，上传近 1G 的镜像，能在一分钟内跑完，到了拉取镜像就开始不好了，1G 的镜像拉取了 5 分钟都还没结束，这个和我的带宽有关，我的带宽只有 3 Mbps</p><p>最后总结为自建的 docker 仓库还不好用，主要是我不想为网络资源额外付费</p><h3 id="引用资源"><a href="#引用资源" class="headerlink" title="引用资源"></a>引用资源</h3><blockquote><p><a href="https://github.com/bboysoulcn/registry-mirror">registry-mirror</a></p><p><a href="https://yeasy.gitbook.io/docker_practice/repository/registry">私有仓库</a></p><p><a href="https://yeasy.gitbook.io/docker_practice/repository/registry_auth">私有仓库高级配置</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;之前写了一篇通过 GitHub Actions 的容器作为中转拉取 docker-hub 博客，不过使用的还是阿里云的镜像仓库&lt;/p&gt;
&lt;p&gt;GitHub 上有推荐自建仓库的开源项目，比如 &lt;a href=&quot;https://github.com/bboysoulcn/registry-mirror&quot;&gt;registry-mirror&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;网上虽然有不少活雷锋把自己的仓库开源出来，不过不少是限速的，拉取小镜像还好，一旦需要拉取像是 elasticsearch 这样大的镜像，又可能会因为拉取速度太慢导致多次重试，最后失败&lt;/p&gt;
&lt;p&gt;这次，我也来试试自建仓库。自建的 docker 仓库，都是基于官方的一个镜像 &lt;strong&gt;registry&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Docker Hub" scheme="https://wuhunyu.top/categories/Docker-Hub/"/>
    
    
    <category term="Docker Hub" scheme="https://wuhunyu.top/tags/Docker-Hub/"/>
    
  </entry>
  
  <entry>
    <title>GitHub Actions 简单使用</title>
    <link href="https://wuhunyu.top/tools/github-actions-example/index.html"/>
    <id>https://wuhunyu.top/tools/github-actions-example/index.html</id>
    <published>2024-06-30T14:32:00.000Z</published>
    <updated>2026-01-07T07:38:46.863Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="GitHub-Actions-是什么"><a href="#GitHub-Actions-是什么" class="headerlink" title="GitHub Actions 是什么"></a>GitHub Actions 是什么</h4><h5 id="官方文档-是这么介绍的"><a href="#官方文档-是这么介绍的" class="headerlink" title="官方文档 是这么介绍的"></a><a href="https://docs.github.com/zh/actions">官方文档</a> 是这么介绍的</h5><blockquote><p>在 GitHub Actions 的仓库中自动化、自定义和执行软件开发工作流程。 您可以发现、创建和共享操作以执行您喜欢的任何作业（包括 CI&#x2F;CD），并将操作合并到完全自定义的工作流程中。</p></blockquote><h5 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h5><p>可以理解为一个有条件（比如push事件，也可以是 cron 表达式定义的一个定时任务）触发的工作流任务。而这个工作流任务是可以由我们开发者自定义的，执行这些任务的环境由 GitHub 提供，一般是 ubuntu 环境。通过这个环境，我们可以执行一些自定义脚本，亦或是调用其他开发者发布的插件来实现一些开发者想要的功能</p><span id="more"></span><h4 id="GitHub-Actions-可以做什么"><a href="#GitHub-Actions-可以做什么" class="headerlink" title="GitHub Actions 可以做什么"></a>GitHub Actions 可以做什么</h4><p>传统 CI&#x2F;CD 能做的编译，打包，发布，使用 GitHub Actions 肯定也是能实现的</p><p>这里，我想使用两个我自己的案例来演示说明，我使用 GitHub Actions 做了些什么</p><ol><li>个人博客编译，打包，发布</li><li>作为拉取 docker-hub 官方镜像的中转工具</li></ol><h4 id="前置准备工作"><a href="#前置准备工作" class="headerlink" title="前置准备工作"></a>前置准备工作</h4><h5 id="如何自定义工作流任务"><a href="#如何自定义工作流任务" class="headerlink" title="如何自定义工作流任务"></a>如何自定义工作流任务</h5><blockquote><p>只需要在仓库存在 .github&#x2F;workflows&#x2F;*.yml，在满足触发条件之后，就会被自动执行</p><p>这个配置文件可以有多个，执行的时候是并行的，但也可以定义工作流的依赖关系实现串行化</p></blockquote><h5 id="关于执行环境"><a href="#关于执行环境" class="headerlink" title="关于执行环境"></a>关于执行环境</h5><blockquote><p>可以自定义选择 Linux，Windows 和 macOS，具体的版本可以访问<a href="https://docs.github.com/zh/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#%E7%94%A8%E4%BA%8E%E5%85%AC%E5%85%B1%E5%AD%98%E5%82%A8%E5%BA%93%E7%9A%84-github-%E6%89%98%E7%AE%A1%E7%9A%84%E6%A0%87%E5%87%86%E8%BF%90%E8%A1%8C%E5%99%A8">这里</a>查看</p><p>Linux 环境已经自带了 Docker 环境，无需重复安装</p></blockquote><h5 id="关于插件"><a href="#关于插件" class="headerlink" title="关于插件"></a>关于插件</h5><blockquote><p>GitHub Actions 的插件分为官方和非官方的，其中官方的插件地址都是 <a href="https://github.com/actions">https://github.com/actions</a> 开头的</p><p>比如检出仓库代码的插件 <a href="https://github.com/actions/checkout">checkout</a></p><p>比如第三方部署到 GitHub Pages 的插件 <a href="https://github.com/peaceiris/actions-gh-pages">peaceiris&#x2F;actions-gh-pages</a></p><p>可以在 <a href="https://github.com/marketplace?type=actions">GitHub 市场</a> 中寻找符合自己需求的插件</p></blockquote><h4 id="个人博客编译，打包，发布"><a href="#个人博客编译，打包，发布" class="headerlink" title="个人博客编译，打包，发布"></a>个人博客编译，打包，发布</h4><p>.github&#x2F;workflows&#x2F;deploy.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">My</span> <span class="string">Hexo</span> <span class="string">Blog</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># 权限控制</span></span><br><span class="line">    <span class="attr">permissions:</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">read</span></span><br><span class="line">      <span class="attr">pages:</span> <span class="string">write</span></span><br><span class="line">      <span class="attr">id-token:</span> <span class="string">write</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># 检出仓库代码</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">Repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 设置 Node.js 版本</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;20.9.0&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 缓存 npm 依赖</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cache</span> <span class="string">npm</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/cache@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">~/.npm</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-node-$&#123;&#123;</span> <span class="string">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class="string">&#125;&#125;-v2</span></span><br><span class="line">          <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.os &#125;&#125;-node-</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># 安装 Hexo CLI</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Hexo</span> <span class="string">CLI</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-cli</span> <span class="string">-g</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 安装 npm 依赖</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">npm</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npm install --prefix themes/icarus</span></span><br><span class="line"><span class="string">          npm install</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># 生成静态文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Generate</span> <span class="string">static</span> <span class="string">files</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          hexo clean</span></span><br><span class="line"><span class="string">          hexo g</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># 部署到云服务器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Cloud</span> <span class="string">Server</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">easingthemes/ssh-deploy@main</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">SSH_PRIVATE_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PRIVATE_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">ARGS:</span> <span class="string">&quot;-avz --delete&quot;</span></span><br><span class="line">          <span class="attr">SOURCE:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SOURCE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">REMOTE_HOST:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.HOST</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">REMOTE_PORT:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PORT</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">REMOTE_USER:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.USER</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">TARGET:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TARGET</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 部署到 wuhunyu.github.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Github</span> <span class="string">Pages</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">personal_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ACCESS_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">external_repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PAGE_REPO</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_branch:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PAGE_BRAN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SOURCE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">commit_message:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.head_commit.message</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>简单说明一下这个 actions 的内容</p><ol><li>actions 的名称是 <em>Deploy My Hexo Blog</em></li><li>当仓库的 <em>main</em> 分支有 <em>push</em> 事件发生时自动触发</li><li>工作流的执行环境是 <em>ubuntu-latest</em></li><li>其次是关于权限控制的说明</li><li>最后按 <em>steps</em> 的声明顺序，任务会被依次执行，如果中途出现了错误，则会直接中断后续的任务。每个任务的作用在注释中已经写了，就不再多说明了。值得注意的是，其中有 <code>$&#123;&#123;  &#125;&#125;</code> 的符号，这是从当前上下文取值的占位符，其中 <strong>secrets</strong> 是由开发者自定义的环境变量，具体可以在每个仓库的 <code>settings/secrets/actions</code> 进行设置</li></ol><p><img src="https://static.wuhunyu.top/images/2024/06/7631a3db1b24d68fe0d18630998a5162.png" alt="image-20240630185544912"></p><p>action 运行的控制台像这样，按执行顺序列出了每个任务的日志</p><p><img src="https://static.wuhunyu.top/images/2024/06/1c023d19c47e86b7cfa3e838ce12dbf8.png" alt="image-20240630185756456"></p><h4 id="作为拉取-docker-hub-官方镜像的中转工具"><a href="#作为拉取-docker-hub-官方镜像的中转工具" class="headerlink" title="作为拉取 docker-hub 官方镜像的中转工具"></a>作为拉取 docker-hub 官方镜像的中转工具</h4><blockquote><p>前些天在掘金上看到了有人已经实现了，功能要比我这个更加健壮，地址如下</p><p><a href="https://github.com/tech-shrimp/docker_image_pusher">docker_image_pusher</a></p><p>下面展示的这个工具是我个人使用，每次拉取镜像也不会太大，像是磁盘不够的情况暂时还不需要考虑</p></blockquote><p><a href="https://github.com/wuhunyu/docker-hub/blob/main/.github/workflows/docker-hub.yml">.github&#x2F;workflows&#x2F;docker-hub.yml</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Pull</span> <span class="string">and</span> <span class="string">Push</span> <span class="string">Docker</span> <span class="string">Images</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># 检出仓库代码</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">Repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment"># 安装 jq 以处理 JSON 文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">jq</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">sudo</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">jq</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment"># 登录到阿里云容器镜像服务</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Log</span> <span class="string">in</span> <span class="string">to</span> <span class="string">Alibaba</span> <span class="string">Cloud</span> <span class="string">Registry</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; secrets.ALIYUN_REGISTRY_PASSWORD &#125;&#125;</span>&quot;</span> <span class="string">|</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; secrets.ALIYUN_REGISTRY_USERNAME &#125;&#125;</span>&quot;</span> <span class="string">registry.cn-guangzhou.aliyuncs.com</span> <span class="string">--password-stdin</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 拉取和推送 Docker 镜像</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Pull</span> <span class="string">and</span> <span class="string">Push</span> <span class="string">Docker</span> <span class="string">images</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">ALIYUN_NAMESPACE:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ALIYUN_REGISTRY_NAMESPACE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          for image in $(jq -r &#x27;.[]&#x27; images.json); do</span></span><br><span class="line"><span class="string">            echo &quot;Processing image: $&#123;image&#125;&quot;</span></span><br><span class="line"><span class="string">            docker pull $&#123;image&#125;</span></span><br><span class="line"><span class="string">            aliyun_image=&quot;registry.cn-guangzhou.aliyuncs.com/$&#123;&#123; env.ALIYUN_NAMESPACE &#125;&#125;/$&#123;image##*/&#125;&quot;</span></span><br><span class="line"><span class="string">            docker tag $&#123;image&#125; $aliyun_image</span></span><br><span class="line"><span class="string">            docker push $&#123;aliyun_image&#125;</span></span><br><span class="line"><span class="string">          done</span></span><br></pre></td></tr></table></figure><ol><li><p>同样也是当仓库的 <em>main</em> 分支有 <em>push</em> 事件发生时自动触发</p></li><li><p>之后登陆阿里云的 docker hub 镜像</p></li><li><p>读取仓库中的 <em>images.json</em> 配置文件，形如</p></li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line"> <span class="string">&quot;redis&quot;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="string">&quot;nginx:latest&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><ol start="4"><li><p>在容器内 <em>pull</em> 镜像之后再 <em>push</em> 给阿里云的 docker hub</p><ul><li>这里利用 actions 的容器可访问外网的能力将 docker 镜像中转到内网可访问的镜像站</li></ul></li></ol><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>除了以上两个案例，GitHub 有一个叫 <a href="https://docs.github.com/zh/repositories/releasing-projects-on-github/about-releases">Releases</a> 的概念，也可以借由 GitHub Actions 来打包</p><p><a href="https://github.com/wuhunyu/starter/blob/main/.github/workflows/buildAndRelease.yml">.github&#x2F;workflows&#x2F;buildAndRelease.yml</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">And</span> <span class="string">Release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;v*.*.*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">Code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">Up</span> <span class="string">JDK</span> <span class="number">21</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-java@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">java-version:</span> <span class="string">&#x27;21&#x27;</span></span><br><span class="line">          <span class="attr">distribution:</span> <span class="string">&#x27;adopt&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Maven</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">package</span> <span class="string">-DskipTests</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">create_release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/create-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">tag_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">release_name:</span> <span class="string">Release</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">draft:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">prerelease:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">JAR</span> <span class="string">to</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-release-asset@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">upload_url:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.create_release.outputs.upload_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">asset_path:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ASSET_PATH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">asset_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ASSET_NAME</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">asset_content_type:</span> <span class="string">application/java-archive</span></span><br></pre></td></tr></table></figure><blockquote><p>Releases 基于 tag，所以需要 actions 的触发条件可以设置为 tag 被 push 时</p></blockquote><p>效果如下</p><p><img src="https://static.wuhunyu.top/images/2024/06/69d8b8b6017d6221e901e04d4ce2176c.png" alt="image-20240630220015641"></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol><li>GitHub Actions 是 GitHub 免费开放给开发者的自动化工作流</li><li>基于 GitHub Actions，可以解放部分项目本地编译，部署的服务器资源。我借用这个功能实现了几个小功能，包括个人博客的编译部署，docker hub 镜像中转工具</li></ol><h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><p>如果借用 GitHub Actions 的容器资源来做爬虫节点是不是也挺好，官方给的服务器资源配置也还不错，可以查看<a href="https://docs.github.com/zh/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#%E7%94%A8%E4%BA%8E%E5%85%AC%E5%85%B1%E5%AD%98%E5%82%A8%E5%BA%93%E7%9A%84-github-%E6%89%98%E7%AE%A1%E7%9A%84%E6%A0%87%E5%87%86%E8%BF%90%E8%A1%8C%E5%99%A8">这个</a></p><p><img src="https://static.wuhunyu.top/images/2024/06/9837089beacd6189d2b317f420bb9b8e.png" alt="image-20240630221848905"></p><h4 id="引用资源"><a href="#引用资源" class="headerlink" title="引用资源"></a>引用资源</h4><blockquote><p><a href="https://docs.github.com/zh/actions">GitHub Actions 文档</a></p><p><a href="https://docs.github.com/zh/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#%E7%94%A8%E4%BA%8E%E5%85%AC%E5%85%B1%E5%AD%98%E5%82%A8%E5%BA%93%E7%9A%84-github-%E6%89%98%E7%AE%A1%E7%9A%84%E6%A0%87%E5%87%86%E8%BF%90%E8%A1%8C%E5%99%A8">用于公共存储库的 GitHub 托管的标准运行器</a></p><p><a href="https://github.com/actions/checkout">checkout</a></p><p><a href="https://github.com/peaceiris/actions-gh-pages">peaceiris&#x2F;actions-gh-pages</a></p><p><a href="https://github.com/marketplace?type=actions">GitHub 市场</a></p><p><a href="https://github.com/wuhunyu/docker-hub">docker-hub</a></p><p><a href="https://github.com/tech-shrimp/docker_image_pusher">docker_image_pusher</a></p><p><a href="https://github.com/wuhunyu/starter">starter</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;GitHub-Actions-是什么&quot;&gt;&lt;a href=&quot;#GitHub-Actions-是什么&quot; class=&quot;headerlink&quot; title=&quot;GitHub Actions 是什么&quot;&gt;&lt;/a&gt;GitHub Actions 是什么&lt;/h4&gt;&lt;h5 id=&quot;官方文档-是这么介绍的&quot;&gt;&lt;a href=&quot;#官方文档-是这么介绍的&quot; class=&quot;headerlink&quot; title=&quot;官方文档 是这么介绍的&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://docs.github.com/zh/actions&quot;&gt;官方文档&lt;/a&gt; 是这么介绍的&lt;/h5&gt;&lt;blockquote&gt;
&lt;p&gt;在 GitHub Actions 的仓库中自动化、自定义和执行软件开发工作流程。 您可以发现、创建和共享操作以执行您喜欢的任何作业（包括 CI&amp;#x2F;CD），并将操作合并到完全自定义的工作流程中。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5 id=&quot;我的理解&quot;&gt;&lt;a href=&quot;#我的理解&quot; class=&quot;headerlink&quot; title=&quot;我的理解&quot;&gt;&lt;/a&gt;我的理解&lt;/h5&gt;&lt;p&gt;可以理解为一个有条件（比如push事件，也可以是 cron 表达式定义的一个定时任务）触发的工作流任务。而这个工作流任务是可以由我们开发者自定义的，执行这些任务的环境由 GitHub 提供，一般是 ubuntu 环境。通过这个环境，我们可以执行一些自定义脚本，亦或是调用其他开发者发布的插件来实现一些开发者想要的功能&lt;/p&gt;</summary>
    
    
    
    <category term="GitHub Actions" scheme="https://wuhunyu.top/categories/GitHub-Actions/"/>
    
    
    <category term="GitHub Actions" scheme="https://wuhunyu.top/tags/GitHub-Actions/"/>
    
  </entry>
  
  <entry>
    <title>JetBrains 全家桶破解</title>
    <link href="https://wuhunyu.top/tools/jetbrains-active/index.html"/>
    <id>https://wuhunyu.top/tools/jetbrains-active/index.html</id>
    <published>2024-04-06T04:52:00.000Z</published>
    <updated>2026-01-07T07:38:46.863Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="前排说明"><a href="#前排说明" class="headerlink" title="前排说明"></a>前排说明</h4><ol><li>破解原理基于 Gitee 上的一个开源插件 <a href="https://gitee.com/ja-netfilter/ja-netfilter">ja-netfilter</a>，博主写这篇文章的目的并非倡导破解，该插件博主并未参与开发，仅仅作为一个使用者</li><li>截止到 2024年04月06日，博主目前使用的版本如下，实测有效可用，但并非是最新版本，至于其他版本是否支持，博主并未测试</li></ol><table><thead><tr><th>ide</th><th>使用版本</th></tr></thead><tbody><tr><td>IntelliJ IDEA</td><td>2023.3.6</td></tr><tr><td>WebStorm</td><td>2023.2.6</td></tr><tr><td>GoLand</td><td>2023.2.6</td></tr><tr><td>DataGrip</td><td>2023.2.3</td></tr></tbody></table><ol start="3"><li>破解需要 <a href="https://gitee.com/ja-netfilter/ja-netfilter">ja-netfilter</a> 插件，以及<strong>当前还可用的激活码</strong>(需要激活第一次，以后便不需要了)</li><li>插件作者的使用教程可以参考<a href="https://zhile.io/2021/11/29/ja-netfilter-javaagent-lib.html">这篇文章</a>，本篇文章是基于插件作者的文章以及实际安装过程写给博主自己用的</li><li>文中仅仅介绍如何破解 JetBrains 家族的软件</li><li>演示环境基于博主的 MacOS</li></ol><span id="more"></span><h4 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h4><ol><li>下载破解插件 <a href="https://gitee.com/ja-netfilter/ja-netfilter/releases/download/2022.2.0/ja-netfilter-2022.2.0.zip">ja-netfilter</a>，文件的名称是 <strong>ja-netfilter-2022.2.0.zip</strong></li><li>解压后的文件结构如下，<strong>ja-netfilter.jar</strong>所在的磁盘路径需要记下来（比如在我的电脑上是 <code>/Users/wuhunyu/plugins/ja-netfilter/ja-netfilter.jar</code>）</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.pdf</span><br><span class="line">├── config</span><br><span class="line">│   ├── dns.conf</span><br><span class="line">│   ├── native.conf</span><br><span class="line">│   ├── power.conf</span><br><span class="line">│   └── url.conf</span><br><span class="line">├── ja-netfilter.jar</span><br><span class="line">├── plugins</span><br><span class="line">│   ├── dns.jar</span><br><span class="line">│   ├── hideme.jar</span><br><span class="line">│   ├── native.jar</span><br><span class="line">│   ├── power.jar</span><br><span class="line">│   └── url.jar</span><br><span class="line">└── sha1sum.txt</span><br></pre></td></tr></table></figure><ol start="3"><li>修改 <code>config/dns.conf</code> 配置文件，替换成以下内容即可</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[DNS]</span><br><span class="line">EQUAL,jetbrains.com</span><br></pre></td></tr></table></figure><ol start="4"><li>修改 <code>config/url.conf</code> 配置文件，替换成以下内容即可</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[URL]</span><br><span class="line">PREFIX,https://account.jetbrains.com/lservice/rpc/validateKey.action</span><br></pre></td></tr></table></figure><ol start="5"><li>修改 JetBrains 各个 ide 的配置文件，配置文件的后缀都是 <code>.vmoptions</code></li></ol><table><thead><tr><th>ide</th><th>对应的 vmoptions 配置文件名称</th><th>可能存在的路径</th></tr></thead><tbody><tr><td>IntelliJ IDEA</td><td>idea.vmoptions</td><td>&#x2F;Users&#x2F;[用户名]&#x2F;Library&#x2F;Application Support&#x2F;JetBrains&#x2F;IntelliJIdea[具体版本号]&#x2F;idea.vmoptions</td></tr><tr><td>WebStorm</td><td>webstorm.vmoptions</td><td>&#x2F;Users&#x2F;[用户名]&#x2F;Library&#x2F;Application Support&#x2F;JetBrains&#x2F;WebStorm[具体版本号]&#x2F;webstorm.vmoptions</td></tr><tr><td>GoLand</td><td>goland.vmoptions</td><td>&#x2F;Users&#x2F;[用户名]&#x2F;Library&#x2F;Application Support&#x2F;JetBrains&#x2F;GoLand[具体版本号]&#x2F;goland.vmoptions</td></tr><tr><td>DataGrip</td><td>datagrip.vmoptions</td><td>&#x2F;Users&#x2F;[用户名]&#x2F;Library&#x2F;Application Support&#x2F;JetBrains&#x2F;DataGrip[具体版本号]&#x2F;datagrip.vmoptions</td></tr></tbody></table><blockquote><p>其他方式：又或者此刻你还能打开 ide 正常使用，通过在 ide 中找到 <code>Help -&gt; Edit Custom VM Options</code> 也能在 ide 中打开此配置文件</p></blockquote><ol start="6"><li>在 <code>.vmoptions</code> 中加入以下配置</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 激活</span><br><span class="line">-javaagent:[ja-netfilter.jar 所在的绝对路径]</span><br><span class="line">--add-opens=java.base/jdk.internal.org.objectweb.asm=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/jdk.internal.org.objectweb.asm.tree=ALL-UNNAMED</span><br></pre></td></tr></table></figure><p>以我的电脑上<strong>ja-netfilter.jar 所在的绝对路径</strong>是 <code>/Users/wuhunyu/plugins/ja-netfilter/ja-netfilter.jar</code> 为例，最后需要添加的配置如下</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 激活</span><br><span class="line">-javaagent:/Users/wuhunyu/plugins/ja-netfilter/ja-netfilter.jar</span><br><span class="line">--add-opens=java.base/jdk.internal.org.objectweb.asm=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/jdk.internal.org.objectweb.asm.tree=ALL-UNNAMED</span><br></pre></td></tr></table></figure><ol start="7"><li>启动 ide，输入 <code>Activation code</code> 激活，后续即便现在所使用的激活码失效，也不需要再次激活</li></ol><blockquote><p>关于激活码，ja-netfilter 插件作者的文章中提到了<a href="https://3.jetbra.in/">热心大佬的key</a>。博主自己试过好几个倒是都无效</p><p>博主目前的解决方案是在taobao购买了一个激活码用于第一次激活</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;前排说明&quot;&gt;&lt;a href=&quot;#前排说明&quot; class=&quot;headerlink&quot; title=&quot;前排说明&quot;&gt;&lt;/a&gt;前排说明&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;破解原理基于 Gitee 上的一个开源插件 &lt;a href=&quot;https://gitee.com/ja-netfilter/ja-netfilter&quot;&gt;ja-netfilter&lt;/a&gt;，博主写这篇文章的目的并非倡导破解，该插件博主并未参与开发，仅仅作为一个使用者&lt;/li&gt;
&lt;li&gt;截止到 2024年04月06日，博主目前使用的版本如下，实测有效可用，但并非是最新版本，至于其他版本是否支持，博主并未测试&lt;/li&gt;
&lt;/ol&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ide&lt;/th&gt;
&lt;th&gt;使用版本&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;IntelliJ IDEA&lt;/td&gt;
&lt;td&gt;2023.3.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WebStorm&lt;/td&gt;
&lt;td&gt;2023.2.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;GoLand&lt;/td&gt;
&lt;td&gt;2023.2.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DataGrip&lt;/td&gt;
&lt;td&gt;2023.2.3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;破解需要 &lt;a href=&quot;https://gitee.com/ja-netfilter/ja-netfilter&quot;&gt;ja-netfilter&lt;/a&gt; 插件，以及&lt;strong&gt;当前还可用的激活码&lt;/strong&gt;(需要激活第一次，以后便不需要了)&lt;/li&gt;
&lt;li&gt;插件作者的使用教程可以参考&lt;a href=&quot;https://zhile.io/2021/11/29/ja-netfilter-javaagent-lib.html&quot;&gt;这篇文章&lt;/a&gt;，本篇文章是基于插件作者的文章以及实际安装过程写给博主自己用的&lt;/li&gt;
&lt;li&gt;文中仅仅介绍如何破解 JetBrains 家族的软件&lt;/li&gt;
&lt;li&gt;演示环境基于博主的 MacOS&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="破解" scheme="https://wuhunyu.top/categories/%E7%A0%B4%E8%A7%A3/"/>
    
    
    <category term="JetBrains 全家桶" scheme="https://wuhunyu.top/tags/JetBrains-%E5%85%A8%E5%AE%B6%E6%A1%B6/"/>
    
    <category term="IntelliJ IDEA" scheme="https://wuhunyu.top/tags/IntelliJ-IDEA/"/>
    
    <category term="WebStorm" scheme="https://wuhunyu.top/tags/WebStorm/"/>
    
    <category term="GoLand" scheme="https://wuhunyu.top/tags/GoLand/"/>
    
    <category term="DataGrip" scheme="https://wuhunyu.top/tags/DataGrip/"/>
    
  </entry>
  
  <entry>
    <title>面经 - 江西燃点</title>
    <link href="https://wuhunyu.top/mianjing/2024/03/jiang-xi-ran-dian/index.html"/>
    <id>https://wuhunyu.top/mianjing/2024/03/jiang-xi-ran-dian/index.html</id>
    <published>2024-03-19T12:27:00.000Z</published>
    <updated>2026-01-07T07:38:46.862Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="江西燃点-–-面经"><a href="#江西燃点-–-面经" class="headerlink" title="江西燃点 – 面经"></a>江西燃点 – 面经</h3><h4 id="情报"><a href="#情报" class="headerlink" title="情报"></a>情报</h4><p>面试是混面，技术面，主管面(一般针对个人经历，发展提问的面试我称之为主管面)</p><p>公司运营的项目目前趋于稳定，期望开发者拥有大数据方面的技能，可以给一定的时间给开发者来转这个方向</p><span id="more"></span><h4 id="技术面"><a href="#技术面" class="headerlink" title="技术面"></a>技术面</h4><h5 id="面试官问"><a href="#面试官问" class="headerlink" title="面试官问"></a>面试官问</h5><p>二分法适用的场景</p><p>分布式事务中，有八个 rpc 修改类接口需要同步调用，现在发现整个事务执行效率较低，该如何优化</p><p>spring 中的循环依赖是如何解决的</p><p>有没有在网关层做过鉴权</p><p>ThreadLocal 使用场景，以及可能遇到的问题</p><p>有没有做过 sql 调优类的实践工作</p><p>有没有做过数据权限，要怎么实现</p><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>面试结果在本周内会给回复</p><p>这算是第一个打开了我个人博客的面试官，虽然我的个人博客并没有很么干货，感动ing，呜呜呜～～</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;江西燃点-–-面经&quot;&gt;&lt;a href=&quot;#江西燃点-–-面经&quot; class=&quot;headerlink&quot; title=&quot;江西燃点 – 面经&quot;&gt;&lt;/a&gt;江西燃点 – 面经&lt;/h3&gt;&lt;h4 id=&quot;情报&quot;&gt;&lt;a href=&quot;#情报&quot; class=&quot;headerlink&quot; title=&quot;情报&quot;&gt;&lt;/a&gt;情报&lt;/h4&gt;&lt;p&gt;面试是混面，技术面，主管面(一般针对个人经历，发展提问的面试我称之为主管面)&lt;/p&gt;
&lt;p&gt;公司运营的项目目前趋于稳定，期望开发者拥有大数据方面的技能，可以给一定的时间给开发者来转这个方向&lt;/p&gt;</summary>
    
    
    
    <category term="面经" scheme="https://wuhunyu.top/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
    <category term="技术面" scheme="https://wuhunyu.top/tags/%E6%8A%80%E6%9C%AF%E9%9D%A2/"/>
    
    <category term="江西燃点" scheme="https://wuhunyu.top/tags/%E6%B1%9F%E8%A5%BF%E7%87%83%E7%82%B9/"/>
    
  </entry>
  
</feed>
